<? 
	include("../php_scripts/connect_database.php");
	include("../php_scripts/calendar_data.php");
    include("php_scripts/es_personal_work_time.php");
	include("php_scripts/load_per_control.php"); 
    $db_dpis_AB = new connect_dpis($dpisdb_host, $dpisdb_name, $dpisdb_user, $dpisdb_pwd);
    
    

?>
<html>
<head>
<title><?=$webpage_title;?> - <?=$MENU_TITLE_LV0;?><?if($MENU_ID_LV1){?> - <?=$MENU_TITLE_LV1;?><?}?><?if($MENU_ID_LV2){?> - <?=$MENU_TITLE_LV2;?><?}?><?if($MENU_ID_LV3){?> - <?=$MENU_TITLE_LV3;?><?}?></title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-874">
<link rel="stylesheet" href="<?=$cssfileselected;?>" type="text/css">
<link rel="alternate stylesheet" type="text/css" media="all" href="stylesheets/calendar-blue.css" title="winter"/>
</head>
<script type="text/javascript" src="java_scripts/chk_date.js"></script>
<script type="text/javascript" src="java_scripts/calendar.js"></script>
<script type="text/javascript" src="java_scripts/calendar-th.js"></script> 
<script type="text/javascript" src="java_scripts/function_utility.js"></script> 
<script language="JavaScript">
	function call_sort(flag) {
		form1.order_by.value=flag;		form1.sort_by.value=flag;
		if(form1.sort_type.value==flag+":asc"){
			form1.sort_type.value=flag+":desc";
		}else{ //desc
			form1.sort_type.value=flag+":asc";
		}		
		form1.submit();
	} // end function call_sort
	
	function call_rtf_pdf_report(report_type) {
		if(document.form1.HIDdata_count.value == 0 || document.form1.HIDdata_count.value == ''){ 
				alert('ไม่พบข้อมูล');
				return false();
		}else{
			var currDate = new Date();
			var rptDate = currDate.getFullYear().toString() + currDate.getMonth().toString() + currDate.getDate().toString(); 
				   rptDate += currDate.getHours().toString() + currDate.getMinutes().toString() + currDate.getSeconds().toString();
			var report_title = "P0121";
	
			//document.form1.target = "_blank";
			 if (report_type==1){
			document.form1.action = "report/rpt_es_personal_work_time.php?report_title=" + encodeURIComponent(report_title) + "&table=<?=$table;?>&UTC" + rptDate+"&FLAG_RTF=1";
			}else if (report_type==0){ 
			document.form1.action = "report/rpt_es_personal_work_time.php?report_title=" + encodeURIComponent(report_title) + "&table=<?=$table;?>&UTC" + rptDate+"&FLAG_RTF=0";
			}
			document.form1.submit();
			document.form1.target = "_self";
			document.form1.action = "es_personal_work_time.html";
	    }
	  
	}
	
	function call_export_file() {
		if(document.form1.HIDdata_count.value == 0 || document.form1.HIDdata_count.value == ''){ 
				alert('ไม่พบข้อมูล');
				return false();
		}else{
			var currDate = new Date();
			var rptDate = currDate.getFullYear().toString() + currDate.getMonth().toString() + currDate.getDate().toString(); 
				   rptDate += currDate.getHours().toString() + currDate.getMinutes().toString() + currDate.getSeconds().toString();
			var report_title = "P0121";
	
			document.form1.action = "report/rpt_es_personal_work_time_xls.php?report_title=" + encodeURIComponent(report_title) + "&table=<?=$table;?>&UTC" + rptDate;
			document.form1.submit();
			document.form1.target = "_self";
			document.form1.action = "es_personal_work_time.html";
		}
	}	
	
</script>
<span id="defaultTheme"></span>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="label_normal">
	<? if (!$HIDE_HEADER) { ?>
	<tr>
    	<td height="10"><? include("header_menu.html");?></td>
  	</tr>
	<? } ?>
    	<tr> 
	  <td align="left" valign="top">
<?	
		$OPTIONAL_TITLE="".(($HIDE_HEADER)?"ข้อมูลลงเวลาปฏิบัติราชการ":"") ;
		if ($UPD) $OPTIONAL_TITLE.=" &gt; แก้ไขข้อมูล"; elseif ($VIEW) $OPTIONAL_TITLE.=" &gt; ดูข้อมูล";
		$setPerStyle="display:none; visibility:hidden";
		if($UPD||$VIEW||($BKK_FLAG==1&&$ADD_NEXT==1)){ $setPerStyle="display:block; visibility:visible"; }
		include("current_location.html");
?>
	  </td>	</tr>
  	<tr>
    	<td align="left" valign="top"><form name="form1" method="post" action="es_personal_work_time.html" enctype="multipart/form-data">
          <input type="hidden" name="current_page" value="<?=$current_page;?>">
          <input type="hidden" name="total_page" value="<?=$total_page;?>">
		  <input type="hidden" name="MENU_ID_LV0" value="<?=$MENU_ID_LV0;?>">
		  <input type="hidden" name="MENU_ID_LV1" value="<?=$MENU_ID_LV1;?>">
		  <input type="hidden" name="MENU_ID_LV2" value="<?=$MENU_ID_LV2;?>">
		  <input type="hidden" name="MENU_ID_LV3" value="<?=$MENU_ID_LV3;?>">
          <input type="hidden" name="command" value="">
          <input type="hidden" name="PER_ID" value="<?=$PER_ID;?>">
          <input type="hidden" name="WT_ID" value="<?=$WT_ID;?>">
          <input type="hidden" name="HIDE_HEADER" value="<?=$HIDE_HEADER;?>">	 
          	
&nbsp;<table width="95%"  border="0" align="center" cellpadding="0" cellspacing="0" class="label_normal">
  <tr>
    <td align="center"><table width="100%"  border="0" cellpadding="0" cellspacing="0" class="label_normal">
      <tr>
        <td width="15%" height="22" align="right"><?=$FULLNAME_TITLE;?>&nbsp;:&nbsp;</td>
        <td width="21%" align="center"><input type="text" name="PER_NAME" value="<?=$PER_NAME;?>" style="width:98%" class="textbox" readonly></td>
        <td width="16%" height="22" align="right"><?=$CARDNO_TITLE;?>&nbsp;:&nbsp;</td>
        <td width="48%" colspan="2" align="left"><input type="text" name="PER_CARDNO" value="<?=$PER_CARDNO;?>" style="width:40%" class="textbox" readonly>	<? if (!$HIDE_HEADER) { ?>
          &nbsp;<? if ($BUTTON_DISPLAY==1) { ?><input name="BackBtn" type="button" class="button" value="<?=$SELECT_PERSON_TITLE;?>" onClick="javascript:window.location='personal_master.html?MENU_ID_LV0=<?=$MENU_ID_LV0;?>&MENU_ID_LV1=<?=$MENU_ID_LV1;?>&MENU_ID_LV2=<?=$MENU_ID_LV2;?>&MENU_ID_LV3=<?=$MENU_ID_LV3;?>&SEARCHHIS=personal_work_time'"><!--history.back(); -->
          <?  } else {  echo "&nbsp; &nbsp;";?>
  <img src="images/select_person.png" alt="<?=$SELECT_PERSON_TITLE;?>" width="32" height="32" border="0" onClick="javascript:window.location='personal_master.html?MENU_ID_LV0=<?=$MENU_ID_LV0;?>&MENU_ID_LV1=<?=$MENU_ID_LV1;?>&MENU_ID_LV2=<?=$MENU_ID_LV2;?>&MENU_ID_LV3=<?=$MENU_ID_LV3;?>&SEARCHHIS=personal_work_time'">
  <? } echo "&nbsp; &nbsp;";?><? } ?></td>
        </tr>
			   
    </table>
    &nbsp;
    <table width="100%" align="center" cellpadding="0" cellspacing="0">
  	<tr>
  	  <td width="22%"><table width="100%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
  	    <tr>
  	      <td height="22" align="center" class="table_body_3"><a href="#" style="text-decoration: none">ข้อมูลการลงเวลา</a></td>
	      </tr>
	    </table></td>
	  <td width="82%"><table width="32%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
		  <tr>
		  	<td height="22" align="center" class="table_body"><a href="es_personal_work_time_his.html?MENU_ID_LV0=<?=$MENU_ID_LV0;?>&MENU_ID_LV1=<?=$MENU_ID_LV1;?>&MENU_ID_LV2=<?=$MENU_ID_LV2;?>&PER_ID=<?=$PER_ID;?>&HIDE_HEADER=<?=$HIDE_HEADER;?>" style="text-decoration: none">ข้อมูลประวัติการลงเวลา</a></td>
		  </tr>		
	  </table></td>
	</tr>
  </table>
    
    <table id="id_work_time" width="100%" align="center" cellpadding="0" cellspacing="0" class="input_table" style="">
    <tr>
      <td>
    
    <table width="100%"  border="0" cellpadding="1" cellspacing="1" class="label_normal">
		
                <tr>
                  <td colspan="5" align="center">
                  
           <?
           
           
					$cmd = " select cl.WC_START,cl.WC_END,cl.ON_TIME,cyh.WC_CODE,
                            cl.END_LATETIME,cl.WC_NAME,cl.START_SCAN,
                            cl.WC_END,cl.MIN_ONTIME,
                            cl.END_LATETIME,
                            to_char(trunc(sysdate)+(to_number(substr(cl.ON_TIME,1,2))/24)
							+(to_number(substr(cl.ON_TIME,3,2))/1440)+(1/1440),'HH24:MI') XTIME,
                            cl.END_SCAN,
                           to_char(trunc(sysdate)+(to_number(substr(WC_START,1,2))/24)
						+(to_number(substr(WC_START,3,2))/1440)+(10/24),'HH24:MI') WC_END2,
                        	cl.TIME_LEAVEEARLY,cl.NEXTDAY_LEAVEEARLY,cl.TIME_LEAVEAFTER,
                            cl.NEXTDAY_LEAVEAFTER
                            FROM  PER_WORK_CYCLEHIS cyh
                            left join PER_WORK_CYCLE cl on(cl.WC_CODE=cyh.WC_CODE) 
                            WHERE cyh.PER_ID =$PER_ID 
                            AND 
                            (sysdate between to_date(cyh.START_DATE,'yyyy-mm-dd hh24:mi:ss') AND case 
							when cyh.END_DATE is not null then to_date(cyh.END_DATE,'yyyy-mm-dd hh24:mi:ss') 
                            else sysdate end ) ";
                   
  				$db_dpis4->send_cmd($cmd);
               
				$data_cyh = $db_dpis4->get_array_array();
                
                if($data_cyh > 0){
               		
                    $WC_START_now=substr($data_cyh[WC_START],0,2).":".substr($data_cyh[WC_START],2,2)." น.";
                    if($data_cyh[END_SCAN]){
                    	$xEND_SCAN= substr($data_cyh[END_SCAN],0,2).":".substr($data_cyh[END_SCAN],2,2);
                    
                    }else{
                    	$xEND_SCAN= "23:59";
                    }
                    
                    $WC_NAME_now=$data_cyh[WC_NAME];
                    $WC_CODE_now=$data_cyh[WC_CODE];
                    
                    
                    if($WC_CODE_now!=-1){
                        if($data_cyh[WC_END]){
                            $WC_END_now=substr($data_cyh[WC_END],0,2).":".substr($data_cyh[WC_END],2,2)." - ".$xEND_SCAN." น.";
                        
                       }else{
                            $WC_END_now=$data_cyh[WC_END2]." - ".$xEND_SCAN." น.";
    
                        }
                    }else{
                    	if(!$data_cyh[WC_END]){
                        	if($data_cyh[TIME_LEAVEEARLY]!='0000' || $data_cyh[TIME_LEAVEAFTER]!='0000'){
                        		//$WC_END_now="ระบบนับชั่วโมงทำงาน (เต็มวัน 8 ชม.)";
                                $WC_END_now="ระบบนับชั่วโมงทำงาน [เต็มวัน 8 ชม.(รวมเวลาพักกลางวัน) ครึ่งวัน 3.5 ชม.]";
                                 
                            }else{
                            	//$WC_END_now="ระบบนับชั่วโมงทำงาน (เต็มวัน 8 ชม. ครึ่งวัน  4 ชม.)";
                                $WC_END_now="ระบบนับชั่วโมงทำงาน [เต็มวัน 8 ชม.(รวมเวลาพักกลางวัน) ครึ่งวัน 3.5 ชม.]";
                            }
                        }else{
                        	$WC_END_now=substr($data_cyh[WC_END],0,2).":".substr($data_cyh[WC_END],2,2)." - ".$xEND_SCAN." น.";
                        
                        }
                    
                    }
                    
                    
                    $END_LATETIME_now="-";
                    if($data_cyh[END_LATETIME]){
                            $END_LATETIME_now=substr($data_cyh[END_LATETIME],0,2).":".substr($data_cyh[END_LATETIME],2,2)." น.";
                    }
                    
                    $ON_TIME_now="-";
                    if($data_cyh[ON_TIME]){
                            $ON_TIME_now=substr($data_cyh[ON_TIME],0,2).":".substr($data_cyh[ON_TIME],2,2)." น.";
                   }
                   
                   $cmd = " select distinct WL_CODE 
                    from PER_TIME_ATTENDANCE att 
                    left join PER_TIME_ATT tat on(tat.TA_CODE=att.TA_CODE)
                    WHERE att.PER_ID =$PER_ID 
                    AND TO_CHAR(att.TIME_STAMP,'yyyy-mm-dd')='".date("Y-m-d")."'";
                    $db_dpis4->send_cmd_fast($cmd);
					$data_attto = $db_dpis4->get_array_array();
                   
    
                    $cmd = " SELECT LATE_TIME ,to_char(trunc(sysdate)+(to_number(substr(LATE_TIME,1,2))/24)
									+(to_number(substr(LATE_TIME,3,2))/1440)+(1/1440),'HH24:MI') XTIME
                     				FROM PER_WORK_LATE  where WORK_DATE = '".date("Y-m-d")."' AND WC_CODE='".$data_cyh[WC_CODE]."' AND WL_CODE='".$data_attto[WL_CODE]."'";
                    $db_dpis4->send_cmd_fast($cmd);
                    $datalate = $db_dpis4->get_array_array();
                    
                    $TIME_nowSecial="-";
                    if($datalate[LATE_TIME]){
                        $TIME_nowSecial=substr($datalate[LATE_TIME],0,2).":".substr($datalate[LATE_TIME],2,2)." น.";
                    }
                    
                    
                    
                    $NEXTDAY_LEAVEEARLY_now="";
                    if($data_cyh[NEXTDAY_LEAVEEARLY]==1){
                    	$NEXTDAY_LEAVEEARLY_now=" ของวันถัดไป";
                    }
                    
                    if($WC_CODE_now!=-1){
                    	if($data_cyh[TIME_LEAVEEARLY]!='0000'){
                    		$TIME_LEAVEEARLY_now=substr($data_cyh[TIME_LEAVEEARLY],0,2).":".substr($data_cyh[TIME_LEAVEEARLY],-2)." น.".$NEXTDAY_LEAVEEARLY_now;
                    	}else{
                        	$TIME_LEAVEEARLY_now="-";
                        }
                    }else{
                    	if($data_cyh[TIME_LEAVEEARLY]!='0000'){
                    		$TIME_LEAVEEARLY_now=substr($data_cyh[TIME_LEAVEEARLY],0,2).":".substr($data_cyh[TIME_LEAVEEARLY],-2)." น.";
                    	}else{
                        	$TIME_LEAVEEARLY_now="-";
                        }
                    }
                    
                    $NEXTDAY_LEAVEAFTER_now="";
                    if($data_cyh[NEXTDAY_LEAVEAFTER]==1){
                    	$NEXTDAY_LEAVEAFTER_now=" ของวันถัดไป";
                    }
                    
                    $TIME_LEAVEAFTER_now= "-";
                    if($data_cyh[TIME_LEAVEAFTER]!='0000'){
                    	$TIME_LEAVEAFTER_now=substr($data_cyh[TIME_LEAVEAFTER],0,2).":".substr($data_cyh[TIME_LEAVEAFTER],-2)." น. เป็นต้นไป".$NEXTDAY_LEAVEAFTER_now;
                    }
                    
                    
                    
                    
                    if($data_cyh[START_SCAN]){
                    	$START_SCAN_now=substr($data_cyh[START_SCAN],0,2).":".substr($data_cyh[START_SCAN],2,2) ." - ".substr($data_cyh[ON_TIME],0,2).":".substr($data_cyh[ON_TIME],2,2) ." 	น.";
                    }else{
                    	$START_SCAN_now=substr($data_cyh[WC_START],0,2).":".substr($data_cyh[WC_START],2,2) ." - ".substr($data_cyh[ON_TIME],0,2).":".substr($data_cyh[ON_TIME],2,2) ." 	น.";
                    }
                   if($datalate[XTIME]){
                   		$XTIME = $datalate[XTIME];
                   }else{
                    	$XTIME = $data_cyh[XTIME];
                   }
                   
                   
                   
                   $CHK_XTIME=substr($XTIME,0,2).substr($XTIME,-2);
                   $CHK_END_LATETIME=$data_cyh[END_LATETIME];
                   
                    
                    
                
                

?> 
                  
          <table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
        	
        	<tr>
                 <td width="21%"  align="right">รอบการลงเวลาปัจจุบัน&nbsp;:&nbsp;</td>
                 <td width="28%" >&nbsp;<?=$WC_NAME_now;?></td>
                 <td width="16%"  align="right">&nbsp;เวลาเพิ่มพิเศษวันนี้&nbsp;:&nbsp;</td>
                 <td width="35%"  >&nbsp;<font color='green'><?=$TIME_nowSecial;?></font>
                 
                 </td>
               </tr>
               <tr>
        	  <td align="right" ><? if($WC_CODE_now==-1){ echo 'เริ่มนับชั่วโมงตั้งแต่เวลา';}else{ echo 'ลงเวลาได้ตั้งแต่';}?>&nbsp;:&nbsp;</td>
        	  <td >&nbsp;<?=$START_SCAN_now;?></td>
        	  <td  align="right">ลงเวลาตั้งแต่&nbsp;:&nbsp;</td>
        	  <td  >&nbsp; <? if($CHK_XTIME < $CHK_END_LATETIME){ ?>
              		<?=$XTIME;?> - <?=$END_LATETIME_now;?>
              		<font color='red'>ถือว่ามาสาย</font>
                 <?}else{ ?>
                 		- <font color='red'>ไม่มีเวลาสาย</font>
                 <? }?>
              
              </td>
      	  </tr>
               <tr>
               <td align="right" >ลงเวลาหลังจาก&nbsp;:&nbsp;</td>
        	  <td >&nbsp;<?=$END_LATETIME_now;?>
              หากไม่ทำการลาจะถือว่า<font color='red'>ขาดราชการ</font>
              </td>
        	  <td align="right" >สแกนออกได้ตั้งแต่&nbsp;:&nbsp;</td>
        	  <td>&nbsp;<?=$WC_END_now;?></td>
        	  </tr>
               <tr >
                 <td align="right" valign="top">กรณีลาครึ่งวันแรก&nbsp;&nbsp; <br>ลงเวลาเข้างานได้ไม่เกิน&nbsp;:&nbsp;</td>
                 <td valign="bottom">&nbsp;<?=$TIME_LEAVEEARLY_now;?></td>
                 <td align="right" valign="top">กรณีลาครึ่งวันหลัง&nbsp;&nbsp; <br>ลงเวลาออกได้หลังเวลา&nbsp;:&nbsp;</td>
                 <td valign="bottom">&nbsp;<?=$TIME_LEAVEAFTER_now;?></td>
               </tr>
               <tr>
                 <td align="right" >รูปแบบการลงเวลา&nbsp;:&nbsp;</td>
                 <td >&nbsp;
                 <? 	
                  if($WC_CODE_now!=-1){
                 		$cmdTYPE = " SELECT CONFIG_VALUE FROM SYSTEM_CONFIG  where config_name = 'P_SCANTYPE' ";
                        $db_dpis->send_cmd_fast($cmdTYPE);
                        $dataTYPE = $db_dpis->get_array_array();
                        if($dataTYPE[CONFIG_VALUE]=='1'){
                        	echo "ลงเวลามาและลงเวลากลับ";
                        }else{
                        	echo "ลงเวลามา เวลากลับระบบลงให้อัตโนมัติ";
                        }
                   }else{
                   		echo "<font color='red'>ต้องลงเวลามาและลงเวลากลับ</font>";
                   
                   }
                   ?>
                 </td>
                 <td align="right" >ชดเชยเวลาปฏิบัติงาน&nbsp;:&nbsp;</td>

                 <td><? 	
                 		$cmd = " SELECT CONFIG_VALUE FROM SYSTEM_CONFIG  where config_name = 'P_EXPIATE' ";
						$db_dpis->send_cmd($cmd);
                        $dataTYPE = $db_dpis->get_array_array();
                        if($dataTYPE[CONFIG_VALUE]=='N'){
                        	echo "ไม่ต้องชดเชยเวลา";
                        }else{
                        	echo "ชดเชยเวลา";
                        }

                   ?></td>
               </tr>
             </table> 
             
             <? }else{?>  
             
             <table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
        	
        	<tr>
        	  <td align="center" ><font color='red'>ยังไม่ได้กำหนดรอบ</font></td>
        	  </tr>
             </table>
             
             <? }?>      
                  
                  
                  
                
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
     
     <tr height="22" class="table_body_3">
       <td align="center">ข้อมูลจากเครื่องบันทึกเวลา (ข้อมูลวันนี้)</td>
     </tr>
     
     </table>
    <table width="100%" border="0" align="center" cellpadding="1" cellspacing="1">
    <tr align="center" class="table_head">
	  <td width="9%" height="25" ><?=$SEQ_NO_TITLE;?></td>
	  <td width="24%" >วัน-เวลาที่สแกน</td>
	  <td width="22%">เครื่องบันทึกเวลา</td>
	  <td width="25%">รอบเวลา</td>
      <td width="20%">เวลาออก</td>
      
      </tr>
      
      <?
					$cmd = " select TO_CHAR(att.TIME_STAMP,'yyyy-mm-dd') AS TIME_STAMP,
    				TO_CHAR(att.time_stamp,'HH24:MI:SS') AS TIME_STAMP_VELA,
                    att.PER_ID,b.TA_NAME,cl.WC_NAME,att.TIME_ADJUST,cl.WC_END,cyh.WC_CODE,cl.WC_START,
                    cl.TIME_LEAVEEARLY,
                    (select TO_CHAR(max(TIME_STAMP),'HH24MI') from PER_TIME_ATTENDANCE where PER_ID =$PER_ID and TO_CHAR(TIME_STAMP,'yyyy-mm-dd')='".date("Y-m-d")."'  and TO_CHAR(TIME_STAMP,'HH24MI') <=cl.END_LATETIME  ) as MINSTART
                    from PER_TIME_ATTENDANCE att 
                    left join PER_TIME_ATT b on(b.TA_CODE=att.TA_CODE)
                    left join PER_WORK_CYCLEHIS cyh on(cyh.PER_ID=att.PER_ID   
                    		AND (att.TIME_STAMP
                            between to_date(cyh.START_DATE,'yyyy-mm-dd hh24:mi:ss')  
                              AND case when cyh.END_DATE is not null then to_date(cyh.END_DATE,'yyyy-mm-dd hh24:mi:ss') 
                            else sysdate end ))
                    left join PER_WORK_CYCLE cl on(cl.WC_CODE=cyh.WC_CODE) 
                    WHERE att.PER_ID =$PER_ID 
                    AND TO_CHAR(att.TIME_STAMP,'yyyy-mm-dd')='".date("Y-m-d")."' 
                    
                    ORDER BY att.TIME_STAMP DESC
                    ";
                   
                    //AND TO_CHAR(att.TIME_STAMP,'yyyy-mm-dd')='".date("Y-m-d")."' 
                    
  	$count_page_att = $db_dpis3->send_cmd($cmd);

	$data_count_att=0;
	while ($data_att = $db_dpis3->get_array_array()) {
		$data_count_att++;
        $TIME_STAMP_STR  = show_date_format($data_att[TIME_STAMP], $DATE_DISPLAY);
        $time_stamp_vela  = $data_att[TIME_STAMP_VELA];
        $DATA_TA_NAME  = $data_att[TA_NAME];
        $DATA_WC_NAME_ATT  = $data_att[WC_NAME];
        
        $DATA_TIME_ADJUST = "";
        if($data_att[TIME_ADJUST]){
        	$DATA_TIME_ADJUST = substr($data_att[TIME_ADJUST],0,2).":".substr($data_att[TIME_ADJUST],2,2)." น.";
        }
        
         $WC_END_SCANOUT = "";
        if($data_att[WC_CODE] !="-1"){ 
        		$WC_END_SCANOUT = substr($data_att[WC_END],0,2).":".substr($data_att[WC_END],2,2)." น.";
        }else{
        		if($data_att[MINSTART]<= $data_att[WC_START]){
                	$tmpVchk=$data_att[WC_START];
                }else{
                	$tmpVchk=$data_att[MINSTART];
                }
                
                //$tmpVchk="1203";
                $tmpVchk_Sum = "";
                if($tmpVchk < "1200" ){
                	$newtimestampBgn = strtotime(date('Y-m-d').' '.substr($tmpVchk,0,2).':'.substr($tmpVchk,2,2).' + 480 minute'); 
                	$tmpVchk_Sum=date('H:i', $newtimestampBgn);
                }else if($tmpVchk >= "1200" && $tmpVchk <= $data_att[TIME_LEAVEEARLY]){
                	$newtimestampBgn = strtotime(date('Y-m-d').' '.substr($data_att[TIME_LEAVEEARLY],0,2).':'.substr($data_att[TIME_LEAVEEARLY],2,2).' + 210 minute'); 
                	$tmpVchk_Sum=date('H:i', $newtimestampBgn);
                }
                
            	$WC_END_SCANOUT = $tmpVchk_Sum;
        	
        }
        
		
?>
    
    <tr align="center" class="table_body" onMouseOver="this.className='table_body_over';" onMouseOut="this.className='table_body';">
      <td height="25"><?=$data_count_att;?></td>
      <td align=""><?=$TIME_STAMP_STR;?> เวลา <?=$time_stamp_vela;?></td>
      <td align="left">&nbsp;<?=$DATA_TA_NAME;?></td>
      <td align="left">&nbsp;<?=$DATA_WC_NAME_ATT;?></td>
      <td align="center"><?=$WC_END_SCANOUT;?></td>
      
      </tr>
    
    <? } ?>
  </table>
                  
                  
                  </td>
                </tr>
                <?
                	$cmd = " SELECT CONFIG_VALUE FROM SYSTEM_CONFIG  where config_name = 'P_NUMLATETIMES' ";
                    $db_dpis->send_cmd_fast($cmd);
                    $data = $db_dpis->get_array_array();
                    $TMP_P_NUMLATETIMES = $data[CONFIG_VALUE];
                    
                    $cmd = " SELECT CONFIG_VALUE FROM SYSTEM_CONFIG  where config_name = 'P_NUMLATEPER' ";
                    $db_dpis->send_cmd_fast($cmd);
                    $data = $db_dpis->get_array_array();
                    if($data[CONFIG_VALUE]==1){
                    	$TMP_P_NUMLATEPER = "ต่อปีงบประมาณ";
                    }else{
                    	$TMP_P_NUMLATEPER = "รอบการประเมิน";
                    }
                
                ?>
                <tr>
                  <td align="right">&nbsp;</td>
                  <td align="right">&nbsp;</td>
                  <td>&nbsp;</td>
                  <td align="right">&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                
                <tr>
                  <td width="20%">&nbsp;<font color='red'>*** เวลาออก เป็นเวลาที่สามารถสแกนออกได้</font></td>
                  <td width="15%" align="right">จำนวนครั้งที่สายได้&nbsp;:&nbsp;</td>
                  <td width="25%">&nbsp;<font color="red"><?=$TMP_P_NUMLATETIMES;?></font> ครั้ง/<?=$TMP_P_NUMLATEPER;?></td>
                  <td width="15%" align="right">คาดว่าสายในรอบเดือนนี้&nbsp;:&nbsp;</td>
                  <td width="25%">&nbsp;<font color="red"><span id="P_HIDLATE"></span></font> ครั้ง</td>
                </tr>
                 
					 			 			 
	</table>
    </td>
  </tr>
</table>
    
    
    
    
    
    </td>
  </tr>
</table>

  <table width="95%" border="0" align="center" cellpadding="0" cellspacing="0">
<tr><td><input type="hidden" name="order_by" value="<?=$order_by;?>">
    <input type="hidden" name="sort_by" value="<?=$sort_by;?>">
    <input type="hidden" name="sort_type" value="<?=$sort_type;?>">
<?=$SORT_TITLE;?></td>
</tr>
</table>

  
<?

	

		if(!$sort_by) $sort_by=1;
        if(!$sort_type) $sort_type="1:desc";
        $arrSort=explode(":",$sort_type);
        $SortType[$arrSort[0]]	=$arrSort[1];
        if(!$order_by) $order_by=1;
            
        if($order_by==1){	
        	
            $order_str = " ".$SortType[$order_by];
        }
            
/*
 kittiphat 25/08/2561
$cmd_min = "select  to_char(greatest(
		nvl((select trunc(min(TIME_STAMP),'MONTH') from PER_TIME_ATTENDANCE where per_id=$PER_ID), trunc(sysdate)-61),
		nvl((select last_day(to_date(to_char((close_year-543))||to_char(close_month,'00')||'01','YYYYMMDD'))+1 xx
			from (select * from(select close_year, close_month from per_work_time_control where  APPROVE_DATE is not null
            and DEPARTMENT_ID =(select ORG_ID from per_personal where per_id=$PER_ID)
      order by close_year desc , close_month desc) where rownum=1) x
    ), trunc(sysdate)-61)
),'yyyy-mm-dd hh24:mi:ss') y from dual" ; */  

$cmd_min = "select  to_char(greatest(
		nvl((select trunc(min(TIME_STAMP),'MONTH') from PER_TIME_ATTENDANCE where per_id=$PER_ID), nvl((select TO_DATE(min(substr(START_DATE,1,4)||''||substr(START_DATE,6,2)||''||substr(START_DATE,9,2)), 'YYYYMMDD') from PER_WORK_CYCLEHIS where per_id=$PER_ID), trunc(sysdate)-61)   ),
		nvl((select last_day(to_date(to_char((close_year-543))||to_char(close_month,'00')||'01','YYYYMMDD'))+1 xx
			from (select * from(select close_year, close_month from per_work_time_control where  APPROVE_DATE is not null
            and DEPARTMENT_ID =(select ORG_ID from per_personal where per_id=$PER_ID)
      order by close_year desc , close_month desc) where rownum=1) x
    ), nvl((select TO_DATE(min(substr(START_DATE,1,4)||''||substr(START_DATE,6,2)||''||substr(START_DATE,9,2)), 'YYYYMMDD') from PER_WORK_CYCLEHIS where per_id=$PER_ID), trunc(sysdate)-61))
),'yyyy-mm-dd hh24:mi:ss') y from dual" ;

            
$db_dpis->send_cmd_fast($cmd_min);
$data_min = $db_dpis->get_array_array();
$TIME_STAMP_min = $data_min[0];

$xx = $TIME_STAMP_min;
//$xx = "2017-07-01 23:59:59";
$yy = date("Y-m-d")." 23:59:59";
   //echo $xx ."||".$yy."||";
$cmd = file_get_contents('GetWorkTimeByPerID.sql');	

$cmd_con = " SELECT CONFIG_VALUE FROM SYSTEM_CONFIG  where config_name = 'P_SCANTYPE' ";
$db_dpis->send_cmd_fast($cmd_con);
$data_con = $db_dpis->get_array_array();
$SCANTYPE = $data_con[CONFIG_VALUE];
        
$cmd=str_ireplace(":PER_ID",$PER_ID,$cmd);
$cmd=str_ireplace(":BEGINDATEAT","'".$xx."'",$cmd);
$cmd=str_ireplace(":TODATEAT","'".$yy."'",$cmd);
$cmd=str_ireplace(":SCANTYPE",$SCANTYPE,$cmd);

$cmd=$cmd.$order_str;

//	OCIBindByName($db_dpis4->result,":PER_ID",$PER_ID);
//	OCIBindByName($db_dpis4->result,":BEGINDATEAT",$xx);
//    OCIBindByName($db_dpis4->result,":TODATEAT",$yy);
//    $count_page_data4 = OCIExecute($db_dpis4->result);

$count_page_data4=			$db_dpis4->send_cmd($cmd);
//echo "<pre>".$cmd; 
//die();
  	if ($count_page_data4) {
?>
	<table width="95%" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	  <td>
     
     <table width="100%" border="0" cellpadding="0" cellspacing="0" class="table_body_3">
            <tr>
              <td width="26%" height="22"><? if($PAGE_AUTH["print"]=="Y"){ ?>
                <? if ($BUTTON_DISPLAY==1) { ?>
                <input name="btn_report" type="button" class="button" style="width:150" value="<?=$PDF_TITLE;?>" onClick="call_rtf_pdf_report(0);"> 
				       <? if ($RTF_FLAG==1) { ?>
                <input name="btn21" type="button" class="button" style="width:150" value="<?=$RTF_TITLE;?>" onClick="call_rtf_pdf_report(1);"> 
	                    <? } ?>
                <?  } else { ?>
                <img src="images/doc_icon_pdf.jpg" border="0" alt="<?=$PDF_TITLE;?>" onClick="call_rtf_pdf_report(0);"> 
			        	 <? if ($RTF_FLAG==1) { ?>
                <img src="images/doc_icon_word.jpg" border="0" alt="<?=$RTF_TITLE;?>" onClick="call_rtf_pdf_report(1);"> 
	                     <? } ?>
                <? } ?>                <? }else{ echo "&nbsp;"; } ?></td>
              <td width="59%" align="center">พบข้อมูลประมวลผลการลงเวลาเบื้องต้น ทั้งสิ้น <span id="P_COUNT_R"></span> รายการ</td>
              <td width="15%" align="right"><? if($PAGE_AUTH["print"]=="Y"){ ?>
                <? if ($BUTTON_DISPLAY==1) { ?>
                <input name="btn_export" type="button" class="button" style="width:130" value="<?=$EXCEL_TITLE;?>" onClick="call_export_file();">
                <?  } else { ?>
                <img src="images/doc_icon_excel.jpg" border="0" alt="<?=$EXCEL_TITLE;?>" onClick="call_export_file();">
                <? } ?>                <? }else{ echo "&nbsp;"; } ?></td>
            </tr>
          </table>
     </td>
	</tr>
</table> 

  <table width="95%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
    <tr align="center" class="table_head">
	  <td width="5%" height="25"><strong><?=$SEQ_NO_TITLE;?></strong></td>
	  <td width="9%" onClick="call_sort(1);"><? if($order_by==1&&$sort_by==1){  if($SortType[$order_by]=="asc"){  echo $SORT_ASC;  }else{ echo $SORT_DESC; } }else{  echo $SORT_CUR;  } ?><strong>วันที่</strong></td>
	  <td width="8%">เวลาเข้า</td>
      <td width="8%" height="25">เวลาออก</td>
      <td width="12%">รอบเวลา</td>
      <td width="19%">สถานะการลงเวลา</td>
      <td width="19%">สถานะการลา</td>
      <td width="20%">สถานะวัน/คำร้อง</td>
      <!--<td width="16%">คำร้อง</td>-->
      </tr>
    <?
    
	$data_count  = 0;
    
	$HIDLATE1 = 0;
	while ($data4 = $db_dpis4->get_array_array()) {
		$data_count++;
        $DATA_WORK_DATE = show_date_format($data4[WORK_DATE], $DATE_DISPLAY);
        $DATA_ENTTIME = $data4[ENTTIME];
        $DATA_EXITTIME = $data4[EXITTIME];
        
        $cmd = " select WC_NAME FROM PER_WORK_CYCLE WHERE WC_CODE=".$data4[WC_CODE];       
        $db_dpis3->send_cmd_fast($cmd);
        $data_cy = $db_dpis3->get_array_array();
        $DATA_LATE_TIME = "";
        if($data4[LATE_TIME]){
        	$DATA_LATE_TIME = "+เวลาพิเศษ ".substr($data4[LATE_TIME],0,2).":".substr($data4[LATE_TIME],2,2);
        }
        $DATA_WC_NAME=$data_cy[WC_NAME].$DATA_LATE_TIME;
        
        $DATA_ABSENT = "";
        $ARR_ABSENT = explode(",", $data4[ABSENT]);
	
		$DATA_AB_NAME = "";
		$DATA_AB_NAME_AFTERNOON = '';
		
		if(substr($ARR_ABSENT[0],0,1)==1 || substr($ARR_ABSENT[0],0,1)==2 || substr($ARR_ABSENT[0],0,1)==3){
			if(substr($ARR_ABSENT[0],-2) != '10' && substr($ARR_ABSENT[0],-2) != '13'){
                $cmd_AB ="select AB_NAME
                from PER_ABSENTTYPE
                where AB_CODE = ".substr($ARR_ABSENT[0],-2);
                //echo $data_count."||".$cmd_AB."<br>";
                $db_dpis_AB->send_cmd($cmd_AB);
                $data_AB_NAME = $db_dpis_AB->get_array_array();
                $DATA_AB_NAME = $data_AB_NAME[AB_NAME];
             }
		}
		if(substr($ARR_ABSENT[1],0,1)==2){
        	if(substr($ARR_ABSENT[1],-2) != '10' && substr($ARR_ABSENT[1],-2) != '13'){
                $cmd_AB ="select AB_NAME
                from PER_ABSENTTYPE
                where AB_CODE = ".substr($ARR_ABSENT[1],-2);
                //echo $cmd_AB; die();
                $db_dpis_AB->send_cmd($cmd_AB);
                $data_AB_NAME = $db_dpis_AB->get_array_array();
                $DATA_AB_NAME_AFTERNOON = $data_AB_NAME[AB_NAME];
             }
		}
        
        $dbAbsent = "";
        if($data4[ABSENT] !='0,0'){
			if(substr($ARR_ABSENT[0],-2)==10 || substr($ARR_ABSENT[0],-2)==13){
                    $dbAbsent = $DATA_AB_NAME;
            }else{
                if(substr($ARR_ABSENT[0],0,1)==3){
                    $dbAbsent = $DATA_AB_NAME." (ทั้งวัน)";
                }elseif(substr($ARR_ABSENT[0],0,1)==1){
                    $dbAbsent = $DATA_AB_NAME." (ครึ่งเช้า)";
                    if(substr($ARR_ABSENT[1],0,1)==2){
                        if(substr($ARR_ABSENT[0],0,1)==1){
                            $dbAbsent .= ',';
                            $dbAbsent .= $DATA_AB_NAME_AFTERNOON." (ครึ่งบ่าย)";
                        }
                    }
                 }elseif(substr($ARR_ABSENT[0],0,1)==2){
                    $dbAbsent = $DATA_AB_NAME." (ครึ่งบ่าย)";
                }elseif(substr($ARR_ABSENT[0],0,1)==0){
					if(substr($ARR_ABSENT[1],0,1)==2){
						$dbAbsent .= $DATA_AB_NAME_AFTERNOON." (ครึ่งบ่าย)";
					}
				}
             }
		}
        
        $DATA_WORK_FLAG = "";
        if($data4[WORK_FLAG]==1){
        	if($data4[REMARK]){
            	$DATA_WORK_FLAG = "<font color='green'>".$data4[REMARK]."</font>";
            }else{
            	$DATA_WORK_FLAG = "<font color='red'>สาย</font>";
                $HIDLATE1++;
            }

            
        }else if($data4[WORK_FLAG]==2){
        
        	$cmd = " select cl.END_LATETIME
                            FROM  PER_WORK_CYCLEHIS cyh
                            left join PER_WORK_CYCLE cl on(cl.WC_CODE=cyh.WC_CODE) 
                            WHERE cyh.PER_ID =$PER_ID 
                            AND 
                            (sysdate between to_date(cyh.START_DATE,'yyyy-mm-dd hh24:mi:ss') AND case 
							when cyh.END_DATE is not null then to_date(cyh.END_DATE,'yyyy-mm-dd hh24:mi:ss') 
                            else sysdate end ) ";
            $db_dpis->send_cmd($cmd);
            $data_today = $db_dpis->get_array();
            $TODAY_END_LATETIME = trim($data_today[END_LATETIME]); // สิ้นสุดเวลาสาย
            
            if($TODAY_END_LATETIME){
        		$WORK_NOW = date("Y-m-d"); // วันที่ปัจจุบัน
                $TODAY_TIME_NOW = date("Hi"); // เวลาปัจจุบัน
                // 0 = ขาด, 2 = ลาบ่าย, 10= ลาเช้า, 12= ลาเช้าและลาบ่าย, 30 = ลาทั้งวัน
                if($data4[ABSENT] !="0,0" && $data4[ABSENT] != "313,0"){
                   if($WORK_NOW==$data4[WORK_DATE]){ 
                    	if($TODAY_TIME_NOW > $TODAY_END_LATETIME){   
                    		$DATA_WORK_FLAG = "<font color='red'>ขาดราชการ</font>";
                        }else{
                        	$DATA_WORK_FLAG = "";
                        }
                   }else{
                   		$DATA_WORK_FLAG = "<font color='red'>ขาดราชการ</font>";
                   }
                    
                }else{
                    if($WORK_NOW==$data4[WORK_DATE]){ 
                    	if($TODAY_TIME_NOW > $TODAY_END_LATETIME){   
                    		$DATA_WORK_FLAG = "<font color='red'>ขาดราชการ</font>";
                        }else{
                        	$DATA_WORK_FLAG = "";
                        }
                   }else{
                   		$DATA_WORK_FLAG = "<font color='red'>ขาดราชการ</font>";
                   }
                }
                
             }else{
             	$DATA_WORK_FLAG = "<font color='red'>ขาดราชการ</font>";
             }
            
        }else if($data4[WORK_FLAG]==3){
        	if($data4[REMARK]){
            	$DATA_WORK_FLAG = "<font color='green'>".$data4[REMARK]."</font>";
            }else{
            	$DATA_WORK_FLAG = "<font color='violet'>ออกก่อน</font>";
            }
        	
        	
        }else if($data4[WORK_FLAG]==4){
        	$WORK_NOW = date("Y-m-d");
        	if($data4[WC_CODE]=="-1" && $WORK_NOW==$data4[WORK_DATE]){ 
            	$DATA_WORK_FLAG = "";
            }else{
            	
                if($data4[REMARK]){
                    $DATA_WORK_FLAG = "<font color='green'>".$data4[REMARK]."</font>";
                }else{
                    $DATA_WORK_FLAG = "<font color='red'>ไม่ได้ลงเวลา</font>";
                }
            }
        	

        }else if($data4[WORK_FLAG]==0){
        	if($SCANTYPE=="2" && date("Y-m-d")==$data4[WORK_DATE]){ 
            	$DATA_EXITTIME = "";
            }
            $DATA_WORK_FLAG = "<font color='green'>ปกติ</font>";
        }else if($data4[WORK_FLAG]==5){
        	$DATA_WORK_FLAG = "<font color='green'>".$data4[REMARK]."</font>";
        }

        $DATA_HOLIDAY = "";
        if($data4[HOLIDAY]==1){
        	$DATA_HOLIDAY = "วันหยุด ";
        }
        
        
        /*คำร้อง*/
        
         $cmd ="select START_FLAG,START_TIME,END_FLAG,END_TIME,
                    MEETING_FLAG,SCAN_FLAG,OTH_FLAG,OTH_NOTE,
                    REQ_FLAG,REQ_TIME,REQUEST_NOTE,REQ_SPEC_NOTE,
                    REQ_SPEC
                    from TA_REQUESTTIME
                    where PER_ID = $PER_ID AND APPROVE_FLAG=1 AND REQUEST_DATE='".$data4[WORK_DATE]."'";
        $db_dpis_AB->send_cmd($cmd);
        $data_AB = $db_dpis_AB->get_array();
        $Detail_type = "";
        if($data_AB[START_FLAG]==1){
            $Detail_type = "ขอลงเวลาเข้า (".substr($data_AB[START_TIME],0,2).":".substr($data_AB[START_TIME],2,2)." น.) ";
        }
        
        $Detail_type1="";
        if($data_AB[END_FLAG]==1){
            $Detail_type1 = $Detail_type1."ขอลงเวลาออก (".substr($data_AB[END_TIME],0,2).":".substr($data_AB[END_TIME],2,2)." น.) ";
        } 
        
        $Detail_type11=""; 
       if($data_AB[MEETING_FLAG]==1){
            $Detail_type11 = $Detail_type11."ติดประชุม/สัมมนา/อบรม ";
        }
        
        if($data_AB[SCAN_FLAG]==1){
            $Detail_type11 = $Detail_type11."ลืมสแกน ";
        }
        
        if($data_AB[REQUEST_NOTE]==1){
            $Detail_type11 = $Detail_type11."ลาชั่วโมง ";
        }
        
        if($data_AB[REQ_TIME]==1){
            $Detail_type11 = $Detail_type11."ไปปฏิบัติราชการ ";
        }
        if($data_AB[REQ_SPEC]==1){
          $Detail_type11 = $Detail_type11." ".$data_AB[REQ_SPEC_NOTE]."";
        }
        if($data_AB[OTH_FLAG]==1){
            $Detail_type11 = $Detail_type11." ".$data_AB[OTH_NOTE]." ";
        
        }
            
        $Detail_type2="";
        
        
         /*เช็คพ้นจากราชการแล้วหรือยัง*/
        
       $cmd ="select PER_POSDATE
                    from PER_PERSONAL
                    where PER_ID = $PER_ID and PER_STATUS=2 ";
        $db_dpis_AB->send_cmd($cmd);
        $data_AB = $db_dpis_AB->get_array();
        
        if($data_AB[PER_POSDATE]){
        	 if(substr($data4[WORK_DATE],0,4).substr($data4[WORK_DATE],5,2).substr($data4[WORK_DATE],8,2) >= substr($data_AB[PER_POSDATE],0,4).substr($data_AB[PER_POSDATE],5,2).substr($data_AB[PER_POSDATE],8,2)){
        		$DATA_WORK_FLAG = "";
             }
        }



?>
    
            <tr align="center" class="table_body" onMouseOver="this.className='table_body_over';" onMouseOut="this.className='table_body';">
              <td height="25"><?=$data_count;?></td>
              <td align="center"><?=$DATA_WORK_DATE;?></td>
              <td align="center"><?=$DATA_ENTTIME;?></td>
              <td align="center"><?=$DATA_EXITTIME;?></td>
              <td align="left">&nbsp;<?=$DATA_WC_NAME;?></td>
              <td align="center"><?=$DATA_WORK_FLAG;?></td>
              <td><?=$dbAbsent;?></td>
              
              <td align="left">&nbsp;<?=$DATA_HOLIDAY.$Detail_type.$Detail_type1.$Detail_type11.$Detail_type2;;?></td>
             <!-- <td align="left">&nbsp;<?=$Detail_type.$Detail_type1.$Detail_type11.$Detail_type2;?></td>-->
              </tr>
            
             
    
    <? } ?>
  </table>
  

	
  <? } ?>
            <input type="hidden" name="HIDdata_count" value="<?=$data_count;?>">	
            <input type="hidden" name="HIDLATE1" value="<?=$HIDLATE1;?>">
  		  
        </form>	
		</td>
	</tr>
</table>
<?
	include("jqModalDialog.html");
?>
</body>
<? if (!$HIDE_HEADER) { ?>
<script language="JavaScript" src="java_scripts/menu_layer.js"></script>
<? } ?>
<script type="text/javascript">
document.getElementById('P_COUNT_R').innerHTML=form1.HIDdata_count.value;
document.getElementById('P_HIDLATE').innerHTML=parseInt(form1.HIDLATE1.value);
setActiveStyleSheet(document.getElementById("defaultTheme"), "winter");
</script>
</html>
