<? 
	if ($BYASS=="Y") $ORGTAB = "PER_ORG_ASS"; else $ORGTAB = "PER_ORG";

	if (!$KD_TYPE) $KD_TYPE = 1;	// ขั้นตอนที่ 1
	
//	echo "ORGTAB=$ORGTAB , KPI_YEAR=$KPI_YEAR , DEPARTMENT_ID=$DEPARTMENT_ID <br>";

	include("../php_scripts/connect_database.php");
	$arr_table_width = array("30","25","20","25");

// ทั้งสองค่าถูก move ใน kpi_distribute.php หลังจากเรียก load_per_control.php แล้ว
//	$log_org_id = $ORG_ID;	// ใช้ในกรณี log in ระดับ org_id เพราะ $ORG_ID จะถูกเปลี่ยนค่า เป็น $RUN_ORG_ID ใน kpi_distribute.php
//	$log_org_name = $ORG_NAME;	// เหมือนบรรทัดบน 

	include("php_scripts/kpi_distribute.php");
    
	// รวมไว้ที่เดียวเลย
	switch($CTRL_TYPE){
		case 2 :
			$search_pv_code = $PROVINCE_CODE;
			$search_pv_name = $PROVINCE_NAME;
			$PROVINCE_CODE = $PROVINCE_CODE;
			$PROVINCE_NAME = $PROVINCE_NAME;
			break;
		case 3 :
			$search_ministry_id = $MINISTRY_ID;
			$search_ministry_name = $MINISTRY_NAME;
			break;
		case 4 :
			$search_ministry_id = $MINISTRY_ID;
			$search_ministry_name = $MINISTRY_NAME;
			$search_department_id = $DEPARTMENT_ID;
			$search_department_name = $DEPARTMENT_NAME;
			break;
	} // end switch case
//	echo "CTRL_TYPE=$CTRL_TYPE , DEPARTMENT=($DEPARTMENT_ID,$DEPARTMENT_NAME) , search_org_id=($search_org_id,$search_org_name) , search_org_1=($search_org_id_1,$search_org_name_1)<br>";

	switch($SESS_USERGROUP_LEVEL){								
		case 2 :
			$search_pv_code = $PROVINCE_CODE;
			$search_pv_name = $PROVINCE_NAME;
			$PROVINCE_CODE = $PROVINCE_CODE;
			$PROVINCE_NAME = $PROVINCE_NAME;
			break;
		case 3 :
			$search_ministry_id = $MINISTRY_ID;
			$search_ministry_name = $MINISTRY_NAME;
			break;
		case 4 :
			$search_ministry_id = $MINISTRY_ID;
			$search_ministry_name = $MINISTRY_NAME;
			$search_department_id = $DEPARTMENT_ID;
			$search_department_name = $DEPARTMENT_NAME;
			break;
		case 5 :
			$search_ministry_id = $MINISTRY_ID;
			$search_ministry_name = $MINISTRY_NAME;
			$search_department_id = $DEPARTMENT_ID;
			$search_department_name = $DEPARTMENT_NAME;
			$search_org_id = $log_org_id;	//	$ORG_ID;
			$search_org_name = $log_org_name;	// $ORG_NAME;
			$search_org_id = $log_org_id;	//	$ORG_ID;
			$search_org_name = $log_org_name;	// $ORG_NAME;
			break;
		case 6 :
			$search_ministry_id = $MINISTRY_ID;
			$search_ministry_name = $MINISTRY_NAME;
			$search_department_id = $DEPARTMENT_ID;
			$search_department_name = $DEPARTMENT_NAME;
			$search_org_id = $log_org_id;	//	$ORG_ID;
			$search_org_name = $log_org_name;	// $ORG_NAME;
			$search_org_id_1 = $ORG_ID_1;
			$search_org_name_1 = $ORG_NAME_1;
			break;
	} // end switch case
//	echo "SESS_USERGROUP_LEVEL=$SESS_USERGROUP_LEVEL , DEPARTMENT=($DEPARTMENT_ID,$DEPARTMENT_NAME) , search_org_id=($search_org_id,$search_org_name) , search_org_1=($search_org_id_1,$search_org_name_1) , log_org_id=$log_org_id<br>";
?>
<html> 
<head>
<title><?=$webpage_title?> - <?=$MENU_TITLE_LV0?><?if($MENU_ID_LV1){?> - <?=$MENU_TITLE_LV1?><?}?><?if($MENU_ID_LV2){?> - <?=$MENU_TITLE_LV2?><?}?><?if($MENU_ID_LV3){?> - <?=$MENU_TITLE_LV3?><?}?></title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-874">
<link rel="stylesheet" href="<?=$cssfileselected?>" type="text/css">
<link rel="alternate stylesheet" type="text/css" media="all" href="stylesheets/calendar-blue.css" title="winter"/>
</head>
<script type="text/javascript" src="java_scripts/chk_date.js"></script>
<script type="text/javascript" src="java_scripts/calendar.js"></script>
<script type="text/javascript" src="java_scripts/calendar-th.js"></script> 
<script type="text/javascript" src="java_scripts/function_utility.js"></script> 
<script type="text/javascript" src="java_scripts/function_code_param.js"></script> 
<script type="text/javascript">
	function change_current_page( page ){
		var currpage = form1.current_page_lvl.value.split(",");
		var currpageidx = form1.current_page_idx.value;
		currpage[currpageidx] = page;
		form1.current_page_lvl.value = currpage.toString();
//		alert("page:"+form1.current_page.value+" = "+page+", "+form1.current_page_lvl.value+", idx="+currpageidx);
		form1.current_page.value = page;
		form1.submit();
	}
	
	function MM_openBrWindow(theURL,winName,features) { //v2.0
	  window.open(theURL,winName,features);
	}
	
	function call_more_editor (fieldname) {
		var getdate = new Date();
		MM_openBrWindow("maximize_editor.html?formname=form1&fieldname="+fieldname+"&gatedate="+getdate,'moreeditor','toolbar=no,location=no,status=yes,menubar=no,scrollbars=yes,resizable=yes,width=550,height=520')
	}
		
	function call_search_ministry () {	
		var PROVINCE_CODE = "<?=($CTRL_TYPE==2 || $SESS_USERGROUP_LEVEL==2)?"$PROVINCE_CODE":""?>";
		parameter = "&send_by=search_ministry&OL_CODE=01&PV_CODE=" + PROVINCE_CODE;
	    call_openDialog("search_org.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>" + parameter,800,600,"<?=$MINISTRY_TITLE?>");		
	}

	function call_search_department () {	
		var MINISTRY_ID = <?=(($CTRL_TYPE==3 || $SESS_USERGROUP_LEVEL==3)?"$MINISTRY_ID":"form1.MINISTRY_ID.value")?>;
		var PROVINCE_CODE = "<?=($CTRL_TYPE==2 || $SESS_USERGROUP_LEVEL==2)?"$PROVINCE_CODE":""?>";
		if(MINISTRY_ID != ""){
			parameter = "&send_by=search_department&OL_CODE=02&ORG_ID_REF=" + MINISTRY_ID + "&PV_CODE=" + PROVINCE_CODE;
		    call_openDialog("search_org.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>" + parameter,800,600,"<?=$DEPARTMENT_TITLE?>");		
		}else{
			<? if($CTRL_TYPE==3 || $SESS_USERGROUP_LEVEL==3){ ?>
			alert('<?=$MINISTRY_ALERT?> (กำหนดค่าเริ่มต้นหน่วยงาน)');
			<? }else{ ?>
			alert('<?=$MINISTRY_ALERT?>');
			form1.btn_ministry.focus();
			<? } ?>
		} // end if
	}

	function call_search_org_0 () {	
		var DEPARTMENT_ID = <?=(($CTRL_TYPE==4 || $SESS_USERGROUP_LEVEL==4)?"$DEPARTMENT_ID":"form1.DEPARTMENT_ID.value")?>;
		var PROVINCE_CODE = "<?=($CTRL_TYPE==2 || $SESS_USERGROUP_LEVEL==2)?"$PROVINCE_CODE":""?>";
		if(DEPARTMENT_ID != ""){
			if(form1.select_org_structure[0].checked) org_search_file ="search_org";
			else if(form1.select_org_structure[1].checked) org_search_file ="search_org_ass"; 
			parameter = "&send_by=search_org_0&OL_CODE=03&ORG_ID_REF=" + DEPARTMENT_ID + "&PV_CODE=" + PROVINCE_CODE;
		    call_openDialog("search_org.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>" + parameter,800,600,"<?=$ORG_TITLE?>");		
		}else{
			<? if($CTRL_TYPE==4 || $SESS_USERGROUP_LEVEL==4){ ?>
			alert('<?=$DEPARTMENT_ALERT?> (กำหนดค่าเริ่มต้นหน่วยงาน)');
			<? }else{ ?>
			alert('<?=$DEPARTMENT_ALERT?>');
			form0.btn_department.focus();
			<? } ?>
		} // end if
	}

	function call_search_org1 () {	
		var ORG_ID = form1.search_org_id.value;
		var PROVINCE_CODE = "<?=($CTRL_TYPE==2 || $SESS_USERGROUP_LEVEL==2)?"$PROVINCE_CODE":""?>";
		if(ORG_ID != ""){
			if(form1.select_org_structure[0].checked) org_search_file ="search_org";
			else if(form1.select_org_structure[1].checked) org_search_file ="search_org_ass"; 
			parameter = "&send_by=search_org1&OL_CODE=04&ORG_ID_REF=" + ORG_ID + "&PV_CODE=" + PROVINCE_CODE;
		    call_openDialog("search_org.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>" + parameter,800,600,"<?=$ORG_TITLE1?>");		
		}else{
			<? if($CTRL_TYPE==4 || $SESS_USERGROUP_LEVEL==4){ ?>
			alert('<?=$ORG_ALERT?> (กำหนดค่าเริ่มต้นหน่วยงาน)');
			<? }else{ ?>
			alert('<?=$ORG_ALERT?>');
			form0.btn_org_1.focus();
			<? } ?>
		} // end if
	}

	function add_opened_kpi(KPI_ID){		//???????????????เขียนเพิ่ม 5/9/2012 มันไม่มี function นี้อยู่ เลย error
		//alert(KPI_ID);
	}

	function checkupdate(f) {
		f.command.value = "SAVE";

		return true;
	}
	
	function select_head_org(org_id){
		form1.RUN_ORG_ID.value = org_id;
		form1.RUN_KPI_ID.value=''; 
		form1.OPEN_PER.value = "";
		form1.current_page.value=0;
		form1.total_page.value=0;
		form1.submit();
	}

	function select_org(org_id, kpi_id){
//		alert(org_id);
		form1.OPEN_PER.value = "";
		form1.RUN_ORG_ID.value = org_id;
		form1.RUN_KPI_ID.value = kpi_id;
		form1.submit();
	}

	function show_person(org_id, kpi_id){
//		alert(org_id);
		form1.ORG_OPEN_PER.value = org_id;
		if (form1.OPEN_PER.value=="OPEN_PER")
			form1.OPEN_PER.value = "";
		else
			form1.OPEN_PER.value = "OPEN_PER";
		form1.RUN_KPI_ID.value = kpi_id;
		form1.submit();
	}
	
	function call_pdf_file(r_title) {
		var currDate = new Date();
		var rptDate = currDate.getFullYear().toString() + currDate.getMonth().toString() + currDate.getDate().toString(); 
			   rptDate += currDate.getHours().toString() + currDate.getMinutes().toString() + currDate.getSeconds().toString();
		var report_title = "รายงานข้อมูล<?=($MENU_ID_LV3)?$MENU_TITLE_LV3:(($MENU_ID_LV2)?$MENU_TITLE_LV2:(($MENU_ID_LV1)?$MENU_TITLE_LV1:(($MENU_ID_LV0)?$MENU_TITLE_LV0:"")))?>"+(r_title ? " ตาม "+r_title : "");
		document.form1.target = "_blank";
		document.form1.action = "report/rpt_kpi_distribute4.php?report_title=" + report_title + "&table=<?=$table?>&form_part=<?=$form_part?>&UTC" + rptDate;
		document.form1.submit();
		document.form1.target = "_self";
		document.form1.action = "kpi_distribute.html";
	}
		
	function call_export_file(r_title) {
		var currDate = new Date();
		var rptDate = currDate.getFullYear().toString() + currDate.getMonth().toString() + currDate.getDate().toString(); 
			   rptDate += currDate.getHours().toString() + currDate.getMinutes().toString() + currDate.getSeconds().toString();
		var report_title = "รายงานข้อมูล<?=($MENU_ID_LV3)?$MENU_TITLE_LV3:(($MENU_ID_LV2)?$MENU_TITLE_LV2:(($MENU_ID_LV1)?$MENU_TITLE_LV1:(($MENU_ID_LV0)?$MENU_TITLE_LV0:"")))?>"+(r_title ? " ตาม "+r_title : "");
		document.form1.target = "_blank";
		document.form1.action = "report/rpt_kpi_distribute_xls.php?report_title=" + report_title + "&table=<?=$table?>&form_part=<?=$form_part?>&UTC" + rptDate;
		document.form1.submit();
		document.form1.target = "_self";
		document.form1.action = "kpi_distribute.html";
	}	
	
	function checkadd(f) {	
		//alert("add");
	<?
		for($i = 0; $i < count($col_entry_require); $i++) {
			if ($col_entry_require[$i]==1) {
				if ($i != $key_index || ($i == $key_index && !$f_autorun_index)) {
	?>
//					alert("<?=($i.'-fields ['.$i.']='.$arr_fields[$i].'=='.$col_label[$i]);?>");
					var obj = document.getElementsByName('<?=$arr_fields[$i]?>');
//					alert("aaaa"+obj);
					if (obj.length != 0) {
						if (obj[0].value=="") {
							alert("กรุณาระบุ <?=$col_label[$i]?>");
							obj[0].focus();
							return false;
						}
					} else {
//						alert("2....");
						var obj1 = document.getElementsByName('CHANGE_<?=$arr_fields[$i]?>');
						if (obj1.length != 0) {
//							alert("2.."+obj1[0].value);
							if (obj1[0].value=="") {
								alert("กรุณาระบุ <?=$col_label[$i]?>");
								obj1[0].focus();
								return false;
							}
						} else {
							alert("**** ตัวแปร Element ชื่อ <?=$arr_fields[$i]?> ไม่มีใน หน้านี้ โปรดติดต่อผู้พัฒนาโปรแกรมนี้...");
						}
					}
	<?
				}
			}
		}
	?>
		form1.command.value='ADD';
		return true;
	}
	
	function call_kd_flag(flag, kpi_id, org_id, per_id) {
			var remobj = document.getElementsByName("kd_remark_"+kpi_id+"_"+org_id+(per_id?"_"+per_id:""))[0];
//			alert("remark object  value="+remobj.value);
			if (flag=="SR") {
				remobj.disabled = false; 
			} else {
				remobj.disabled = true;
//				remobj.value = "";
			}
	}

	function returnFrom(src, returnValue){
//		alert("src="+src+"("+returnValue+")");
		 if  (src.indexOf("search_org") > -1) {
			if(returnValue){
				arrValue = returnValue.split("<::>");
				if (arrValue[7]=="search_ministry") {
					form1.MINISTRY_ID.value = arrValue[0];
					form1.MINISTRY_NAME.value = arrValue[1];
					form1.DEPARTMENT_ID.value = "";
					form1.DEPARTMENT_NAME.value = "";
					form1.search_org_id.value = "";
					form1.search_org_name.value = "";
					form1.search_org_id_1.value = "";
					form1.search_org_name_1.value = ""; 
				} else if (arrValue[7]=="search_department") {
					form1.DEPARTMENT_ID.value = arrValue[0];
					form1.DEPARTMENT_NAME.value = arrValue[1];
					form1.search_org_id.value = "";
					form1.search_org_name.value = "";
					form1.search_org_id_1.value = "";
					form1.search_org_name_1.value = ""; 
					form1.submit();
				} else if (arrValue[7]=="search_org_0") {
					form1.search_org_id.value = arrValue[0];
					form1.search_org_name.value = arrValue[1];
					form1.search_org_id_1.value = "";
					form1.search_org_name_1.value = ""; 
					form1.OPEN_PER.value = "";
					form1.RUN_ORG_ID.value = arrValue[0];
					form1.RUN_KPI_ID.value=''; 
					form1.submit();
				} else if (arrValue[7]=="search_org1") {
					form1.search_org_id_1.value = arrValue[0];
					form1.search_org_name_1.value = arrValue[1];
					form1.RUN_ORG_ID.value = arrValue[0];
					form1.RUN_KPI_ID.value=''; 
					form1.submit();
				}
			} // end if
		} 		
//		$( "#d_frame" )[0].src="";
//		alert("returnValue="+tt.value);
		tt.value = returnValue;
	} // end if
	
</script>
<span id="defaultTheme"></span> 
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="label_normal">
	<tr>
    	<td width="99%" height="10"><?include("header_menu.html")?></td>
  	</tr>
    <tr> 
	  <td align="left" valign="top">
<?	
		if ($UPD) $OPTIONAL_TITLE=" &gt; แก้ไขข้อมูล"; elseif ($VIEW) $OPTIONAL_TITLE=" &gt; ดูข้อมูล";
		include("current_location.html");
?>
	  </td>
	</tr>
  	<tr>
    	<td align="left" valign="top">
	<form name="form1" method="post" action="kpi_distribute.html" enctype="multipart/form-data">
		<input type="hidden" name="current_page" value="<?=$current_page?>">
		<input type="hidden" name="total_page" value="<?=$total_page?>">
	  <input type="hidden" name="MENU_ID_LV0" value="<?=$MENU_ID_LV0?>">
	  <input type="hidden" name="MENU_ID_LV1" value="<?=$MENU_ID_LV1?>">
	  <input type="hidden" name="MENU_ID_LV2" value="<?=$MENU_ID_LV2?>">
	  <input type="hidden" name="MENU_ID_LV3" value="<?=$MENU_ID_LV3?>">
	  <input type="hidden" name="command" value="">
	  <input type="hidden" name="KPI_ID_REF" value="<?=$KPI_ID_REF?>">
	  <input type="hidden" name="KPI_ID" value="<?=$KPI_ID?>">
	  <input type="hidden" name="LIST_OPENED_KPI" value="<?=$LIST_OPENED_KPI?>">
	  <input type="hidden" name="KPI_YEAR" value="<?=$KPI_YEAR?>">
	  <input type="hidden" name="KPI_ORG_ID" value="<?=$KPI_ORG_ID?>"><!-- ORG_ID -->
	  <input type="hidden" name="KPI_ORG_NAME" value="<?=$KPI_ORG_NAME?>"><!-- ORG_NAME -->
	  <input type="hidden" name="KPI_DEFINE" value="<?=$KPI_DEFINE?>"><!-- KPI_DEFINE -->
	  <input type="hidden" name="RUN_ORG_ID" value="<?=$ORG_ID?>"><!-- ORG_ID -->
	  <input type="hidden" name="RUN_KPI_ID" value="">		<!-- RUN_KPI_ID  <?=$RUN_KPI_ID?>-->
	  <input type="hidden" name="run_depth" value="<?=$run_depth?>">
	  <input type="hidden" name="OPEN_PER" value="<?=$OPEN_PER?>">
	  <input type="hidden" name="ORG_OPEN_PER" value="<?=$ORG_OPEN_PER?>">

		<table width="95%" align="center" cellpadding="0" cellspacing="0">
			<tr>
			  <td><table width="15%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
				  <tr>
					<td height="22" align="center" class="table_body"><?=$SEARCH_TITLE?></td>
				  </tr>		
			  </table></td>
			</tr>
		  </table>
				<table width="95%" align="center" cellpadding="0" cellspacing="0" class="input_table">
			<tr>
			  <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="label_normal">
				<tr>
				  <td height="22" align="center"><table width="100%"  border="0" cellpadding="0" cellspacing="0" class="label_normal">
						<tr>
							  <td height="10"></td>
						</tr>
						<tr> 
								<td width="15%" height="22" align="right"><?=$MINISTRY_TITLE?>&nbsp;:&nbsp;</td>
								<td width="35%">
						<input type="text" name="MINISTRY_NAME" value="<?=$MINISTRY_NAME?>" style="width:75%" class="textbox" readonly>
						<input type="hidden" name="MINISTRY_ID" value="<?=$MINISTRY_ID?>">
					<? if($CTRL_TYPE < 3 && $SESS_USERGROUP_LEVEL < 3){ ?>
					<input type="button" name="btn_ministry" class="button" value="<?=$SELECT_TITLE?>" title="<?=$MINISTRY_SELECT?>" onClick="call_search_ministry();">
             <input name="image" type="image" onClick="form1.MINISTRY_ID.value=''; form1.MINISTRY_NAME.value=''; form1.DEPARTMENT_ID.value=''; form1.DEPARTMENT_NAME.value=''; return false;" src="images/icon_clear.gif" alt="ล้างค่า" align="center" width="22" height="22">                  
					<? } // end if ?>			   </td>
								<td width="15%" align="right"><span class="label_alert">*</span>&nbsp;<?=$DEPARTMENT_TITLE?>&nbsp;:&nbsp;</td>
								<td>
						<input type="text" name="DEPARTMENT_NAME" value="<?=$DEPARTMENT_NAME?>" style="width:75%" class="textbox" readonly>
						<input type="hidden" name="DEPARTMENT_ID" value="<?=$DEPARTMENT_ID?>">
					<? if($CTRL_TYPE < 4 && $SESS_USERGROUP_LEVEL < 4){ ?>
					<input type="button" name="btn_department" class="button" value="<?=$SELECT_TITLE?>" title="<?=$DEPARTMENT_SELECT?>" onClick="call_search_department();">
             <input name="image" type="image" onClick="form1.DEPARTMENT_ID.value=''; form1.DEPARTMENT_NAME.value=''; form1.RUN_ORG_ID.value=form1.MINISTRY_ID_ID.value; f form1.OPEN_PER.value=''; return true;" src="images/icon_clear.gif" alt="ล้างค่า" align="center" width="22" height="22">                  
					<? } // end if ?>			   </td>
						</tr>
				  		<tr>
				              <td height="22" align="right"><?=$ORG_TITLE?>&nbsp;:&nbsp;</td>
				              <td><input type="text" name="search_org_name" value="<?=$search_org_name?>" style="width:75%" class="textbox"  readonly="true">
                					  <input type="hidden" name="search_org_id" value="<?=$search_org_id?>">
						<? if($SESS_USERGROUP_LEVEL < 5 || ($SESS_USERGROUP_LEVEL < 6 && $SESS_ORG_STRUCTURE==2 && !$search_org_id)){ ?>
                  						<input type="button" name="btn_org" value="<?=$SELECT_TITLE?>" class="button" onClick="call_search_org_0()" >
					                  <input type="image" src="images/icon_clear.gif" width="22" height="22" onClick="form1.search_org_name.value=''; form1.search_org_id.value='';  form1.RUN_ORG_ID.value=form1.DEPARTMENT_ID.value; form1.RUN_KPI_ID.value=''; form1.OPEN_PER.value=''; return true;" align="center" alt="ล้างค่า">
                  		<? } // end if ?></td>
              				<td height="22" align="right"><?=$ORG_TITLE1?>&nbsp;:&nbsp;</td>
              				<td><input type="text" name="search_org_name_1" value="<?=$search_org_name_1?>" style="width:75%" class="textbox"  readonly="true">
                  					<input type="hidden" name="search_org_id_1" value="<?=$search_org_id_1?>">
                  		<? if($SESS_USERGROUP_LEVEL < 6 || ($SESS_USERGROUP_LEVEL <= 6 && $SESS_ORG_STRUCTURE==2 && !$search_org_id)){ ?>
                  					<input type="button" name="btn_org_1" value="<?=$SELECT_TITLE?>" class="button" onClick="call_search_org1()" >
                  					<input type="image" src="images/icon_clear.gif" width="22" height="22" onClick="form1.search_org_name_1.value=''; form1.search_org_id_1.value=''; form1.RUN_ORG_ID.value=form1.search_org_id.value; form1.OPEN_PER.value=''; return true;" align="center" alt="ล้างค่า">
                  		<? } // end if ?></td>
            			</tr>
                    <tr>
                     <td width="15%" height="22" align="right"><?=$YEAR_TITLE?>&nbsp;:&nbsp;</td>
                    <? 
						if(!empty($arr_kpi_year)){
					?>	
						<td>
								<select name="KPI_SELECT_YEAR" onChange="form1.KPI_YEAR.value=form1.KPI_SELECT_YEAR.value; form1.KPI_ID.value=''; form1.KPI_ID_REF.value=''; form1.LIST_OPENED_KPI.value=''; form1.submit();">
					<?	
									foreach($arr_kpi_year as $value){ 
										$class = "table_body_3";
                                        $selected = "";
										if($value==$KPI_YEAR) { $class = "table_body_3_over"; $selected = "selected"; }
					?>
                      					<option value="<?=$value?>" <?=$selected?>><?=$value?></option>
                    <? 			} // end foreach ?>
								</select>
						</td>
					<? }else{
					?>
					<td>&nbsp;</td>
					<?
					}
					?>
					<td>&nbsp;</td>
					<td><input name="select_org_structure" type="radio" value="0" <?=($select_org_structure==0 || $SESS_ORG_STRUCTURE==0)?"checked":""?> <?=($SESS_ORG_STRUCTURE==1)?"disabled":"" ?> onClick="form0.search_org_id.value='';form0.search_org_name.value='';form0.search_org_id_1.value='';form0.search_org_name_1.value='';"><?=$LAW_STRUCTURE_TITLE?>&nbsp;
                    <input name="select_org_structure" type="radio" value="1" <?=($select_org_structure==1 || $SESS_ORG_STRUCTURE==1)?"checked":""?> <?=($SESS_ORG_STRUCTURE==0 || ($SESS_ORG_STRUCTURE==2&&($ORG_ID)))?"disabled":"" ?> onClick="form0.search_org_id.value='';form0.search_org_name.value='';form0.search_org_id_1.value='';form0.search_org_name_1.value='';"><?=$ASSIGN_STRUCTURE_TITLE?></td>
					</tr>
					
					<tr>							  
					   <td colspan="4"></td>
					</tr>
		
							</table></td>
				</tr>
        <tr>
          <td height="10"></td>
        </tr>
		</table></td>
		</tr>
	</table>
	&nbsp;
	<table width="95%" border="0" align="center" cellpadding="1" cellspacing="1" class="table_body">
		<tr align="center">
			<td height="22">
          	<? 
//	           	echo "KPI_YEAR($KPI_YEAR) && DEPARTMENT_ID($DEPARTMENT_ID)<br>";
//				if($KPI_YEAR && $DEPARTMENT_ID || $BKK_FLAG==1){
				if($KPI_YEAR && $ORG_ID){
                
			?>
			<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="table_body">
            	<tr class="table_head">
                    <td  height="22"  align="left">
                    <?
                            if($PAGE_AUTH["edit"]=="Y"){
                                if ($BUTTON_DISPLAY==1) { ?>
                                    <input name="bt_save" type="submit" class="button" onClick="return checkupdate(form1);" value="<?=$EDIT_TITLE?>">
                    <? 		} else { 	?>
                                    <input name="img_save" type="image" onClick="return checkupdate(form1);" src="images/save.png" alt="<?=$EDIT_TITLE?>" border="0">
                    <?		}	?>
                    <?	}
                            if ($BUTTON_DISPLAY==1) { ?>
                                <input type="submit" name="Reset2" value="<?=$CANCEL_TITLE?>" onClick="form1.command.value='CANCEL'" class="button" >
                    <? 	} else { ?>
                                <input name="image" type="image" onClick="form1.command.value='CANCEL'" src="images/cancel.gif" alt="<?=$CANCEL_TITLE?>" border="0">
                    <?	}	?>
                    </td>
	              	<td align="right">
    	          	<? if($PAGE_AUTH["print"]=="Y"){ ?>  
        	        	<? if ($BUTTON_DISPLAY==1) { ?>
								<input name="btn_export" type="button" class="button" value="<?=$EXCEL_TITLE?>" onClick="call_export_file('<?=$r_title?>');">
						<? } else { ?>
								<img src="images/doc_icon_excel.jpg" border="0" alt="<?=$EXCEL_TITLE?>" onClick="call_export_file('<?=$r_title?>');">
						<? } ?>
        	        	<? if ($BUTTON_DISPLAY==1) { ?>
								&nbsp;<input name="btn_pdf" type="button" class="button" value="<?=$PDF_TITLE?>" onClick="call_pdf_file('<?=$r_title?>');">
						<? } else { ?>
								&nbsp;<img src="images/doc_icon_excel.jpg" border="0" alt="<?=$PDF_TITLE?>" onClick="call_pdf_file('<?=$r_title?>');">
						<? } ?>
					<? }else{ echo "&nbsp;"; } ?>
					</td>
				</tr>
			</table></td>
		</tr>
        <tr align="center">
          <td height="25">
          	<?
					// เพิ่มส่วนนี้เพื่อ ตรวจสอบ ระดับต่ำกว่า ORG_ID ถ้าไม่มี ก็ขยับระดับขึ้นไป  1 ระดับ
					// echo "ตรวจสอบ head $cmd-($count_ORG_ID_REF_data) + $PARENT_ORG_ID;<br>";
                	$tab = "";
                	$TMP_ORG_ID = $ORG_ID;
					$arr_org = (array) null;
					$firstloop=1;
					while ($TMP_ORG_ID > 0 && $TMP_ORG_ID != $MINISTRY_ID) {
						$cmd = " select ORG_NAME, ORG_ID_REF from $ORGTAB where ORG_ID=$TMP_ORG_ID ";
						$cnt = $db_dpis->send_cmd($cmd);
//						echo "0..$cmd ($cnt)<br>";
						if ($cnt > 0) {
							if ($data = $db_dpis->get_array()) {
//								echo "0..$data[ORG_NAME] ($TMP_ORG_ID)<br>";
								$arr_org[id][] = $TMP_ORG_ID;
								$arr_org[name][] = $data[ORG_NAME];
								$arr_org[id_ref][] = $data[ORG_ID_REF];
								if ($TMP_ORG_ID==$data[ORG_ID_REF]) {
									$TMP_ORG_ID = 0;
								} else {
									$TMP_ORG_ID = $data[ORG_ID_REF];
								}
// เพิ่มส่วนนี้เพื่อ เก็บ parant ไว้สำหรับการเลื่อนระดับขึ้น
								if ($firstloop == 1 && $TMP_ORG_ID > 1) {
									$firstloop=0; 
									$PARENT_ORG_ID=$data[ORG_ID_REF];

									if ($OPEN_PER=="OPEN_PER") {
										$s_2top = get_org_2top($ORG_OPEN_PER, true);
//										echo "arr_2top [$s_2top] ($ORG_OPEN_PER)<br>";
                                        $arr_2top = explode(",",$s_2top);
                                    	$t_tmp_org = $arr_2top[count($arr_2top)-2];
                                        $t_deduct1 = 1;
                                        $t_deduct2 = 1;
									} else {
                                    	$t_tmp_org = $TMP_ORG_ID;
                                        $t_deduct1 = 1;
                                        $t_deduct2 = 1;
									}
                                    
									$t_tree_depth = find_org_dept($t_tmp_org);
				                   	$t_kd_type_chk = $t_tree_depth - $t_deduct1;
				                   	$t_kd_type_self = $t_tree_depth - $t_deduct2;

									$this_arr_kd_flag = (array) null;
									$this_arr_kpi_id = (array) null;
								  if($RUN_KPI_ID){
                                    if ($t_kd_type_chk == 2)
                                        $cmd2 = " select 		KPI_ID
                                                            from 		PER_KPI_DISTRIBUTE 
                                                            where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $RUN_KPI_ID and DEPARTMENT_ID = $DEPARTMENT_ID
                                                                             and ORG_ID = $t_tmp_org and ORG_ID_2 is null and KD_TYPE = $t_kd_type_self and KD_FLAG = 'R'
                                                            order by 	KPI_ID ";
                                    else if ($t_kd_type_chk == 3)
                                        $cmd2 = " select 		KPI_ID
                                                            from 		PER_KPI_DISTRIBUTE
                                                            where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $RUN_KPI_ID and DEPARTMENT_ID = $DEPARTMENT_ID
                                                                             and ORG_ID_1 = $t_tmp_org and KD_TYPE = $t_kd_type_self and KD_FLAG = 'R'
                                                            order by 	KPI_ID ";
                                    else if ($t_kd_type_chk == 4)
                                        $cmd2 = " select 		KPI_ID
                                                            from 		PER_KPI_DISTRIBUTE
                                                            where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $RUN_KPI_ID and DEPARTMENT_ID = $DEPARTMENT_ID
                                                                             and ORG_ID_2 = $t_tmp_org and KD_TYPE = $t_kd_type_self and KD_FLAG = 'R'
                                                            order by 	KPI_ID ";
                                    else if ($t_kd_type_chk == 1)
                                        $cmd2 = " select 		KPI_ID
                                                            from 		PER_KPI_DISTRIBUTE 
                                                            where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $RUN_KPI_ID and DEPARTMENT_ID = $t_tmp_org and ORG_ID_1 is null and ORG_ID_2 is null
																			and KD_TYPE = $t_kd_type_self and KD_FLAG = 'R'
                                                            order by 	KPI_ID ";
									$cnt_first_KPI = $db_dpis2->send_cmd($cmd2);
//									echo "first loop get KD_FLAG..$cmd2 ($cnt_first_KPI)<br>";
									if ($cnt_first_KPI > 0) {
										while ($data2 = $db_dpis2->get_array()) {
//											if ($data2[KD_FLAG]=="R") {
//												$this_arr_kd_flag[] = $data2[KD_FLAG];
												$this_arr_kpi_id[] = $data2[KPI_ID];
//											}
										}
									}
								  }
								} // end if ($firstloop == 1)
								// echo "$firstloop - $PARENT_ORG_ID ===> $cmd<br>";
// เพิ่มส่วนนี้เพื่อ เก็บ parant ไว้สำหรับการเลื่อนระดับขึ้น
							} // end if ($data = $db_dpis->get_array())
						} else {
                        	$TMP_ORG_ID = 0;
                            $this_kd_flag = "";
						} // end if ($cnt > 0)
					} // end loop while
					array_multisort($arr_org[id], SORT_ASC, $arr_org[name], SORT_ASC, $arr_org[id_ref], SORT_ASC);
			?>
<!-- เพิ่มส่วนนี้เพื่อ เก็บ parant ไว้สำหรับการเลื่อนระดับขึ้น-->
			<input type="hidden" name="PARENT_ORG_ID" value="<?=$PARENT_ORG_ID?>">
<!-- เพิ่มส่วนนี้เพื่อ เก็บ parant ไว้สำหรับการเลื่อนระดับขึ้น-->
			<table width="98%" border="0" align="center" cellpadding="1" cellspacing="1" class="table_body">
				<tr><td height="10"></td></tr>
				<tr align="center">
					<td height="25"><table width="98%"  border="0" cellpadding="0" cellspacing="0" class="label_normal">
			<?
					$cmd = " select ORG_ID , ORG_NAME, ORG_ID_REF from $ORGTAB where ORG_ID_REF = $ORG_ID and ORG_NAME != '-' and ORG_ID_REF != ORG_ID
									 order by ORG_ACTIVE DESC, ORG_SEQ_NO, ORG_CODE ";
					$count_data = $db_dpis->send_cmd($cmd);
//					$db_dpis->show_error();
//					echo "part1 $cmd ($count_data)<br>";
            		if (strlen($current_page_lvl) > 0) {	// ตรวจสอบ current page จาก หน้าก่อนส่งเข้ามา
                    	$arr_current_page = explode(",", $current_page_lvl);
                    }
					$arr_current_page_new = (array) null;
					for($i=0; $i < count($arr_org[id]); $i++) {
   	                   	$class = "table_body_over";
                        $i_edit="";
//						echo "arr_org [id] [$i] (".$arr_org[id][$i].")==ORG_ID ($ORG_ID)<br>";
						if ($arr_current_page[$i])
							$arr_current_page_new[] = $arr_current_page[$i];
						else
							$arr_current_page_new[] = "1";
//						echo "ORG_ID($ORG_ID) > DEPARTMENT_ID($DEPARTMENT_ID) && arr_org [id][$i](".$arr_org[id][$i]."==ORG_ID($ORG_ID) && count_data($count_data)==0<br>";
                        $style_cursor = "";
						if($arr_org[id][$i]==$DEPARTMENT_ID && $count_data==0) {
//							echo "$i--".$arr_org[name][$i]."....1<br>";
                            $sel_org = "select_head_org(". $arr_org[id][$i] .");";
							$class = "table_body";
							$style_cursor= "style='cursor:hand;'";
							$img = "&nbsp;<img id='img".$arr_org[id][$i]."' src='images/icon_return.gif' width='9' height='9' style='cursor:hand;'>";
                        } elseif($arr_org[id][$i]==$ORG_ID) {
//							echo "$i--".$arr_org[name][$i]."....2<br>";
                            $sel_org = "";
//							$style_cursor= "style='cursor:auto;'";
                            $img = "";
                        } else {
//                        	echo "(search_org_id($search_org_id) || search_org_id_1($search_org_id_1))<br>";
                        	if (!$search_org_id && !$search_org_id_1) {
//								echo "$i--".$arr_org[name][$i]."....3<br>";
                                $style_cursor= "style='cursor:hand;'";
                                $sel_org = "select_head_org(". $arr_org[id][$i] .");";
                                $img = "&nbsp;<img id='img".$arr_org[id][$i]."' src='images/icon_return.gif' width='9' height='9' style='cursor:hand;'>";
							} else {
//								echo "$i--".$arr_org[name][$i]."....4<br>";
    	                        $sel_org = "";
//								$style_cursor= "style='cursor:hand;'";
            	                $img = "";
                            }
                        }
			?>
						<tr class="<?=$class?>">
           	  				<td height="20"  colspan="4">&nbsp;<?=$tab?><span onClick="<?=$sel_org?>" <?=$style_cursor?> ><?=$arr_org[name][$i]?></span><?=$img?></td>
               			</tr>
            <?
                       	$tab .= "&nbsp;&nbsp;&nbsp;&nbsp;";
					} // end for $i
					$current_page_lvl = implode(",", $arr_current_page_new);		// ทำ current_page_lvl ให้เป็น list ของ current_page ที่ level ล่าสุด
                    $current_page_idx = count($arr_org[id])-1;
                    $current_page = $arr_current_page_new[$current_page_idx];
//					echo "current_page=$current_page, current_page_idx=$current_page_idx, current_page_lvl=$current_page_lvl<br>";
?>
					<input type="hidden" name="current_page_lvl" value="<?=$current_page_lvl?>">
					<input type="hidden" name="current_page_idx" value="<?=$current_page_idx?>">
<?                    
					if ($count_data) {
                    	$arr_KD = (array) null;
                    	$t_kd_type = $tree_depth;	// - 1;
						for($i=0; $i < count($arr_org[id]); $i++) {
                        	if ($arr_org[id][$i]==$ORG_ID) {
//								echo "arr_org [id] [$i] (".$arr_org[id][$i].")==ORG_ID ($ORG_ID) , t_kd_type=$t_kd_type<br>";
								$child_org_id = $arr_org[id][$i];

								if ($BKK_FLAG==1) $order_str = "ORG_ID, KPI_TYPE, KPI_NAME";
								else $order_str = "ORG_ID, KPI_NAME";

								$cmd2 = " select 	KPI_ID, KPI_NAME, DEPARTMENT_ID from PER_KPI
													where KPI_YEAR = $KPI_YEAR and DEPARTMENT_ID=$DEPARTMENT_ID
													order by 	$order_str ";
								$count_kpi = $db_dpis2->send_cmd($cmd2);
//								echo "kpi .. cmd=$cmd2 ($count_kpi)<br>";
//								$db_dpis2->show_error();
								if ($count_kpi) {
									while($data2 = $db_dpis2->get_array()){
                                    	$t_kpi_id = $data2[KPI_ID];
                                    	$t_kpi_name = $data2[KPI_NAME];
                                    	$t_kpi_dept = $data2[DEPARTMENT_ID];
										$arr_KD[$t_kpi_id][0][KPI_NAME] = $t_kpi_name;

                                        if ($t_kd_type == 2)
                                            $cmd3 = " select 		KD_ID, ORG_ID, ORG_ID_1 as this_org, ORG_ID_2, KD_PER_ID, KD_FLAG, KD_TYPE, KD_REMARK
                                                                from 		PER_KPI_DISTRIBUTE 
                                                                where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $t_kpi_id  and DEPARTMENT_ID = $t_kpi_dept 
                                                                				 and ORG_ID = $child_org_id and KD_TYPE=$t_kd_type
                                                                order by 	KD_ID ";
                                        else if ($t_kd_type == 3)
                                            $cmd3 = " select 		KD_ID, ORG_ID, ORG_ID_1, ORG_ID_2 as this_org, KD_PER_ID, KD_FLAG, KD_TYPE, KD_REMARK
                                                                from 		PER_KPI_DISTRIBUTE
                                                                where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $t_kpi_id and DEPARTMENT_ID = $t_kpi_dept
                                                                				and ORG_ID_1 = $child_org_id and KD_TYPE=$t_kd_type
                                                                order by 	KD_ID ";
                                        else if ($t_kd_type == 4)
                                            $cmd3 = " select 		KD_ID, ORG_ID, ORG_ID_1, ORG_ID_2, KD_PER_ID, KD_FLAG, KD_TYPE, KD_REMARK
                                                                from 		PER_KPI_DISTRIBUTE
                                                                where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $t_kpi_id and DEPARTMENT_ID = $t_kpi_dept
                                                                				and ORG_ID_2 = $child_org_id and KD_TYPE=$t_kd_type
                                                                order by 	KD_ID ";
                                        else if ($t_kd_type == 1)
                                            $cmd3 = " select 		KD_ID, ORG_ID as THIS_ORG, ORG_ID_1, ORG_ID_2, KD_PER_ID, KD_FLAG, KD_TYPE, KD_REMARK
                                                                from 		PER_KPI_DISTRIBUTE 
                                                                where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $t_kpi_id 
																				and DEPARTMENT_ID = $child_org_id and KD_TYPE=$t_kd_type
                                                                order by 	KD_ID ";
                                        $count_kpi_dist = $db_dpis3->send_cmd($cmd3);
//										echo "kpi .. cmd=$cmd3 ($count_kpi_dist)<br>";
//										$db_dpis3->show_error();
                                        if ($count_kpi_dist) {
                                            while($data3 = $db_dpis3->get_array()){
                                                $arr_KD[$t_kpi_id][0][KD_ID] = $data3[KD_ID];
                                                if ($data3[KD_PER_ID]) {
//                                                	echo "---per_id-->".$data3[KD_PER_ID]."<br>";
                                                    $arr_KD[$t_kpi_id][$data3[THIS_ORG]][$data3[KD_PER_ID]][KD_FLAG] = $data3[KD_FLAG];
                                                    $arr_KD[$t_kpi_id][$data3[THIS_ORG]][$data3[KD_PER_ID]][KD_REMARK] = $data3[KD_REMARK];
												} else {
//                                               	echo "---not per_id--><br>";
                                                    $arr_KD[$t_kpi_id][$data3[THIS_ORG]][KD_FLAG] = $data3[KD_FLAG];
                                                    $arr_KD[$t_kpi_id][$data3[THIS_ORG]][KD_REMARK] = $data3[KD_REMARK];
												}
//												echo "KPI_ID=".$t_kpi_id.", KPI_NAME=".$t_kpi_name.", KPI_PER_ID=".$data3[KD_PER_ID].", KD_FLAG=".$data3[KD_FLAG]."<br>";
                                            } // end while	data3
                                        } // end if($count_kpi_dist)
									} // end while data2
								} // end if ($count_kpi)
							} // end if ($arr_org[id]==$ORG_ID)
						} // end for $arr_org
                        
						$cmd = "	select ORG_ID , ORG_NAME, ORG_ID_REF, ORG_ACTIVE
										from $ORGTAB where ORG_ID_REF = $ORG_ID and ORG_NAME != '-' and ORG_ID_REF != ORG_ID and ORG_ACTIVE = 1
										order by ORG_ACTIVE DESC, ORG_SEQ_NO, ORG_CODE ";
						$count_page_data = $db_dpis->send_cmd($cmd);
//						$db_dpis->show_error();
//						echo "part2-$cmd-($count_page_data)<br>";
						if($count_page_data){
                        	$arr_page = (array) null;
							$current_list = "";
							$data_count = 0;
							while($data = $db_dpis->get_array()) {
//								echo "2..$data[ORG_NAME]<br>";
                            	if (($data[ORG_ID]!=$START_ORG_ID && $data[ORG_ID]!=0 && $data[ORG_ID]!=1) || $START_ORG_ID==$SESS_ORG_ID) {	//---ไม่เอา parent
									$cmd2 = " select ORG_ID, ORG_NAME from $ORGTAB where ORG_ID_REF=". $data[ORG_ID];
//									echo "$cmd<br>";
									$count_sub_tree = $db_dpis2->send_cmd($cmd2);
                                    while($data2 = $db_dpis2->get_array()) {
                                    	if ($data2[ORG_NAME]=="-") {
											$cmd3 = " select ORG_ID from $ORGTAB where ORG_ID_REF=". $data2[ORG_ID];
											$count_sub_tree = $db_dpis3->send_cmd($cmd3);
		                                    $arr_person = get_arr_person($data2[ORG_ID], ($tree_depth+1));
                                            $arr_page[$data_count][PER_ORG_ID] = $data2[ORG_ID];	// เก็บ ORG_ID  ของการอ่านราบบุคคล
                                            break;
                                        }
                                    }

                                    $arr_page[$data_count][ORG_ID] = $data[ORG_ID];
                                    $arr_page[$data_count][ORG_NAME] = $data[ORG_NAME];
                                    $arr_page[$data_count][count_sub_tree] = $count_sub_tree;

									if (!$arr_person) {
                                    	$arr_person = get_arr_person($data[ORG_ID], $tree_depth);
										$arr_page[$data_count][PER_ORG_ID] = $data[ORG_ID];	// เก็บ ORG_ID  ของการอ่านราบบุคคล
									}
                                    $arr_page[$data_count][count_person] = count($arr_person);
//									echo "count_person=".count($arr_person)."<br>";
                                    $arr_page[$data_count][ORG_ACTIVE] = $data[ORG_ACTIVE];
                                    
									$data_count++;
									if($data_count > $data_per_page) break;
                                } // end if ($data[ORG_ID]!=$START_ORG_ID)
							} // end while						

							$current_list = "";
							$data_count = 0;

							foreach($arr_KD as $key=>$value){
								$t_kpi_id = $key;
								if (!$this_arr_kpi_id || ($this_arr_kpi_id && in_array($t_kpi_id, $this_arr_kpi_id))) {
									$arr_ORG = $value;
//									echo "t_kpi_id($t_kpi_id)-->KPI_NAME(".$arr_ORG[0][KPI_NAME].")<br>";

									foreach($arr_page as $data_count=>$dd) {
        	                            $t_ORG_ID = $dd[ORG_ID];
//										$t_ORG_NAME = str_repeat(" ", ($tree_depth * 5)) .$dd[ORG_NAME];
										$t_ORG_NAME = $dd[ORG_NAME];
										$t_kd_id = $arr_ORG[0][KD_ID];
                        	            $t_kpi_name = $arr_ORG[0][KPI_NAME];
                            	        $t_kd_flag = $arr_ORG[$t_ORG_ID][KD_FLAG];
//                                	    echo "this_kd_flag=$this_kd_flag, t_kd_flag=$t_kd_flag, $t_kpi_name-$t_ORG_NAME<br>";
                                    	$t_kd_remark = $arr_ORG[$t_ORG_ID][KD_REMARK];
	                                    $person_count = $dd[count_person];
    	                                $t_per_ORG_ID = $dd[PER_ORG_ID];

//	    	                        	echo "2..$t_ORG_ID<br>";
										if (($t_ORG_ID!=$START_ORG_ID && $t_ORG_ID!=0 && $dd[ORG_ID]!=1) || $START_ORG_ID==$SESS_ORG_ID) {	//---ไม่เอา parent

                	                        $class = "table_body";
                    	                    if ($t_ORG_ID == $sel_org_id) $class = "table_body_over";
                        	                $current_list .= ((trim($current_list))?",":"") . $t_ORG_ID;

                            	            $tclass = "table_body";
											if(!$dd[count_sub_tree]) {
                                    	        $icon_name = "icon_mark.gif";
                                        	    $onClick = "";
	                                            $cursorStyle = "";
    	                                    } else {
        	                                    $icon_name = "icon_plus.gif";
            	                                $onClick = "select_org(". $t_ORG_ID . "," . $t_kpi_id . ");";
                	                            $cursorStyle = "style=\"cursor:hand\"";
                    	                        if ($SEL_ORG_ID==$t_ORG_ID) { 
                        	                        $icon_name = "icon_minus.gif";
                            	                    $tclass = "table_body_over2";
	                	                            $cursorStyle = "";
                        	                    } // end if
                            	            }
                                	        if ($person_count) {
                                    	    	if ($OPEN_PER=="OPEN_PER") {
	                                    	        $onPersonClick = "show_person(". $t_per_ORG_ID . "," . $t_kpi_id .");";
													$img_person = "&nbsp;&nbsp;&nbsp;&nbsp;<img id=\"imgperson$t_kpi_id\" src=\"images/icon_person_2close.gif\" width=\"9\" height=\"9\" onClick=\"$onPersonClick\" style=\"cursor:hand;\" title=\"แก้ไขรายบุคคล\"><span onClick=\"$onPersonClick\" style=\"cursor:hand\" title=\"ปิดรายการบุคคล\">&nbsp;<font size=\"-2\" color=\"#999999\">($person_count)</font></span>";
												} else {
		                                            $onPersonClick = "show_person(". $t_per_ORG_ID . "," . $t_kpi_id .");";
													$img_person = "&nbsp;&nbsp;&nbsp;&nbsp;<img id=\"imgperson$t_kpi_id\" src=\"images/icon_person_2open.gif\" width=\"9\" height=\"9\" onClick=\"$onPersonClick\" style=\"cursor:hand;\" title=\"แก้ไขรายบุคคล\"><span onClick=\"$onPersonClick\" style=\"cursor:hand\" title=\"แสดงรายการบุคคล\">&nbsp;<font size=\"-2\" color=\"#0000FF\">($person_count)</font></span>";
												}
											} else {
                    	                    	$img_person = "";
                        	                }
                            	            if ($dd[ORG_ACTIVE]==0) { 
                                	            $font_red1 = "<font color=\"#FF0000\">"; $font_red2 = "</font>"; 
                                    	    } else {
                                        	    $font_red1 = ""; $font_red2 = "";
	                                        }
    	                                    if ($data_count==0) {
?>
        	                                	<tr id="tr<?=$t_kpi_id?>" class="table_body_2" height="20">
            	                                	<td  width="100%" align="left" colspan="3">&nbsp;<?=$tab?><?=$t_kpi_name?></td>
                	                            </tr>
<?
											}
											if ($OPEN_PER=="OPEN_PER") {
												$input_disable = "disabled";
                                	            $color_change = "999999";
											} else {
												$input_disable = "";
                                            	$color_change = "000000";
											}
    	                                    if (!$input_disable) {
												$rem_disable = ($t_kd_flag=='SR' ? '' : 'disabled');
            	                                $rem_cursorStyle = ($t_kd_flag=='SR' ? $cursorStyle : "style=\"cursor:auto\"");
											} else {
												$rem_disable = $input_disable;
                        	                    $rem_cursorStyle = $cursorStyle;
                            	            }
//											echo "rem_cursorStyle=$rem_cursorStyle<br>";
//											echo "t_kd_flag=[$t_kd_flag]<br>";
//											$t_kd_flag = trim($t_kd_flag);
											$t_ORG_NAME .= "(".$t_ORG_ID.")";
?>
											<tr id="tr<?=$t_ORG_ID?>" class="<?=$tclass?>">
												<td width="<?=($arr_table_width[0]+$arr_table_width[1])?>%" align="left">&nbsp;<?=$tab?><img id="img<?=$t_kpi_id?>" src="images/<?=$icon_name?>" width="9" height="9" onClick="<?=$onClick?>" <?=$cursorStyle?>>&nbsp;<span onClick="<?=$onClick?>" <?=$cursorStyle?>><?=($font_red1. $t_ORG_NAME .$font_red2)?></span><?=$img_person?></td>
        	                                   <td height="20"  width="<?=$arr_table_width[2]?>%" title="<?=$t_ORG_NAME?>"><input onClick="call_kd_flag('R','<?=$t_kpi_id?>','<?=$t_ORG_ID?>','');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$t_ORG_ID)?>' value='R'  <?=($t_kd_flag=='R' ? 'checked' : '')?> <?=$input_disable?> />&nbsp;<font color="#<?=$color_change?>">R</font>&nbsp;&nbsp;<input onClick="call_kd_flag('SR','<?=$t_kpi_id?>','<?=$t_ORG_ID?>','');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$t_ORG_ID)?>' value='SR' <?=($t_kd_flag=='SR' ? 'checked' : '')?> <?=$input_disable?> />&nbsp;<font color="#<?=$color_change?>">SR</font>&nbsp;&nbsp;<input onClick="call_kd_flag('JR','<?=$t_kpi_id?>','<?=$t_ORG_ID?>','');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$t_ORG_ID)?>' value='JR' <?=($t_kd_flag=='JR' ? 'checked' : '')?> <?=$input_disable?> />&nbsp;<font color="#<?=$color_change?>">JR</font>&nbsp;&nbsp;<input onClick="call_kd_flag('','<?=$t_kpi_id?>','<?=$t_ORG_ID?>','');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$t_ORG_ID)?>' value='' <?=($t_kd_flag=='' ? 'checked' : '')?> <?=$input_disable?> />&nbsp;<font color="#<?=$color_change?>">No</font></td>
            	                                <td height="20" title="<?=$t_ORG_NAME?>">&nbsp;<span <?=$rem_cursorStyle?>><input type='text' name='<?=("kd_remark_".$t_kpi_id."_".$t_ORG_ID)?>'  value='<?=$t_kd_remark?>' size='50' <?=$rem_disable?>></span></td>
											</tr>
<?
//											echo "$OPEN_PER==\"OPEN_PER\" && $ORG_OPEN_PER == $t_ORG_ID && t_per_ORG_ID=$t_per_ORG_ID<br>";
											if ($OPEN_PER=="OPEN_PER" && $ORG_OPEN_PER == $t_per_ORG_ID) {
                            	            	$arr_KD1 = (array) null;
                                	            $t_kd_type = 4; // กรณี รายบุคคล

                                    	        $cmd3 = " select 		KD_ID, ORG_ID, ORG_ID_1, ORG_ID_2, KD_PER_ID, KD_TYPE, KD_FLAG, KD_REMARK
                                        	                        from 		PER_KPI_DISTRIBUTE
                                            	                    where 	KPI_YEAR = $KPI_YEAR and KPI_ID = $t_kpi_id and DEPARTMENT_ID = $DEPARTMENT_ID
                                                	                                and ORG_ID_2 = $ORG_OPEN_PER and KD_TYPE='$t_kd_type'
                                                    	            order by 	KD_ID ";
												$count_kpi_dist = $db_dpis3->send_cmd($cmd3);
//												echo "kpi .. cmd=$cmd3 ($count_kpi_dist)<br>";
//												$db_dpis3->show_error();
            	                                if ($count_kpi_dist) {
                	                                while($data3 = $db_dpis3->get_array()){
                    	                                $arr_KD1[$t_kpi_id][0][KD_ID] = $data3[KD_ID];
                        	                            if ($data3[KD_PER_ID]) {
//	                        	                        	echo "---per_id-->".$data3[KD_PER_ID]."<br>";
                                	                        $arr_KD1[$t_kpi_id][$data3[ORG_ID_2]][$data3[KD_PER_ID]][KD_FLAG] = $data3[KD_FLAG];
                                    	                    $arr_KD1[$t_kpi_id][$data3[ORG_ID_2]][$data3[KD_PER_ID]][KD_REMARK] = $data3[KD_REMARK];
                                        	            } else {
//		                                    	           	echo "---not per_id--><br>";
                                                	        $arr_KD1[$t_kpi_id][$data3[ORG_ID_2]][KD_FLAG] = $data3[KD_FLAG];
                                                    	    $arr_KD1[$t_kpi_id][$data3[ORG_ID_2]][KD_REMARK] = $data3[KD_REMARK];
	                                                    }
//														echo "KPI_ID=".$t_kpi_id.", KPI_NAME=".$t_kpi_name.", KPI_PER_ID=".$data3[KD_PER_ID]."<br>";
        	                                        } // end while	data3
            	                                } // end if($count_kpi_dist)

//												echo "t_kpi_id($t_kpi_id)-->KPI_NAME(".$arr_ORG[0][KPI_NAME].")<br>";

	                                            // หา person
    	                                        if ($t_ORG_ID != $ORG_OPEN_PER) $depth_deduct = 2;
        	                                    else $depth_deduct = 1;
												$this_depth = find_org_dept($ORG_OPEN_PER);
												$arr_content = get_arr_person($ORG_OPEN_PER, ($this_depth-$depth_deduct));
//												$arr_content = get_arr_person($ORG_OPEN_PER, $tree_depth);
                        	                    $cnt_person = count($arr_content);
                            	                if ($cnt_person) {
                                	                $tclass = "table_body";
                                    	            for($data_count = 0; $data_count < $cnt_person; $data_count++) {
                                        	            $tmp_PER_ID = $arr_content[$data_count][PER_ID];
                                            	        $tmp_PN_CODE = $arr_content[$data_count][PN_CODE];
                                                	    $tmp_PER_NAME = $arr_content[$data_count][PER_NAME];
	                                                    $tmp_PER_SURNAME = $arr_content[$data_count][PER_SURNAME];
    	                                                $tmp_full_name = $tmp_PER_NAME." ".$tmp_PER_SURNAME;
        	                                            $tmp_ORG_ID = $arr_content[$data_count][ORG_ID];
            	                                        $tmp_ORG_NAME = $arr_content[$data_count][ORG_NAME];
                	                                    $t_kd_flag1 = $arr_KD1[$t_kpi_id][$ORG_OPEN_PER][$tmp_PER_ID][KD_FLAG];
                    	                                $t_kd_remark1 = $arr_KD1[$t_kpi_id][$ORG_OPEN_PER][$tmp_PER_ID][KD_REMARK];
                        	                            $rem_disable = ($t_kd_flag1=='SR' ? '' : 'disabled');
                            	                        $rem_cursorStyle = ($t_kd_flag1=='SR' ? $cursorStyle : "style=\"cursor:auto\"");
//														echo "KPI_ID($t_kpi_id)-ORG_ID($ORG_OPEN_PER)-PER_ID($tmp_PER_ID)  ==> $t_kd_flag1 :: $t_kd_remark1 |".($t_kd_flag1=='R' ? 'checked' : '')."|".($t_kd_flag1=='SR' ? 'checked' : '')."|".($t_kd_flag1=='JR' ? 'checked' : '')."|<br>";
?>
                                    	                <tr id="trp<?=$tmp_PER_ID?>" class="<?=$tclass?>">
                                        	                <td  width="<?=($arr_table_width[0]+$arr_table_width[1])?>%" align="left">&nbsp;<?=$tab.$tab?><img id="img<?=$tmp_PER_ID?>" src="images/icon_person.gif" width="9" height="9" >&nbsp;<span ><?=(($data_count+1)." ".$font_red1. $tmp_full_name .$font_red2)?></span></td>
                                            	            <td height="20" width="<?=$arr_table_width[2]?>%" title="<?=($data_count+1).' '.$tmp_full_name?>"><input  onClick="call_kd_flag('R','<?=$t_kpi_id?>','<?=$ORG_OPEN_PER?>','<?=$tmp_PER_ID?>" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$ORG_OPEN_PER."_".$tmp_PER_ID)?>' value='R'  <?=($t_kd_flag1=='R' ? 'checked' : '');?> />&nbsp;R&nbsp;&nbsp;<input onClick="call_kd_flag('SR','<?=$t_kpi_id?>','<?=$ORG_OPEN_PER?>','<?=$tmp_PER_ID?>');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$ORG_OPEN_PER."_".$tmp_PER_ID)?>' value='SR' <?=($t_kd_flag1=='SR' ? 'checked' : '');?> />&nbsp;SR&nbsp;&nbsp;<input onClick="call_kd_flag('JR','<?=$t_kpi_id?>','<?=$ORG_OPEN_PER?>','<?=$tmp_PER_ID?>');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$ORG_OPEN_PER."_".$tmp_PER_ID)?>' value='JR' <?=($t_kd_flag1=='JR' ? 'checked' : '');?> />&nbsp;JR&nbsp;&nbsp;<input onClick="call_kd_flag('','<?=$t_kpi_id?>','<?=$ORG_OPEN_PER?>','<?=$tmp_PER_ID?>');" style='width: 20px;' type='radio' name='<?=("kd_flag_".$t_kpi_id."_".$ORG_OPEN_PER."_".$tmp_PER_ID)?>' value='' <?=($t_kd_flag1=='' ? 'checked' : '');?> />&nbsp;No</td>
	                                                        <td height="20"  title="<?=($data_count+1).' '.$tmp_full_name?>">&nbsp;<span <?=$rem_cursorStyle?>><input type='text' name='<?=("kd_remark_".$t_kpi_id."_".$ORG_OPEN_PER."_".$tmp_PER_ID)?>'  value='<?=$t_kd_remark1?>' size='50' <?=($t_kd_flag1=='SR' ? '' : 'disabled');?>></span></td>
    	                                                </tr>
<?
        	                                        } // end for $data_count
            	                                } else {
                	                                echo "<tr><td align='center'>***** ไม่พบข้อมูลโครงสร้างที่ต้องการ *****</td></tr>";
                    	                        }
                        	                } // end if $OPEN_PER
										} // end if ($dd[ORG_ID]!=$START_ORG_ID)
                                	} // end foreach $arr_page
								} // end if (in_array($t_kpi_id, $this_arr_kpi_id))
							} // end foreach $arr_kpi
							echo "</table>";
//							if ($total_page > 1) :
//								echo "<table width=\"95%\" border=\"0\" align=\"center\" cellpadding=\"2\" cellspacing=\"2\" class=\"table_footer\">";
//								echo "<tr><td>$page_link</td></tr>";
//								echo "</table>";
//							endif; echo "&nbsp;";
						} // end if($count_page_data)
					} // end if ($count_data)
?>
            		</table>
			<table width="100%" border="0" align="center" cellpadding="1" cellspacing="1" class="table_body">
            	<tr class="table_head">
                    <td  height="22"  align="left">
                    <?
                            if($PAGE_AUTH["edit"]=="Y"){
                                if ($BUTTON_DISPLAY==1) { ?>
                                    <input name="bt_save" type="submit" class="button" onClick="return checkupdate(form1);" value="<?=$EDIT_TITLE?>">
                    <? 		} else { 	?>
                                    <input name="img_save" type="image" onClick="return checkupdate(form1);" src="images/save.png" alt="<?=$EDIT_TITLE?>" border="0">
                    <?		}	?>
                    <?	}
                            if ($BUTTON_DISPLAY==1) { ?>
                                <input type="submit" name="Reset2" value="<?=$CANCEL_TITLE?>" onClick="form1.command.value='CANCEL'" class="button" >
                    <? 	} else { ?>
                                <input name="image" type="image" onClick="form1.command.value='CANCEL'" src="images/cancel.gif" alt="<?=$CANCEL_TITLE?>" border="0">
                    <?	}	?>
                    </td>
	              	<td align="right">
    	          	<? if($PAGE_AUTH["print"]=="Y"){ ?>  
        	        	<? if ($BUTTON_DISPLAY==1) { ?>
								<input name="btn_export" type="button" class="button" value="<?=$EXCEL_TITLE?>" onClick="call_export_file('<?=$r_title?>');">
						<? } else { ?>
								<img src="images/doc_icon_excel.jpg" border="0" alt="<?=$EXCEL_TITLE?>" onClick="call_export_file('<?=$r_title?>');">
						<? } ?>
        	        	<? if ($BUTTON_DISPLAY==1) { ?>
								&nbsp;<input name="btn_pdf" type="button" class="button" value="<?=$PDF_TITLE?>" onClick="call_pdf_file('<?=$r_title?>');">
						<? } else { ?>
								&nbsp;<img src="images/doc_icon_excel.jpg" border="0" alt="<?=$PDF_TITLE?>" onClick="call_pdf_file('<?=$r_title?>');">
						<? } ?>
					<? }else{ echo "&nbsp;"; } ?>
					</td>
				</tr>
			</table>
			</td></tr>
		</table>
		    <input type="hidden" name="current_list" value="<?=$current_list?>">

             <? 
	     		}elseif(!$DEPARTMENT_ID){ 
                	echo "กรุณาเลือก<?=$DEPARTMENT_TITLE?>ที่ต้องการ";
				}else{ echo "ไม่มีตัวชี้วัด"; } // end if 
			?>
		</td>
	</tr>
</table>
</form>	
		</td>
	</tr>
</table>
<?
	include("jqModalDialog.html");
?>
</body>
<script type="text/javascript">
setActiveStyleSheet(document.getElementById("defaultTheme"), "winter"); 
</script>
<script language="JavaScript" src="java_scripts/menu_layer.js"></script>
</html>
