<?
	include("../php_scripts/connect_database.php");

	$SESS_HOLIDAY = str_replace("|",chr(126),$SESS_HOLIDAY);		// แปลง |  กลับเป็น  chr(126) หลีกเลี่ยง การตัดโดย |

// argument 1 --> $table ชื่อตารางส่งเข้ามา ถ้าขึ้นต้นด้วย PER_ จะตัดออก เอาที่เหลือ ถ้าไม่ใช่เอาทั้งหมด
// argument 2 --> $form_part ส่วนของชื่อ form ถ้าส่วนนั้นไม่ตรงกับใน ชื่อตาราง
if ($table) {
	if ($form_part) {
    	$c = strpos($form_part,"?");
    	if ($c!==false)
			$form_part_name = substr($form_part,0,$c);
		else
			$form_part_name = $form_part;
	} else {
    	if (strtolower(substr($table,0,4))=="per_")
		    $form_part_name = strtolower(substr($table,4));
		else
		    $form_part_name = $table;
    }
 
//	echo "1..include file==>"."data_forms/master_".$form_part_name."_preset.php  (".file_exists("data_forms/master_".$form_part_name."_preset.php").")<br>";
	include("data_forms/master_".$form_part_name."_preset.php");	// กำหนดค่า $key_index, $active_index, $seq_order_index
	include("php_scripts/master_table_new.php"); 
//	echo "2..include file==>"."data_forms/master_".$form_part_name."_form.php  (".file_exists("data_forms/master_".$form_part_name."_form.php").")<br>";
	include("data_forms/master_".$form_part_name."_form.php"); // ตัดคำว่า PER_ ออก มาต่อเป็น form file

	if (file_exists("data_forms/master_".$form_part_name."_extend.php")) 
    	include("data_forms/master_".$form_part_name."_extend.php");	// กำหนดค่า function พิเศษ เพิ่ม ที่ไม่เรียกใน report  

	include("php_scripts/function_set_element.php"); 	//	function set_element($format)  return $retstr."^".$retnameself;	// $retstr is element tag return	// $retnameself is name of value replace
} else {
	$err_text = "****ไม่ได้ส่ง ชื่อตารางเข้าโปรแกรม ไม่สามารถทำงานได้****";
}
?>
<html>
<head>
<title><?=$webpage_title?> - <?=$MENU_TITLE_LV0?><?if($MENU_ID_LV1){?> - <?=$MENU_TITLE_LV1?><?}?><?if($MENU_ID_LV2){?> - <?=$MENU_TITLE_LV2?><?}?><?if($MENU_ID_LV3){?> - <?=$MENU_TITLE_LV3?><?}?></title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-874">
<link rel="stylesheet" href="<?=$cssfileselected?>" type="text/css">
<link rel="alternate stylesheet" type="text/css" media="all" href="stylesheets/calendar-blue.css" title="winter"/>
</head>
<script type="text/javascript" src="java_scripts/chk_date.js"></script>
<script type="text/javascript" src="java_scripts/calendar.js"></script>
<script type="text/javascript" src="java_scripts/calendar-th.js"></script> 
<script type="text/javascript" src="java_scripts/function_utility.js"></script> 
<script language="JavaScript">
	function change_current_page( page ){
		form1.current_page.value = page;
		form1.submit();
	}
	
	function confirm_delete(data_id , data_label){
		if(confirm("คุณต้องการลบข้อมูลนี้ [ " + data_label + " ] ใช่หรือไม่ ?")){
			form1.command.value = "DELETE";
			form1.<?=$arr_fields[$key_index]?>.value = data_id;
			//alert(<?=$arr_fields[0]?>);
			form1.submit();
	
		} // end if
	}

	function call_rtf_pdf_report(r_title,report_type) {
	     var  report_type
//		alert("sort_type="+form1.sort_type.value);
		var currDate = new Date();
		var rptDate = currDate.getFullYear().toString() + currDate.getMonth().toString() + currDate.getDate().toString(); 
			   rptDate += currDate.getHours().toString() + currDate.getMinutes().toString() + currDate.getSeconds().toString();
		var report_title = "รายงานข้อมูล<?=($MENU_ID_LV3)?$MENU_TITLE_LV3:(($MENU_ID_LV2)?$MENU_TITLE_LV2:(($MENU_ID_LV1)?$MENU_TITLE_LV1:(($MENU_ID_LV0)?$MENU_TITLE_LV0:"")))?>"+(r_title ? " ตาม "+r_title : "");
//		alert("report_title="+report_title);
		document.form1.target = "_blank";
		 if (report_type==1){
		document.form1.action = "report/rpt_master_table_new.php?report_title=" + report_title + "&table=<?=$table?>&form_part=<?=$form_part?>&UTC" + rptDate+"&FLAG_RTF=1";
		}else if (report_type==0){ 
		document.form1.action = "report/rpt_master_table_new.php?report_title=" + report_title + "&table=<?=$table?>&form_part=<?=$form_part?>&UTC" + rptDate+"&FLAG_RTF=0";
		}
		document.form1.submit();
		document.form1.target = "_self";
		document.form1.action = "master_table_new.html";
	} 
	
	function call_export_file(r_title) {
		var currDate = new Date();
		var rptDate = currDate.getFullYear().toString() + currDate.getMonth().toString() + currDate.getDate().toString(); 
			   rptDate += currDate.getHours().toString() + currDate.getMinutes().toString() + currDate.getSeconds().toString();
		var report_title = "รายงานข้อมูล<?=($MENU_ID_LV3)?$MENU_TITLE_LV3:(($MENU_ID_LV2)?$MENU_TITLE_LV2:(($MENU_ID_LV1)?$MENU_TITLE_LV1:(($MENU_ID_LV0)?$MENU_TITLE_LV0:"")))?>"+(r_title ? " ตาม "+r_title : "");
		document.form1.target = "_blank";
		document.form1.action = "report/rpt_master_table_new_xls.php?report_title=" + report_title + "&table=<?=$table?>&form_part=<?=$form_part?>&UTC" + rptDate;
		document.form1.submit();
		document.form1.target = "_self";
		document.form1.action = "master_table_new.html";
	}	
	
	function checkadd(f) {	
		//alert("add");
	<?
		for($i = 0; $i < count($col_entry_require); $i++) {
			if ($col_entry_require[$i]==1) {
				if ($i != $key_index || ($i == $key_index && !$f_autorun_index)) {
	?>
//					alert("<?=($i.'-fields ['.$i.']='.$arr_fields[$i].'=='.$col_label[$i]);?>");
					var obj = document.getElementsByName('<?=$arr_fields[$i]?>');
//					alert("aaaa"+obj);
					if (obj.length != 0) {
						if (obj[0].value=="") {
							alert("กรุณาระบุ <?=$col_label[$i]?>");
							obj[0].focus();
							return false;
						}
					} else {
//						alert("2....");
						var obj1 = document.getElementsByName('CHANGE_<?=$arr_fields[$i]?>');
						if (obj1.length != 0) {
//							alert("2.."+obj1[0].value);
							if (obj1[0].value=="") {
								alert("กรุณาระบุ <?=$col_label[$i]?>");
								obj1[0].focus();
								return false;
							}
						} else {
							alert("**** ตัวแปร Element ชื่อ <?=$arr_fields[$i]?> ไม่มีใน หน้านี้ โปรดติดต่อผู้พัฒนาโปรแกรมนี้...");
						}
					}
	<?
				}
			}
		}
	?>
		form1.command.value='ADD';
		return true;
	}
		
	function checkupdate(f) {
		//alert("update");
	<?
		for($i = 0; $i < count($col_entry_require); $i++) {
			if ($col_entry_require[$i]==1) {
	?>
//				alert("<?=($i.'-fields ['.$i.']='.$arr_fields[$i].'=='.$col_label[$i]);?>");
				var obj = document.getElementsByName('<?=$arr_fields[$i]?>');
//				alert("aaaa"+obj);
				if (obj.length != 0) {
					if (obj[0].value=="") {
						alert("กรุณาระบุ <?=$col_label[$i]?>");
						obj[0].focus();
						return false;
					}
				} else {
//					alert("2....");
					var obj1 = document.getElementsByName('CHANGE_<?=$arr_fields[$i]?>');
					if (obj1.length != 0) {
//						alert("2.."+obj1[0].value);
						if (obj1[0].value=="") {
							alert("กรุณาระบุ <?=$col_label[$i]?>");
							obj1[0].focus();
							return false;
						}
					} else {
						alert("**** ตัวแปร Element ชื่อ <?=$arr_fields[$i]?> ไม่มีใน หน้านี้ โปรดติดต่อผู้พัฒนาโปรแกรมนี้...");
					}
				}
	<?
			}
		}
	?>
		form1.command.value='UPDATE';
		return true;
	}

	function call_sort(flag) {
		var str_sort  = "<?=implode(",",$tab_sort)?>";
		var arr_sort = str_sort.split(",");
		var sort_seq = 1;
		for(i=0; i < arr_sort.length; i++) {
//			alert("flag="+flag+" , i="+i+" , arr_sort="+arr_sort[i]+" , sort_seq="+sort_seq);
			if (arr_sort[i]==1) {
				if (flag==sort_seq) {
					form1.order_by.value=String(sort_seq);		form1.sort_by.value=String(sort_seq);
					if(form1.sort_type.value==String(sort_seq)+":asc"){
						form1.sort_type.value=String(sort_seq)+":desc";
					}else{ //desc
						form1.sort_type.value=String(sort_seq)+":asc";
					}
					break;
				}
			}
			sort_seq++;
		}
		form1.command.value='SEARCH';
		form1.submit();
	} // end function call_sort
	
	function call_search_all() {
//		alert("1 cnt colsearch=<?=count($arr_col_search);?>");
	<?
		for($i=0; $i < count($arr_col_search); $i++) {
			$arr_sub_col_search = explode(",",$arr_col_search[$i]);
			if ($arr_c_srch_cond[$i]=="<>") {
				$search_elem_name1 = "search_".$arr_fields[$arr_sub_col_search[0]]."_min";	// เฉพาะ index 0 เพราะชื่อ search จะสร้าง element สำหรับ search เฉพาะ ชื่อจาก index 0 เท่านั้น
				$search_elem_name2 = "search_".$arr_fields[$arr_sub_col_search[0]]."_max";
	?>
				var obj = document.getElementsByName('<?=$search_elem_name1?>');
				if (obj.length != 0) {
//					alert("[<?=$i?>] cond '<>' min .."+obj[0].name+":"+obj[0].value); 
					obj[0].value = "";
					if (obj[0].type == "hidden") {
						var showname = obj[0].name.toLowerCase().replace("code","name";
						obj1 = document.getElementsByName(showname);
						if (obj1.length != 0) {
							obj1[0].value = "";
						}
					}
				}
//				form1.<?="search_".$arr_fields[$arr_sub_col_search[$j]]?>.value = "";
				obj = document.getElementsByName('<?=$search_elem_name2?>');
				if (obj.length != 0) {
//					alert("[<?=$i?>] cond '<>' max .."+obj[0].name+":"+obj[0].value); 
					obj[0].value = "";
					if (obj[0].type == "hidden") {
						var showname = obj[0].name.toLowerCase().replace("code","name";
						obj1 = document.getElementsByName(showname);
						if (obj1.length != 0) {
							obj1[0].value = "";
						}
					}
				}
	<?
			} else {
				$search_elem_name1 = "search_".$arr_fields[$arr_sub_col_search[0]];	// เฉพาะ index 0 เพราะชื่อ search จะสร้าง element สำหรับ search เฉพาะ ชื่อจาก index 0 เท่านั้น
				$search_elem_name2 = "";
	?>
				var obj = document.getElementsByName('<?=$search_elem_name1?>');
				if (obj.length != 0) {
//					alert("[<?=$i?>] cond = '<?=$arr_c_srch_cond[$i]?>'.."+obj[0].name+":"+obj[0].value+":"+obj[0].type); 
					obj[0].value = "";
					if (obj[0].type == "hidden") {
						var showname = obj[0].name.toLowerCase().replace("code","name");
						obj1 = document.getElementsByName(showname);
						if (obj1.length != 0) {
							obj1[0].value = "";
						}
					}
				}
//				form1.<?="search_".$arr_fields[$arr_sub_col_search[$j]]?>.value = "";
	<?
			}
	?>
//			alert("i="+"<?=$i?>"+"=>"+"<?=$arr_col_search[$i]?>"+", <?=$search_elem_name1?>"+", <?=$search_elem_name2?>");
	<?
		}
	?>
		// loop for rest    search_(var)
//		var x=document.getElementsByTagName("input");
//		for(ii=0; ii < x.length; ii++) {
//			var a = x[ii].name;
//			if (a.indexOf("search_") > -1) alert("search name="+a);
//		}
		form1.current_page.value=0;
		
		return true;
	}

	function call_search_any_table (search_tab, select_col, head_obj, ret_obj, fsubmit, title, column_sel) {
		// argument สำหรับ function call_search_any_table
		// 	ตัวที่ 1=search_tab ชื่อตาราง และ ชื่อ ส่วนกลางของ form (form_part) ถ้ามี 
		// 	ตัวที่ 2=select_col ชื่อ column ที่เลือกเข้ามา คั่นแต่ละ column ด้วย , comma
		// 	ตัวที่ 3=head_obj  ชื่อ object ที่เก็บข้อมูลที่จะส่งเข้าไปเป็น head key หัวเรื่องการค้นหา  เช่น ส่งรหัสจังหวัดเข้าไป ในการค้นหาอำเถอ เพื่อให้มันแสดงค่าเฉพาะ อำเภอในจังหวัดนั้นเท่านั้น
		//									คั่นแต่ละ ชื่อ ด้วย , comma และ คั่นระหว่างชื่อใน TABLE กับชื่อใน Element Form ที่ใช้เก็บค่าส่งไป search_000   กรณีชื่อไม่เหมือนกัน ด้วย &
		// 	ตัวที่ 4=ret_obj ชื่อ object ที่เก็บข้อมูลที่จะรับเข้ามาเป็นเก็บหรือแสดง คั่นแต่ละ ชื่อ ด้วย , comma
		// 	ตัวที่ 5=fsubmit  จะสั่งให้ submit ด้วยหรือไม่ ถ้า = 1 ก้อจะ submit ด้วย
		// 	ตัวที่ 6=title คำอธิบายหน้าต่างค้นหา ถ้ามีค่า @Element_name@ จะถูกแปลงเป็นค่าที่เก็บใน Element_name นั้น เช่นส่ง $AP_TITLE ใน @CHANGE_PV_NAME@ คือ เขต ใน จังหวัด@ชื่อจังหวัดในตัวแปร CHANGE_PV_NAME@
		// 	ตัวที่ 7=column select เลือก column ที่จะแสดง ให้ = y ไม่แสดงให้เท่ากับ n โดยดูตาม array ของ tab_head ใน  _form
		//
		var buff = search_tab.split(",");
		var tabname = buff[0].toLowerCase();
//		alert("argument="+search_tab+"|"+select_col+"|"+head_obj+"|"+ret_obj+"|"+fsubmit+"|"+title);
//		var tabname = search_tab.substr(4).toLowerCase();

		var form_part = (buff[1] ? buff[1] : "");
		var valname = "";
		var valtemp = "";
		if (!title) title=tabname;
		else {
			var c = title.indexOf("@");
			while (c > -1) {
				var c1 = title.indexOf("@", c+1);
				if (c1) {
					valname = title.substr(c+1, c1-c-1);
					valtemp = "@"+valname+"@";
//					alert("1..title="+title+", valname="+valname+", valtemp="+valtemp+", c="+c+", c1="+c1);
				} else {
					valname = title.substr(c+1);
					valtemp = "@"+valname;
//					alert("2..title="+title+", valname="+valname+", valtemp="+valtemp);
				}
				var val = document.getElementsByName(valname)[0].value; 	// value
//				alert("get val (valname)="+val);
				title = title.replace(valtemp, val);
				c = title.indexOf("@");
//				alert("title="+title+", next c="+c);
			}
		}

		parameter = "";
		var sub_head = new Array();
		if (head_obj) {
			var headobj = head_obj.split(",");	// แยก obj
			for(var i = 0; i < headobj.length; i++) {
				var hobj = headobj[i].split("&");	// แยก กรณี ชื่อ element ที่เก็บค่า ไม่ตรงกับชื่อ key ใน table
//				alert("i="+i+", hobj[0]="+hobj[0]+", hobj[1]="+hobj[1]);
				var thishead = "";
				if (hobj.length > 1) {
					if (isNumber( hobj[1] )) {	// กรณึที่เป็นค่าที่ส่งเข้ามาตรง ๆ เป็นตัวเลข
						thishead = hobj[1];
					} else if (hobj[1].indexOf("'") >= 0 || hobj[1].indexOf("\"") >= 0)	// กรณึที่เป็นค่าที่ส่งเข้ามา Text ภายใน เครื่องหมาย 'xxxxx' หรือ "xxxxx"
							 {
								 buff = hobj[1].trim();
								 buff = buff.replace(/\"/g, "");	// เอาเครื่อวหมายคำพูดทั้งสองแบบออก
								 buff = buff.replace(/'/g, "");	// เอาเครื่อวหมายคำพูดทั้งสองแบบออก
//								 alert("buff..["+ buff+"] ("+buff.length+")");
								if (buff.length == 0)
									thishead = "";
								else
									thishead = hobj[1];
//								 alert("quato..["+thishead+"]");
							 }
					else {
						thishead = document.getElementsByName(hobj[1])[0].value; 	// value คือตัวหลัง (1)
					}
				} else
					thishead = document.getElementsByName(hobj[0])[0].value; 	// ถ้าตัวหลังไม่ส่งค่า ก็เท่ากับตัวหน้า
//				alert("thishead="+thishead);
				var v1 = hobj[0];
				if (tabname=="amphur" && hobj[0]=="PV_CODE")  v1=hobj[0]+"1";	// เฉพาะ search_amphur ที่ชื่อที่ส่งเข้าไปมี 1 ตามด้วย
				if (thishead)
					sub_head.push(v1+"|"+thishead);
//				alert("i="+i+"--"+v1+"|"+thishead);
			}
		}
		var param = new Array();
		if (select_col) param.push("select_column="+select_col);
		if (sub_head.length > 0) param.push("head_key="+sub_head.join(","));
		if (ret_obj) param.push("col_send_back="+ret_obj);
		if (column_sel) param.push("column_select="+column_sel);
		if (param.length > 0) parameter = "&"+param.join("&", param);
//		alert("parameter="+parameter);
	    call_openDialog("search_000.html?table="+tabname+"&form_part="+form_part+"&title="+title+"MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>" + parameter,800,600,"");		
	}

	function isNumber(n) {
	  return !isNaN(parseFloat(n)) && isFinite(n);
	}

	function call_adjust() {
		parameter = "&COLUMN_FORMAT="+form1.COLUMN_FORMAT.value+"&rpt_format=rpt_master_table_new_format.php&table="+form1.table.value+"&form_part="+form1.form_part.value;
//		alert(parameter);
		call_openDialog("rpt_column_adjust.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>" + parameter,1000,600,"ปรับรูปแบบรายงาน");
	}
	
	document.onkeypress = keyPress;

	function keyPress(e){
 		var x = e || window.event;
  		var key = (x.keyCode || x.which);
    	if(key == 13 || key == 3){
//			myFunc1();
//			alert("x.target="+x.target+", x.srcElement.name="+x.srcElement.name);
			if (x.srcElement.name.indexOf("search_")!=-1) // if founded
				document.form1.search_btn.click();
			else {
				var f_upd = "<?=$UPD?>";
				if (f_upd)
					document.form1.upd_submit_btn.click();
				else
					document.form1.add_submit_btn.click();
			}
    	}
    }

	function returnFrom(src, returnValue){
//		alert("src="+src+"("+returnValue+")");
		 if  (src.indexOf("search_000") > -1) {
			var f_ret = false;
			if(returnValue){
				f_ret = true;
				arrValue = returnValue.split("<::>");
				var retobj = ret_obj.split(",");	// แยก obj
				for(var i = 0; i < retobj.length; i++) {
					var thisobj = document.getElementsByName(retobj[i])[0];
					thisobj.value = arrValue[i].trim();
	//				alert("retobj ["+i+"]="+thisobj.name+"=="+arrValue[i].trim()+"=="+thisobj.value);
				}
				if (fsubmit==1) {
					form1.current_page.value = 0;
					form1.submit();
				}
			} // end if
		} else if  (src.indexOf("rpt_column_adjust") > -1) {
			if(returnValue){
				form1.COLUMN_FORMAT.value = returnValue;
	//			alert(form1.COLUMN_FORMAT.value);
			} // end if
		} 		
//		$( "#d_frame" )[0].src="";
//		alert("returnValue="+tt.value);
		tt.value = returnValue;
	} // end if
	
</script>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="label_normal">
	<tr>
    	<td height="10"><?include("header_menu.html")?></td>
  	</tr>
<?
if ($err_text) {
?>
    <tr>
		<td colspan="2" height="5" align="center">&nbsp;</td>
    </tr>
    <tr>
		<td colspan="2" height="5" align="center">&nbsp;</td>
    </tr>
    <tr>
		<td colspan="2" height="5" align="center"><span class="label_alert"><?=$err_text?></span></td>
    </tr>
<?
} else {
?>
    <tr> 
	  <td align="left" valign="top">
<?	
		if ($UPD) $OPTIONAL_TITLE=" &gt; แก้ไขข้อมูล"; elseif ($VIEW) $OPTIONAL_TITLE=" &gt; ดูข้อมูล";
		include("current_location.html");
?>
	  </td>
	</tr>
  	<tr>
    	<td align="left" valign="top"><form name="form1" method="post" action="master_table_new.html" enctype="multipart/form-data">
          <input type="hidden" name="current_page" value="<?=$current_page?>">
          <input type="hidden" name="total_page" value="<?=$total_page?>">
		  <input type="hidden" name="MENU_ID_LV0" value="<?=$MENU_ID_LV0?>">
		  <input type="hidden" name="MENU_ID_LV1" value="<?=$MENU_ID_LV1?>">
		  <input type="hidden" name="MENU_ID_LV2" value="<?=$MENU_ID_LV2?>">
		  <input type="hidden" name="MENU_ID_LV3" value="<?=$MENU_ID_LV3?>">
          <input type="hidden" name="command" value="">
          <input type="hidden" name="table" value="<?=$table?>">
          <input type="hidden" name="form_part" value="<?=$form_part?>">
		  <input type="hidden" name="COLUMN_FORMAT" value="<?=$COLUMN_FORMAT?>">
&nbsp;
<?
	$a_search_cond = (array) null;
    $r_title = "";
	$head_title = "";
	if ($f_show_head_control) {
    	$last_cond = "";
        $f_break = false;
?>
  		<table width="90%"  border="0" align="center" cellpadding="0" cellspacing="0" class="table_head">
<?
	for($i=0; $i < count($head_control_tab); $i++) {
//        	echo "$i--".$head_control_tab[$i]."<br>";
			$arr_sub_control_tab = explode("|", $head_control_tab[$i]);
			$column_control_code = explode(",",$arr_sub_control_tab[2]);	// array ของ รหัส เพื่อค้นหา อาจมี & ด้วยชื่อ element ที่ไว้แสดงค่าใน form ส่มาด้วย แต่ไม่ได้ใช้ในส่วนนี้
			$column_control_name = explode(",",$arr_sub_control_tab[3]);	// array ของ ชื่อ ที่ต้องการนำมาแสดง อาจมี & ด้วยชื่อ element ที่ไว้แสดงค่าใน form ส่มาด้วย แต่ไม่ได้ใช้ในส่วนนี้
			$head_control_name = explode(",",$arr_sub_control_tab[5]);	// array ของ ชื่อ ที่ต้องการให้เป็น หัวเรื่อง ของการค้นหา ใช้ใน search_000
			$search_title = ($arr_sub_control_tab[6] ? $arr_sub_control_tab[6] : $arr_sub_control_tab[1]);	// หัวเรื่อง (title) ของการค้นหา ใช้ใน search_000
            
//        	echo "$i--".implode(",",$arr_sub_control_tab)."<br>";
			$cond = $arr_sub_control_tab[4];
            $founded = false;
            if (!$f_break) {
                while (true) {
                    if ($cond) $where1 = "where $cond"; else $where1 = "";
                    $cmd1 = " select * from ".$arr_sub_control_tab[0]." $where1";
                    // แทนค่าลงตัวแปรในเงื่อนไข var1 var2...
                    for($k = 0; $k < count($column_control_code); $k++) {
                    	$column_buff = explode("&",$column_control_code[$k]);	// ใช้ตัวที่ [0] ตัวที่ [1] ถ้ามี จะใช้ในการอ่านค่า ไป fill form ใน .php
                    	$var = "var".($k+1);	// ชื่อของตัวแปร ลำดับตั้งแต่ 1
	                    $cmd1 = str_replace($var, $$column_buff[0], $cmd1);
					}
                    $cnt = $db_dpis1->send_cmd($cmd1);
//					echo "cmd1=$cmd1 ($cnt)<br>";
					if ($cnt) {	// ถ้ามีค่าอ่านได้จากฐานข้อมูล
                        $data1 = $db_dpis1->get_array();
                        // อ่านค่า code ที่กำหนดทั้งหมด
                        for($k = 0; $k < count($column_control_code); $k++) {
	                    	$column_buff = explode("&",$column_control_code[$k]);	// ใช้ตัวที่ [0] ตัวที่ [1] ถ้ามี จะใช้ในการอ่านค่า ไป fill form ใน .php
	                        $$column_buff[0] = $data1[$column_buff[0]];
//							echo ">code $k>".$column_buff[0].">data>".$data1[$column_buff[0]]."<br>";
						}
                        $r_s_title = "";
                        // อ่านค่าที่ต้องการแสดง ที่กำหนดทั้งหมด
                        for($k = 0; $k < count($column_control_name); $k++) {
	                    	$column_buff = explode("&",$column_control_name[$k]);	// ใช้ตัวที่ [0] ตัวที่ [1] ถ้ามี จะใช้ในการอ่านค่า ไป fill form ใน .php
	                        $$column_buff[0] = $data1[$column_buff[0]];	
	                        $r_s_title = $$column_buff[0]." ";	// ประกอบค่า title
                            $head_title = $$column_buff[0]." ";
//							echo ">name $k>".$column_buff[0].">data>".$data1[$column_buff[0]]."";
						}
                        $r_title = $arr_sub_control_tab[1].$r_s_title.$r_title;
                        
//						echo " ($r_title)<br>";
                        $founded = true;
                        break;		// อ่านเจอ ก็ออกจาก loop
					} else {	// ถ้าไม่มีค่าจากฐานข้อมูลตามเงื่อนไข จะปรับเงื่อนไขใหม่ ลดทอนให้อ่าน first record แทน
//	                	echo "cond=$cond, last_cond=$last_cond<br>";
						$last_buff = explode(" and ", $last_cond);
                        $buff = explode(" and ", $cond);
                        $buff0 = $buff;
                        $buff1 = array_pop($buff0);
						if (!in_array($buff1,$last_buff)) {
//							echo "buff0=".implode(",",$buff0)."||buff1=".implode(",",$buff1)."||last_buff=".implode(",",$last_buff)."<br>";
                            $cond = implode(" and ", $buff0);
                        } else {
                            break;		// อ่านจนจบแล้วไม่เจอ ก็ออกจาก loop
                        }
                    } 	// end if ($cnt)
                } // end while loop mean cnt > 0 อ่านข้อมูลได้ แล้ว หรือ สุดแล้วก็ยังอ่านไม่ได้
//				echo "r_title=$r_title<br>";
                $last_cond = $cond;	// ใช้เปรียบเทียบ เงือนไขก่อนหน้าว่า อย่างน้อยเท่ากับ เงื่อนไขอันก่อน โดยคิดว่า เงื่อนไข แต่ละระดับ จะเพิ่มระดับลึกลงไป 1 2 หรือ 3 เงื่อนไข จากอันก่อนหน้าเสมอ
				for($k = 0; $k < count($column_control_code); $k++) {
                   	$column_buff = explode("&",$column_control_code[$k]);	// ใช้ตัวที่ [0] ตัวที่ [1] ถ้ามี จะใช้ในการอ่านค่า ไป fill form ใน .php
                    if (in_array($column_buff [0],$arr_fields))	{	// ถ้า column นั้น ๆ มีใน table หลัก ก็สร้างเป็นเงื่อนไข ไว้อ่านใน table หลัก
                        if ($founded)  // ถ้า head ไหนมีข้อมูล เงื่อนไขก็จะไม่มีค่า
                            $a_search_cond[] = "".$column_buff [0]."=".$$column_buff [0]."";
                        else
                            $a_search_cond[] = "".$column_buff [0]."=NULL";
//							echo "a_search_cond []-->".$column_buff [0]."=".$$column_buff [0]."<br>";
					}
				}
			}
			if ($founded) {	// ถ้าอ่านข้อมูลได้
?>
				<div id="dynamic_hidden"></div>
                <tr>
                    <td height="25" class="header_current_location">&nbsp;&nbsp;<?=$arr_sub_control_tab[1]?><?=$head_title?></td>
                    <td width="15%" align="right">
<?
					$arr_col_code = (array) null;
					$arr_col_name = (array) null;
					for($k = 0; $k < count($column_control_code); $k++) {
	                   	$column_buff = explode("&",$column_control_code[$k]);	// ใช้ตัวที่ [0] ตัวที่ [1] ถ้ามี จะใช้ในการอ่านค่า ไป fill form ใน .php
                        $arr_col_code[] = $column_buff[0];
//                   	echo "$k--code=".$column_buff[0]." value=".$$column_buff[0]."<br>";
?>
						<script language="JavaScript">
                    		thisobj = document.getElementsByName("<?=$column_buff[0]?>")[0];
//							alert("thisobj="+thisobj.value);
//							if (thisobj.value) alert(thisobj.name+' founded'); else alert(thisobj.name+' not founded');
//							alert((typeof thisobj === 'undefined') ? '<?=$column_buff[0]?> undefined' : (thisobj === null) ? '<?=$column_buff[0]?>= null' : isNull(thisobj) ? 'isNull(<?=$column_buff[0]?>)' : '***'); // false
							if (typeof thisobj === 'undefined')  {
//								alert('<?=$column_buff[0]?> undefined');
								document.getElementById('dynamic_hidden').innerHTML += "<input type='hidden' name='<?=$column_buff[0]?>'  value='<?=trim($$column_buff[0])?>' />";
//							} else {
//								alert(thisobj.name+"="+thisobj.value);
							}
						</script>
<!--					<input type="text" name="<?=$column_control_code[$k]?>" value="<?=$$column_control_code[$k]?>">-->
<?
					}
                    for($k = 0; $k < count($column_control_name); $k++) {
	                   	$column_buff = explode("&",$column_control_name[$k]);	// ใช้ตัวที่ [0] ตัวที่ [1] ถ้ามี จะใช้ในการอ่านค่า ไป fill form ใน .php
                        $arr_col_name[] = $column_buff[0];
//                    	echo "$k--name=".$column_buff[0]." value=".$$column_buff[0]."<br>";
?>
						<script language="JavaScript">
                    		thisobj = document.getElementsByName("<?=$column_buff[0]?>")[0];
//							alert("thisobj="+thisobj.value);
//							if (thisobj.value) alert(thisobj.name+' founded'); else alert(thisobj.name+' not founded');
//							alert((typeof thisobj === 'undefined') ? '<?=$column_buff[0]?> undefined' : (thisobj === null) ? '<?=$column_buff[0]?>= null' : isNull(thisobj) ? 'isNull(<?=$column_buff[0]?>)' : '***'); // false
							if (typeof thisobj === 'undefined')  {
//								alert('<?=$column_buff[0]?> undefined');
//								alert(document.getElementById('text').innerHTML);
								document.getElementById('dynamic_hidden').innerHTML += "<input type='hidden' name='<?=$column_buff[0]?>'  value='<?=trim($$column_buff[0])?>' />";
//							} else {
//								alert(thisobj.name+"="+thisobj.value);
							}
						</script>
<!--					<input type="hidden" name="<?=$column_control_name[$k]?>" value="<?=$$column_control_code[$k]?>">-->
<?
					}                    
					$col_head= implode(",",$head_control_name);
                    $col_sel = implode(",",$arr_col_code).",".implode(",",$arr_col_name);
                    $col_ret = implode(",",$arr_col_code).",".implode(",",$arr_col_name);
?>
                    <input name="btn2" type="button" class="button" value="<?=$SELECT_TITLE?><?=$$arr_sub_control_tab[1]?>" onClick="call_search_any_table ('<?=$arr_sub_control_tab[0];?>', '<?=$col_sel?>', '<?=$col_head;?>', '<?=$col_ret?>', 1, '<?=$search_title?>');">&nbsp;&nbsp; 
                    </td>
                </tr>
<?
			} else {
					for($k = 0; $k < count($column_control_code); $k++) {
?>
						<script language="JavaScript">
                    		thisobj = document.getElementsByName("<?=$column_control_code[$k]?>")[0];
							if (typeof thisobj === 'undefined')  {
								document.getElementById('dynamic_hidden').innerHTML += "<input type='text' name='<?=$column_control_code[$k]?>'  value='<?=trim($$column_control_code[$k])?>' />";
							}
						</script>
<?
					}
                    for($k = 0; $k < count($column_control_name); $k++) {
?>
						<script language="JavaScript">
                    		thisobj = document.getElementsByName("<?=$column_control_name[$k]?>")[0];
							if (typeof thisobj === 'undefined')  {
								document.getElementById('dynamic_hidden').innerHTML += "<input type='text' name='<?=$column_control_name[$k]?>'  value='<?=trim($$column_control_name[$k])?>' />";
							}
						</script>
<?
					}
					$f_break=true;	// ถ้ารายการไม่มีค่าให้แสดง head ต่อไป ก็ไม่ต้องแสดงด้วย
            }
		}
        
?>
  		</table><br>
<?
	}
    if ($a_search_cond)
	    $arr_search_condition[] = "(".implode(" and ",$a_search_cond).")";
//		echo "part 1=".implode(" and ",$a_search_cond)."<br>";
?>
<table width="90%" align="center" cellpadding="0" cellspacing="0">
  	<tr>
	  <td><table width="15%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
		  <tr>
		  	<td height="22" align="center" class="table_body"><?=($UPD)?"แก้ไข":"เพิ่ม"?>ข้อมูล</td>
		  </tr>		
	  </table></td>
	</tr>
  </table>
  <table width="90%" align="center" cellpadding="0" cellspacing="0" class="input_table">
    <tr>
      <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="label_normal">
        <tr>
          <td colspan="2" height="5" align="center">&nbsp;</td>
		</tr>
<?
		// ส่วน form insert, update
		foreach($arr_form_rc as $key1 => $arr_col) {
?>
			<tr>
<?
			foreach($arr_col as $key2 => $value) {
//				echo "1 value=$value<br>";
				if ($value) {	// ถ้า มีค่า ถ้าไม่มีค่าก็ไม่แสดง
                    $arr_elem = explode("^",$value);
                    $w = ($arr_form_col_perc_w[$key2] ? "width='".$arr_form_col_perc_w[$key2]."'" : "");
                    $a = ($arr_form_col_align[$key2] ? $arr_form_col_align[$key2] : "left");
                    $va = ($arr_form_col_valign[$key2] ? "valign='".$arr_form_col_valign[$key2]."'" : "");
?>
					<td <?=$w?> align="<?=$a?>" <?=$va?>">
<?
					for($ii = 0; $ii < count($arr_elem); $ii++) {
						$arr_ret = explode("^",set_element($arr_elem[$ii]));
//						echo "1..(".substr($arr_ret[0],1)."||".$arr_ret[1].")";	// 0 เป็น tag 1 เป็น name replace @@
						if (substr($arr_ret[1],0,5)=="func|") {	// ถ้าเป็น function ค่าพิเศษ ลงใน text หรือ label ธรรมดา
							$arr_buff = explode("|",$arr_ret[1]);
							$argu = (array) null;
//							echo ">>".$arr_buff[1].",".$arr_buff[2]."(".$arr_buff[2]."),".$arr_buff[3].",".$arr_buff[4]."<br>";
							for($i=2; $i < count($arr_buff); $i++) {
								if (substr($arr_buff[$i],0,2)=="'@" && substr($arr_buff[$i],strlen($arr_buff[$i])-2,2)=="@'") {
									$argu[] = "'".${substr($arr_buff[$i],2,strlen($arr_buff[$i])-4)}."'";	// ค่าภายใน
//									echo "val1($i)=".${substr($arr_buff[$i],2,strlen($arr_buff[$i])-4)}."<br>";
								} else if (substr($arr_buff[$i],0,1)=="@" && substr($arr_buff[$i],strlen($arr_buff[$i])-1,1)=="@") {
									$argu[] = ${substr($arr_buff[$i],1,strlen($arr_buff[$i])-2)};	// ค่าภายใน
//									echo "val1($i)=".${substr($arr_buff[$i],1,strlen($arr_buff[$i])-2)}."<br>";
								} else {
									$argu[] = $arr_buff[$i];
//									echo "val2($i)=".$arr_buff[$i]."<br>";
								}
							}
                            $ret = call_user_func_array($arr_buff[1], $argu);
//							echo ">>".$arr_buff[1]."(".implode(",",$argu).") ret=$ret<br>";
							$elem_str = str_replace("@fvalue@", $ret, $arr_ret[0]);
                            if (strpos($elem_str,"hidden")===false) $spacing = "&nbsp;&nbsp;";  else $spacing = "";
                            echo $elem_str.$spacing;	// แสดง element ที่ได้
						} else {	// เป็นค่าปกติ เพื่อย้ายเข้าไปใส่ค่าแทนใน value ใน element
                            $arr_argu = explode(",",$arr_ret[1]);
                            for($k=0; $k < count($arr_argu); $k++) {
                                if (substr($arr_argu[$k],0,2)=="'@" && substr($arr_argu[$k],strlen($arr_argu[$k])-2)=="@'") {
                                    $nm = substr($arr_argu[$k],2,strlen($arr_argu[$k])-4);
//									echo "1..$k argu=".$arr_argu[$k].",nm=$nm (".trim($$nm).")<br>";
                                    $elem_str = str_replace(substr($arr_argu[$k],1,strlen($arr_argu[$k])-2), trim($$nm), $arr_ret[0]);
//									echo "1..$elem_str<br>";
                                } else if (substr($arr_argu[$k],0,1)=="@" && substr($arr_argu[$k],strlen($arr_argu[$k])-1)=="@") {
                                    $nm = substr($arr_argu[$k],1,strlen($arr_argu[$k])-2);
//									echo "2..$k argu=".$arr_argu[$k].",nm=$nm (".trim($$nm).")<br>";
//									echo "2..".$arr_ret[0]."<br>";
                                    $elem_str = str_replace($arr_argu[$k], trim($$nm), $arr_ret[0]);
//									echo "2..$elem_str<br>";
                                } else {
                                    if (is_null($$arr_argu[$k]) || $$arr_argu[$k]=="NULL") $val = ""; else $val = trim($$arr_argu[$k]);
//									echo "3..$k argu=".$arr_argu[$k].", (".trim($$arr_argu[$k])."), val=$val<br>";
                                    $elem_str = str_replace("@self@", $val, $arr_ret[0]);
                                }
                            }
//							echo "1..".substr($elem_str,1)."<br>";
                            if (substr($elem_str,0,5)=="func_") {
                                $f_agum = explode("(",substr($elem_str,5,strlen($elem_str)-6));
                                call_user_func_array($f_agum[0], explode("|",$f_agum[1]));
//								echo "f_agum=".$f_agum[0]."|".$f_agum[1]."<br>";
//								echo "".$f_agum[0]."(".$f_agum[1].")";
                            } else {
                            	if (strpos($elem_str,"hidden")===false) $spacing = "&nbsp;&nbsp;";  else $spacing = "";
                                echo $elem_str.$spacing;	// แสดง element ที่ได้
//								echo substr($elem_str,1)."<br>";
                            }
						}
					} // for loop detail
?>
					</td>
<?
				} // end if ($value)
			} // for loop columns
?>
			</tr>
<?
		} // for loop rows
?>
        <tr align="center">
          <td height="30" colspan="<?=count($arr_form_col_perc_w)?>">
		  	<?	if ($UPD) { 
						if ($PAGE_AUTH["edit"]=="Y") {
			  				if ($BUTTON_DISPLAY==1) { ?>
			  					<input name="upd_submit_btn" type="submit" class="button" onClick="return checkupdate(form1);" value="<?=$EDIT_TITLE?>">
			<? 			} else { ?>
			  					<input type="image" src="images/save.png" border="0" alt="<?=$EDIT_TITLE?>" onClick="return checkupdate(form1);">
			<? 			} ?> 
			<?		} ?> 
		  	<?		if ($BUTTON_DISPLAY==1) { ?>
			  				<input type="submit" name="Reset2" value="<?=$CANCEL_TITLE?>" onClick="form1.command.value='CANCEL'" class="button" >
			<? 		} else { ?>
              				<input type="image" src="images/cancel.gif" border="0" alt="<?=$CANCEL_TITLE?>" onClick="form1.command.value='CANCEL'">
			<? 		} ?> 
      		<?	} else {  // not $UPD
						if ($PAGE_AUTH["add"]=="Y") {
							if ($BUTTON_DISPLAY==1) { ?>
					  			<input name="add_submit_btn" type="submit" class="button" onClick="return checkadd(form1);" value="<?=$ADD_TITLE?>">
			<? 			} else { ?>
								<input type="image" src="images/save.png" border="0" alt="<?=$ADD_TITLE?>" onClick="return checkadd(form1);">
			<?			} ?> 
			<?		} ?> 
			<?		if ($BUTTON_DISPLAY==1) { ?>
							<input name="Reset2" type="reset" class="button" value="<?=$CLEAR_TITLE?>"> 
			<?		} else { ?>
							<img src="images/default.jpg" alt="<?=$CLEAR_TITLE?>" width="32" height="32" border="0" onClick="form1.reset();">&nbsp;  
			<?		} ?> 
			<?	}	?>
<?
					// ส่วน เพิ่มเติมเฉพาะโปรแกรม ถ้ามี ตามตัวแปรชื่อ $arr_command_extend
                    if ($arr_command_extend) {
                    	for($ii = 0; $ii < count($arr_command_extend); $ii++) {
                            $arr_ret = explode("^",set_element($arr_command_extend[$ii]));
//							echo "1..(".substr($arr_ret[0],1)."||".$arr_ret[1].")";	// 0 เป็น tag 1 เป็น name replace @@
                            if (substr($arr_ret[1],0,5)=="func|") {	// ถ้าเป็น function ค่าพิเศษ ลงใน text หรือ label ธรรมดา
                                $arr_buff = explode("|",$arr_ret[1]);
                                $argu = (array) null;
//								echo ">>".$arr_buff[1].",".$arr_buff[2]."(".$arr_buff[2]."),".$arr_buff[3].",".$arr_buff[4]."<br>";
                                for($i=2; $i < count($arr_buff); $i++) {
                                    if (substr($arr_buff[$i],0,2)=="'@" && substr($arr_buff[$i],strlen($arr_buff[$i])-2,2)=="@'") {
                                        $argu[] = "'".${substr($arr_buff[$i],2,strlen($arr_buff[$i])-4)}."'";	// ค่าภายใน
//										echo "val1($i)=".${substr($arr_buff[$i],2,strlen($arr_buff[$i])-4)}."<br>";
                                    } else if (substr($arr_buff[$i],0,1)=="@" && substr($arr_buff[$i],strlen($arr_buff[$i])-1,1)=="@") {
                                        $argu[] = ${substr($arr_buff[$i],1,strlen($arr_buff[$i])-2)};	// ค่าภายใน
//										echo "val1($i)=".${substr($arr_buff[$i],1,strlen($arr_buff[$i])-2)}."<br>";
                                    } else {
                                        $argu[] = $arr_buff[$i];
//										echo "val2($i)=".$arr_buff[$i]."<br>";
                                    }
                                }
                                $ret = call_user_func_array($arr_buff[1], $argu);
//								echo ">>".$arr_buff[1]."(".implode(",",$argu).") ret=$ret<br>";
                                $elem_str = str_replace("@fvalue@", $ret, $arr_ret[0]);
                                if (strpos($elem_str,"hidden")===false) $spacing = "&nbsp;&nbsp;";  else $spacing = "";
                                echo $elem_str.$spacing;	// แสดง element ที่ได้
                            } else {	// เป็นค่าปกติ เพื่อย้ายเข้าไปใส่ค่าแทนใน value ใน element
                                $arr_argu = explode(",",$arr_ret[1]);
                                for($k=0; $k < count($arr_argu); $k++) {
                                    if (substr($arr_argu[$k],0,2)=="'@" && substr($arr_argu[$k],strlen($arr_argu[$k])-2)=="@'") {
                                        $nm = substr($arr_argu[$k],2,strlen($arr_argu[$k])-4);
//										echo "1..$k argu=".$arr_argu[$k].",nm=$nm (".trim($$nm).")<br>";
                                        $elem_str = str_replace(substr($arr_argu[$k],1,strlen($arr_argu[$k])-2), trim($$nm), $arr_ret[0]);
//										echo "1..$elem_str<br>";
                                    } else if (substr($arr_argu[$k],0,1)=="@" && substr($arr_argu[$k],strlen($arr_argu[$k])-1)=="@") {
                                        $nm = substr($arr_argu[$k],1,strlen($arr_argu[$k])-2);
//										echo "2..$k argu=".$arr_argu[$k].",nm=$nm (".trim($$nm).")<br>";
//										echo "2..".$arr_ret[0]."<br>";
                                        $elem_str = str_replace($arr_argu[$k], trim($$nm), $arr_ret[0]);
//										echo "2..$elem_str<br>";
                                    } else {
                                        if (is_null($$arr_argu[$k]) || $$arr_argu[$k]=="NULL") $val = ""; else $val = trim($$arr_argu[$k]);
//										echo "3..$k argu=".$arr_argu[$k].", (".trim($$arr_argu[$k])."), val=$val<br>";
                                        $elem_str = str_replace("@self@", $val, $arr_ret[0]);
                                    }
                                }
//								echo "1..".substr($elem_str,1)."<br>";
                                if (substr($elem_str,0,5)=="func_") {
                                    $f_agum = explode("(",substr($elem_str,5,strlen($elem_str)-6));
                                    call_user_func_array($f_agum[0], explode("|",$f_agum[1]));
//									echo "f_agum=".$f_agum[0]."|".$f_agum[1]."<br>";
//									echo "".$f_agum[0]."(".$f_agum[1].")";
                                } else {
                                    if (strpos($elem_str,"hidden")===false) $spacing = "&nbsp;&nbsp;";  else $spacing = "";
                                    echo $elem_str.$spacing;	// แสดง element ที่ได้
                                }
                            }
						}
                    }
?>
          </td>
        </tr>
        <tr>
         
        </tr>
      </table></td>
    </tr>
  </table>
  
  <? 
	if(!$sort_by) $sort_by=1;
	$sort_type = (isset($sort_type))?  $sort_type : "1:asc";
	$arrSort=explode(":",$sort_type);
	$SortType[$arrSort[0]]	=$arrSort[1];
	if(!$order_by) $order_by=1;

    for($i=0; $i < count($arr_col_search); $i++) {
//    	echo "$i-->".$arr_col_search[$i]."<br>";
		$sub_col_search = explode(",",$arr_col_search[$i]);
        $arr_sub_condition = (array) null;
        for($j=0; $j < count($sub_col_search); $j++) {
//        	echo "search_".$arr_fields[$sub_col_search[0]]."=".${"search_".$arr_fields[$sub_col_search[0]]}."||arr_c_srch_cond=".$arr_c_srch_cond[$i]."||sub_col_search [$j]=".$sub_col_search[$j]." <br>";
		  	if ( $arr_c_srch_cond[$i] == "<>" && ( trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}) || trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"})) ) {
				if (strtolower(substr($col_spec_datatype[$i],0,4))=="date") {
	                if (  trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}) && trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"}) ) {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." >= '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}))."' and ".$arr_fields[$sub_col_search[$j]]." <= '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"}))."')";
					} else if (  trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}) ) {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." >= '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}))."')";
                    } else {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." <= '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"}))."')";
                    }
				} else if ( (strpos($arr_fldtyp[$sub_col_search[$i]],"CHAR")!==false) || (strpos($arr_fldtyp[$sub_col_search[$i]],"DATE")!==false) ) {
                	if ($arr_fldlen[$sub_col_search[$i]]==19 && !(valid_char19_date_ddmmyyyy(trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}))=="NO"))	// เป็น DATE
                    	$d_min = save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}));
					else  $d_min = trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"});
                	if ($arr_fldlen[$sub_col_search[$i]]==19 && !(valid_char19_date_ddmmyyyy(trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"}))=="NO"))	// เป็น DATE
                    	$d_max = save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"}));
					else  $d_max = trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"});
                    if ( $d_min && $d_max ) {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." >= '".$d_min."' and ".$arr_fields[$sub_col_search[$j]]." <= '".$d_max."')";
					} else if (  $d_min ) {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." >= '".$d_min."')";
                    } else {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." <= '".$d_max."')";
                    }
                } else {
	                if(  trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}) && trim(${"search_".$arr_fields[$sub_col_search[0]]."_max"}) ) {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." >= ".${"search_".$arr_fields[$sub_col_search[0]]."_min"}." and ".$arr_fields[$sub_col_search[$j]]." <= ".${"search_".$arr_fields[$sub_col_search[0]]."_max"}.")";
					} else if (  trim(${"search_".$arr_fields[$sub_col_search[0]]."_min"}) ) {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." >= ".${"search_".$arr_fields[$sub_col_search[0]]."_min"}.")";
                    } else {
						$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." <= ".${"search_".$arr_fields[$sub_col_search[0]]."_max"}.")";
					}
				}
			} else if (trim( ${"search_".$arr_fields[$sub_col_search[0]]} )) {	// ชื่อใน form จะตั้งตามตัวหน้า [0] ดังนั้น จึงใช้ค่า value ใน [0]
            	if ($arr_c_srch_cond[$i] == "%%") {
	            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." like '%".${"search_".$arr_fields[$sub_col_search[0]]}."%')";
//	            	$a = "(".$arr_fields[$sub_col_search[$j]]." like '%".${"search_".$arr_fields[$sub_col_search[0]]}."%')";
//					echo "$a<br>";
            	} else if ($arr_c_srch_cond[$i] == "%")
	            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." like '".${"search_".$arr_fields[$sub_col_search[0]]}."%')";
            	else if ($arr_c_srch_cond[$i] == "!=" || $arr_c_srch_cond[$i] == "<=" || $arr_c_srch_cond[$i] == ">=")
                    if (strtolower(substr($col_spec_datatype[$i],0,4))=="date") {
		            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]}))."')";
                	} else if ((strpos($arr_fldtyp[$sub_col_search[$j]],"CHAR")!==false) || (strpos($arr_fldtyp[$sub_col_search[$j]],"DATE")!==false))
	                	if ($arr_fldlen[$sub_col_search[$j]]==19 && !(valid_char19_date_ddmmyyyy(trim(${"search_".$arr_fields[$sub_col_search[0]]}))=="NO"))	// เป็น DATE
			            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]}))."')";
						else
			            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".trim(${"search_".$arr_fields[$sub_col_search[0]]})."')";
					else
		            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." ".${"search_".$arr_fields[$sub_col_search[0]]}.")";
            	else if ($arr_c_srch_cond[$i] == "=" || $arr_c_srch_cond[$i] == "<" || $arr_c_srch_cond[$i] == ">") {
//                	echo "col_search[$j]::(".$sub_col_search[$j].")-".$arr_fldtyp[$sub_col_search[$j]].", check CHAR :: ".strpos($arr_fldtyp[$sub_col_search[$j]],"CHAR").", check DATE :: ".strpos($arr_fldtyp[$sub_col_search[$j]],"DATE")."<br>";
                    if (strtolower(substr($col_spec_datatype[$i],0,4))=="date") {
		            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]}))."')";
                	} else if ((strpos($arr_fldtyp[$sub_col_search[$j]],"CHAR")!==false) || (strpos($arr_fldtyp[$sub_col_search[$j]],"DATE")!==false)) {
	                	if ($arr_fldlen[$sub_col_search[$j]]==19 && !(valid_char19_date_ddmmyyyy(trim(${"search_".$arr_fields[$sub_col_search[0]]}))=="NO"))	// เป็น DATE
			            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".save_date(trim(${"search_".$arr_fields[$sub_col_search[0]]}))."')";
						else
			            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".trim(${"search_".$arr_fields[$sub_col_search[0]]})."')";
//						echo "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." '".${"search_".$arr_fields[$sub_col_search[0]]}."')";
					} else {
		            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." ".${"search_".$arr_fields[$sub_col_search[0]]}.")";
//						echo "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." ".${"search_".$arr_fields[$sub_col_search[0]]}.")";
					}
				}
			} else if (trim( ${"search_".$arr_fields[$sub_col_search[0]]} == "0" )) {	// check ค่า value เป็น "0"
//            	echo "ค่า value เป็น 0<br>";
            	$arr_sub_condition[] = "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." ".${"search_".$arr_fields[$sub_col_search[0]]}.")";
//				echo "(".$arr_fields[$sub_col_search[$j]]." ".$arr_c_srch_cond[$i]." ".${"search_".$arr_fields[$sub_col_search[0]]}.")";
//			} else {
 //           	echo "ค่า value เป็น ไม่มีค่า<br>";
			}
		} // end for loop $j
        if (count($arr_sub_condition) > 0)	$arr_search_condition[] = "(".implode(" or ",$arr_sub_condition).")";
	} // end for loop $i

// 	if(trim($search_name)) $arr_search_condition[] = "($arr_fields[1] like '%$search_name%')";
	$search_condition = "";
	if(count($arr_search_condition)) $search_condition = ($f_condition ? " where ".$f_condition." and " : " where ") . implode(" and ", $arr_search_condition);
//	echo "search_condition=$search_condition<br>";

?>
	<input type="hidden" name="search_condition" value="<?=$search_condition?>">
<?
	for($ii = 0; $ii < count($tab_sort); $ii++) {
    	if ($tab_sort[$ii]==1) {
            if ($order_by==1){	//(ค่าเริ่มต้น) ลำดับที่
            	if ($seq_order_index)
	                $order_str = "".$arr_fields[$seq_order_index]." ".$SortType[$order_by].", ".$arr_fields[$key_index]." ".$SortType[$order_by];
				else
	                $order_str = "".$arr_fields[$key_index]." ".$SortType[$order_by];
			} else if ($order_by > 1){
				$order_str = "".$arr_fields[$col_map[($order_by-1)]]." ".$SortType[$order_by];
            }
//			echo "order_by=$order_by, order_str=$order_str<br>";
            break;
		}    	
    }

	$cmd =" select count($arr_fields[$key_index]) as count_data from $table $search_condition ";
	$db_dpis->send_cmd($cmd);
//	$db_dpis->show_error();
	$data = $db_dpis->get_array();
	$data = array_change_key_case($data, CASE_LOWER);
	$count_data = $data[count_data];
//	echo "$cmd ($count_data)<br>";
  ?>
  <table width="90%" align="center" cellpadding="0" cellspacing="0">
  	<tr>
	  <td><table width="15%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
		  <tr>
		  	<td height="22" align="center" class="table_body"><?=$SEARCH_TITLE?></td>
		  </tr>		
	  </table></td>
	</tr>
  </table>
  <table width="90%" align="center"  border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td align="center" class="input_table"><table width="100%"  border="0" cellpadding="0" cellspacing="0" class="label_normal">
<?
				foreach($arr_search_rc as $key1 => $arr_col) {
?>
					<tr>
<?
					foreach($arr_col as $key2 => $value) {
//            			echo "2 value=$value<br>";
            			$arr_elem = explode("^",$value);
                        $w = ($arr_search_col_perc_w[$key2] ? "width='".$arr_search_col_perc_w[$key2]."'" : "");
                        $a = ($arr_search_col_align[$key2] ? $arr_search_col_align[$key2] : "left");
?>
						<td <?=$w?> align="<?=$a?>">
<?
		                for($ii = 0; $ii < count($arr_elem); $ii++) {
							$arr_ret = explode("^",set_element($arr_elem[$ii]));
//							echo "2..(".substr($arr_ret[0],1)."||".$arr_ret[1].")";
							if (substr($arr_ret[1],0,5)=="func|") {	// ถ้าเป็น function ค่าพิเศษ ลงใน text หรือ label ธรรมดา
                                $arr_buff = explode("|",$arr_ret[1]);
                                $argu = (array) null;
//								echo ">>".$arr_buff[1].",".$arr_buff[2]."(".$arr_buff[2]."),".$arr_buff[3].",".$arr_buff[4]."<br>";
                                for($i=2; $i < count($arr_buff); $i++) {
                                    if (substr($arr_buff[$i],0,2)=="'@" && substr($arr_buff[$i],strlen($arr_buff[$i])-2,2)=="@'") {
                                        $argu[] = "'".${substr($arr_buff[$i],2,strlen($arr_buff[$i])-4)}."'";	// ค่าภายใน
//										echo "val1($i)=".${substr($arr_buff[$i],2,strlen($arr_buff[$i])-4)}."<br>";
                                    } else if (substr($arr_buff[$i],0,1)=="@" && substr($arr_buff[$i],strlen($arr_buff[$i])-1,1)=="@") {
                                        $argu[] = ${substr($arr_buff[$i],1,strlen($arr_buff[$i])-2)};	// ค่าภายใน
//										echo "val1($i)=".${substr($arr_buff[$i],1,strlen($arr_buff[$i])-2)}."<br>";
                                    } else {
                                        $argu[] = $arr_buff[$i];
//										echo "val2($i)=".$arr_buff[$i]."<br>";
                                    }
                                }
                                $ret = call_user_func_array($arr_buff[1], $argu);
//								echo ">>".$arr_buff[1]."(".implode(",",$argu).") ret=$ret<br>";
                                $elem_str = str_replace("@fvalue@", $ret, $arr_ret[0]);
                                echo $elem_str."&nbsp;&nbsp;";	// แสดง element ที่ได้
                            } else {	// เป็นค่าปกติ เพื่อย้ายเข้าไปใส่ค่าแทนใน value ใน element
                                $arr_argu = explode(",",$arr_ret[1]);
                                for($k=0; $k < count($arr_argu); $k++) {
                                    if (substr($arr_argu[$k],0,2)=="'@" && substr($arr_argu[$k],strlen($arr_argu[$k])-2)=="@'") {
                                        $nm = substr($arr_argu[$k],2,strlen($arr_argu[$k])-4);
                                        $elem_str = str_replace(substr($arr_argu[$k],1,strlen($arr_argu[$k])-2), trim($$nm), $arr_ret[0]);
                                    } else if (substr($arr_argu[$k],0,1)=="@" && substr($arr_argu[$k],strlen($arr_argu[$k])-1,1)=="@") {
                                        $nm = substr($arr_argu[$k],1,strlen($arr_argu[$k])-2);
                                        $elem_str = str_replace($arr_argu[$k], trim($$nm), $arr_ret[0]);
                                    } else {
                                        $elem_str = str_replace("@self@", trim($$arr_argu[$k]), $arr_ret[0]);
                                    }
                                }
//								echo "2..".substr($elem_str,1)."<br>";
                                if (substr($elem_str,0,5)=="func_") {
                                    $f_agum = explode("(",substr($elem_str,5,strlen($elem_str)-6));
                                    call_user_func_array($f_agum[0], explode("|",$f_agum[1]));
//									echo "f_agum=".$f_agum[0]."|".$f_agum[1]."<br>";
//									echo "".$f_agum[0]."(".$f_agum[1].")";
                                } else {
                                    echo $elem_str."&nbsp;&nbsp;";	// แสดง element ที่ได้
//									echo substr($elem_str,1);
                                }
							}
						} // for loop detail
?>
						</td>
<?
					} // for loop columns
?>
					</tr>
<?
				} // for loop rows
?>
			<tr>
              <td width="100%" colspan="<?=count($arr_search_col_perc_w)?>" align="center">
		  	  <? if ($BUTTON_DISPLAY==1) { ?>
			  <input name="search_btn" type="submit" class="button" value="<?=$SEARCH_TITLE?>" onClick="form1.current_page.value=0;">
			  <input name="search_all_btn" type="submit" class="button" value="<?=$SHOW_ALL_TITLE?>" onClick="call_search_all();">
    	  	  <? } else { ?>
			  <input type="image" src="images/search.png" alt="<?=$SEARCH_TITLE?>" onClick="javascript:form1.current_page.value=0;">
			  <input type="image" src="images/showall.png" alt="<?=$SHOW_ALL_TITLE?>" onClick="javascript:call_search_all();">
      		  <? } ?> 
			  </td>
            </tr>
          </table></td>
        </tr>
	 <tr><td><input type="hidden" name="order_by" value="<?=$order_by?>">
	     <input type="hidden" name="sort_by" value="<?=$sort_by;?>">
         <input type="hidden" name="sort_type" value="<?=$sort_type?>">
<?=$SORT_TITLE?></td>
	 </tr>
		<tr>
		  <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="table_body_3">
	<? if ($REPORT_GEN==1) { ?>
    		<tr><td align="center" colspan="3">
				<input name="bt_adjust" type="button" class="button" value="<?=$REPORT_FORMAT_TITLE?>" onClick="call_adjust();">&nbsp; &nbsp;
			</td></tr>
	<? } ?>
            <tr>
              <td width="26%" height="22">
				<? if($PAGE_AUTH["print"]=="Y"){ ?>
              		<? if ($BUTTON_DISPLAY==1) { ?>
						<input name="btn_report" type="button" class="button" style="width:150" value="<?=$PDF_TITLE?>" onClick="call_rtf_pdf_report('<?=$r_title?>',0);">
							<? if ($RTF_FLAG==1) { ?>
                      <input name="btn21" type="button" class="button" style="width:150" value="<?=$RTF_TITLE?>" onClick="call_rtf_pdf_report('<?=$r_title?>',1);">
	                    <? } ?>
					<? } else { ?>
					   <img src="images/doc_icon_pdf.jpg" border="0" alt="<?=$PDF_TITLE?>" onClick="call_rtf_pdf_report('<?=$r_title?>',0);">
							 <? if ($RTF_FLAG==1) { ?>
                     <img src="images/doc_icon_word.jpg" border="0" alt="<?=$RTF_TITLE?>" onClick="call_rtf_pdf_report('<?=$r_title?>',1);">
	                         <? } ?>
					<? } ?>
                <? } else { echo "&nbsp;"; } ?>
			  </td>
              <td width="59%" align="center">พบข้อมูลทั้งสิ้น <?=($count_data + 0)?> รายการ</td>
              <td width="15%" align="right">
              	<? if($PAGE_AUTH["print"]=="Y"){ ?>  
                	<? if ($BUTTON_DISPLAY==1) { ?>
							<input name="btn_export" type="button" class="button" style="width:130" value="<?=$EXCEL_TITLE?>" onClick="call_export_file('<?=$r_title?>');">
					<? } else { ?>
							<img src="images/doc_icon_excel.jpg" border="0" alt="<?=$EXCEL_TITLE?>" onClick="call_export_file('<?=$r_title?>');">
					<? } ?>
				<? }else{ echo "&nbsp;"; } ?>
              </td>
            </tr>
          </table></td>
		</tr>
  </table>  
  <?
	$total_page = ceil( $count_data / $data_per_page );
	$page_link = create_link_page($total_page, $current_page);
	$limit_data = "";

	if($current_page > 1){
			if($DPISDB=="odbc"){
				$cmd = " select top $start_record $arr_fields[0] from $table $search_condition order by $arr_fields[0] ";
				$db_dpis->send_cmd($cmd);
				while($data = $db_dpis->get_array()) $arr_exclude[] = "'".$data[$arr_fields[0]]."'";
				$limit_data = (trim($search_condition)?" and ":" where ")." $arr_fields[0] not in (". implode(", ", $arr_exclude) .")";
//			}elseif($DPISDB=="oci8"){		
//				$limit_data = (trim($search_condition)?" and ":" where ")." $arr_fields[0] not in ( select * from (select $arr_fields[0] from $table $search_condition order by $arr_fields[0]) where rownum <= $start_record ) ";
			}else if($DPISDB=="mysql"){
				$limit_data = " limit " . (($current_page - 1) * $data_per_page) . ", " . $data_per_page;
			} // end if
	} // end if 

	if($DPISDB=="odbc"){
		$cmd = "	select		top $data_per_page  *
							from		$table
							$search_condition
							$limit_data
							order by $order_str ";
	}elseif($DPISDB=="oci8"){
		$cmd = "		select		*
								from		$table
								$search_condition
								order by $order_str ";

        $rec_start = (($current_page-1) * $data_per_page) + 1;
        $rec_end = ($current_page > 1)? ($current_page * $data_per_page) : $data_per_page;
        $cmd = "select * from (
                           select rownum rnum, q1.* from ( 
                                $cmd
                           )  q1
                    ) where rnum between $rec_start and $rec_end  ";

	}elseif($DPISDB=="mysql"){
		$cmd = "	select		*
							from		$table
							$search_condition
							group by $order_str
							$limit_data ";
	} // end if
	
//	print_r($arr_fields);
	$count_page_data = $db_dpis->send_cmd($cmd);
//	echo "page cmd=>$cmd ($count_page_data)<br>";
//	$db_dpis->show_error();
	if ($count_page_data) {
		$current_list = "";
		$data_count = 0;
?>
  <table width="90%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
    <tr align="center" class="table_head">
<?
		for($i = 0; $i < count($tab_head); $i++) {
			if (($tab_head[$i]==$EDIT_TITLE || $tab_head[$i]==$DEL_TITLE) && $PAGE_AUTH["edit"]!="Y") {
            	// skip
                $a = 0;
            } else {
                $sortstr1 = (($tab_sort[$i]==1) ? "onClick='call_sort(".($i+1).");'" : "");
                $sortstr2 = (($tab_sort[$i]==1) ? (($order_by==($i+1)&&$sort_by==($i+1)) ? (($SortType[$order_by]=='asc') ? $SORT_ASC : $SORT_DESC) : $SORT_CUR) : "");
                $w = ($tab_width[$i] ? "width='".$tab_width[$i]."'" : "");
//				echo "($order_by) ($sort_by) sortstr1=$sortstr1, sortstr2=$sortstr2<br>";
?>
				<td nowrap <?=$w?> <?=$sortstr1?>><strong><?=$sortstr2?><?=$tab_head[$i]?></strong></td>
<?
			}
        }
?>
    </tr>
<?
	while ($data = $db_dpis->get_array()) {
		$data_count++;
		if($data_count > $data_per_page) break;
        for($ii = 0; $ii < count($arr_fields); $ii++) {
            if ($ii==$key_index) {
//				if (strtolower(substr($col_spec_datatype[$key_index],0,4))=="date") {
//					$date_formno = substr($col_spec_datatype[$key_index],4);
				if ( strpos($arr_fldtyp[$key_index],"CHAR")!==false && $arr_fldlen[$key_index]==19 && valid_char19_date_yyyymmdd(trim($data[$arr_fields[$key_index]]))!="NO" ) {
					${"temp_".$arr_fields[$key_index]} = show_date_format(trim($data[$arr_fields[$key_index]]),($date_formno ? $date_formno : 1));
				} else {
	                ${"temp_".$arr_fields[$key_index]} = $data[$arr_fields[$key_index]];
				}
                $current_list .= ((trim($current_list))?", ":"") . "'" . ${"temp_".$arr_fields[$key_index]} ."'";
			} else if ($arr_fields[$ii]!="UPDATE_USER" && $arr_fields[$ii]!="UPDATE_DATE") {
//				if (strtolower(substr($col_spec_datatype[$ii],0,4))=="date") {
//					$date_formno = substr($col_spec_datatype[$ii],4);
				if ( strpos($arr_fldtyp[$ii],"CHAR")!==false && $arr_fldlen[$ii]==19 && valid_char19_date_yyyymmdd(trim($data[$arr_fields[$ii]]))!="NO" ) {
					${"temp_".$arr_fields[$ii]} = show_date_format(trim($data[$arr_fields[$ii]]),($date_formno ? $date_formno : 1));
				} else {
					${"temp_".$arr_fields[$ii]} = $data[$arr_fields[$ii]];
				}
			}
		}		
		$index_type = (strpos($arr_fldtyp[$key_index],"CHAR")!==false ? "c" : "n");
		$class = "table_body";
		$onmouse_event = " onMouseOver=\"this.className='table_body_over';\" onMouseOut=\"this.className='table_body';\" ";
        if (strpos($arr_fldtyp[$key_index],"CHAR")!==false) { 	// 	เป็น charecter
            if("".$$arr_fields[$key_index]=="".${"temp_".$arr_fields[$key_index]}){ 
//		       	echo "str..$key_index--".$$arr_fields[$key_index]."==".${"temp_".$arr_fields[$key_index]}."<br>";
                $class = "table_body_over";
                $onmouse_event = "";
            } // end if
		} else {	// เป็นตัวเลข
            if($$arr_fields[$key_index]==${"temp_".$arr_fields[$key_index]}){ 
//		       	echo "num..$key_index--".$$arr_fields[$key_index]."==".${"temp_".$arr_fields[$key_index]}."<br>";
                $class = "table_body_over";
                $onmouse_event = "";
            } // end if
        }
?>
    <tr class="<?=$class?>" <?=$onmouse_event?>>
<?
		for($ii = 0; $ii < count($tab_head); $ii++) {
        	if ($seq_order_index && $col_map[$ii]==$seq_order_index) { // map ORDER
            	$a = (!$tab_align[$ii]) ? "left" : $tab_align[$ii];
?>
				<td height="25" align="<?=$a?>"><input name="ARR_ORDER[<?=${"temp_".$arr_fields[$key_index]}?>]" type="text" size="5" maxlength="3" value="<?=(${"temp_".$arr_fields[$seq_order_index]} > 0)?${"temp_".$arr_fields[$seq_order_index]}:""?>" style="text-align:right" onKeyPress="return NumOnly();" class="TextBox"></td>
<?
			} else if ($active_index && $col_map[$ii]==$active_index) { // map ACTIVE
            	$a = (!$tab_align[$ii]) ? "left" : $tab_align[$ii];
?>
				<td align="<?=$a?>"><input type="checkbox" name="list_show_id[]" value="'<?=trim(${"temp_".$arr_fields[$key_index]})?>'" <?=((${"temp_".$arr_fields[$active_index]}==1)?"checked":"")?>></td>
<? 
           } else if ($col_map[$ii]==-1) { // map $EDIT_TITLE || $DEL_TITLE
//         		echo " col_map=".$col_map[$ii]." head=".$tab_head[$ii]."  can edit=".$PAGE_AUTH["edit"]."<br>";
			  	if ($tab_head[$ii]==$EDIT_TITLE && $PAGE_AUTH["edit"]=="Y") {
?>
					<td align="center">&nbsp;<a href="<?=("javascript:form1.action+='?UPD=1';form1.".$arr_fields[$key_index].".value='".${"temp_".$arr_fields[$key_index]}."';form1.submit()")?>"><img src="images/b_edit.png" border="0" alt="แก้ไขข้อมูล"></a></td>
<?
				}
				if($tab_head[$ii]==$DEL_TITLE && $PAGE_AUTH["del"]=="Y") {
?>
					<td align="center">&nbsp;<a href="<?=("javascript:confirm_delete('".${"temp_".$arr_fields[$key_index]}."','".${"temp_".$arr_fields[$name_index]}."')")?>"><img src="images/b_drop.png" border="0" alt="ลบข้อมูล"></a></td>
<?
				}
           } else {
            	$a = (!$tab_align[$ii]) ? "left" : $tab_align[$ii];
                if ($col_map[$ii]==$key_index) {
//					if (strtolower(substr($col_spec_datatype[$ii],0,4))=="date") {
//						$date_formno = substr($col_spec_datatype[$ii],4);
//					if ( strpos($arr_fldtyp[$key_index],"CHAR")!==false && $arr_fldlen[$key_index]==19 && valid_char19_date_yyyymmdd(trim($data[$arr_fields[$key_index]]))!="NO" ) {
//						$vdisplay = show_date_format(${"temp_".$arr_fields[$key_index]},($date_formno ? $date_formno : 1));
//					} else {
                    	$vdisplay = ${"temp_".$arr_fields[$key_index]};
//					}
?>
					<td align="<?=$a?>">&nbsp;<?=$vdisplay?></td>
<?
				} else {
					$vdisplay = ${"temp_".$arr_fields[$col_map[$ii]]};
					// ถ้าเป็น field ที่มี ค่า ขยายความ
					if ($col_datalink[$ii]) {
						$sub_dlink = explode("|",$col_datalink[$ii]);
						if ($sub_dlink[0]=="code2show") {
                        	$arr_b = (array) null;
                            for($kk = 1; $kk < count($sub_dlink); $kk++) {
								$s_sub_dlink = explode(",",$sub_dlink[$kk]);
                            	$arr_b[$s_sub_dlink[0]] = $s_sub_dlink[1];
                            }
//							echo "code2show=>".implode(":",$arr_b)." (".${"temp_".$arr_fields[$col_map[$ii]]}.")<br>";
							${"temp_".$arr_fields[$col_map[$ii]]} = $arr_b[${"temp_".$arr_fields[$col_map[$ii]]}];
						} else if ($sub_dlink[0]=="columnlink") {
                        	$tab = $sub_dlink[1];
                        	$arr_colsel = explode(",",$sub_dlink[2]);		// List ของชื่อ column ที่ต้องการ
                        	$arr_condi = explode(",",$sub_dlink[3]);			// List ของตัวแปรที่ใช้ในเงื่อนไข
                        	$arr_output = explode(",",$sub_dlink[4]);		// List ของตัวแปรที่ใช้เก็บข้อมูลที่อ่านได้
                        	$wherecondition = $sub_dlink[5];
                            for($jj=count($arr_condi)-1; $jj >= 0 ; $jj--) {
                            	$varname = "var".($jj+1);
								if ( valid_char19_date_ddmmyyyy(trim($$arr_condi[$jj]))!="NO" )
                                    $wherecondition = str_replace($varname, save_date(trim($$arr_condi[$jj])), $wherecondition);
								else
                                    $wherecondition = str_replace($varname, trim($$arr_condi[$jj]), $wherecondition);
                            }
                            $sql = " select  ".$sub_dlink[2]." from ".$tab.($wherecondition ? " where ".$wherecondition : "");
                       		$db_dpis1->send_cmd($sql);
                            $data1 = $db_dpis1->get_array();
//							echo "sql=$sql<br>";
                            for($jj=0; $jj < count($arr_output); $jj++) {
								if ( valid_char19_date_yyyymmdd(trim($data1[$arr_colsel[$jj]]))!="NO" )
		                            $$arr_output[$jj] = show_date_format($data1[$arr_colsel[$jj]],1);	// select column move to output
								else
		                            $$arr_output[$jj] = $data1[$arr_colsel[$jj]];	// select column move to output
//								echo ">>output=".$arr_output[$jj]." | ".$arr_fields[$col_map[$ii]]."<br>";
							}
						}
                       	$vdisplay = ${"temp_".$arr_fields[$col_map[$ii]]};
					} // end if ($col_datalink[$ii])
?>
<!--				<td align="<?=$a?>">&nbsp;<?=${"temp_".$arr_fields[$col_map[$ii]]}?></td>-->
					<td align="<?=$a?>">&nbsp;<?=$vdisplay?></td>
<?
				}
           }
        } // end for loop
?>
	</tr>
<? 
	} // end while
    
    
	if ($PAGE_AUTH["edit"]=="Y") { ?>
    <tr class="table_footer">
<?
		for($ii = 0; $ii < count($tab_head); $ii++) {
        	if ($seq_order_index && $col_map[$ii]==$seq_order_index) { // map ORDER
				if ($BUTTON_DISPLAY==1) {
?>
			        <td><input type="submit" name="Submit3" value="<?=$REORDER_TITLE?>" onClick="form1.command.value='REORDER'" class="button" style="width:98%"></td>
<?  			} else { 			?>
			        <td><center>
						<input name="image" type="image" onClick="form1.command.value='REORDER'" src="images/reorder.gif" alt="<?=$REORDER_TITLE?>" border="0">
       				</center></td>
<? 
				} 
           } else if ($active_index && $col_map[$ii]==$active_index) { // map ACTIVE
				if ($BUTTON_DISPLAY==1) {
?>
					<td><input type="submit" name="Submit4" value="<?=$SETFLAG_TITLE?>" onClick="form1.command.value='SETFLAG'" class="button" style="width:98%"></td>
<?			} else { 			?>
					<td><input name="image2" type="image" onClick="form1.command.value='SETFLAG'" src="images/save.png" alt="<?=$SETFLAG_TITLE?>" border="0"></td>
<?
				}
           } else if ($col_map[$ii]==-1) { // map $EDIT_TITLE || $DEL_TITLE
			  	if ($tab_head[$ii]==$EDIT_TITLE && $PAGE_AUTH["edit"]=="Y") {
?>
					<td>&nbsp;</td>
<?
				}
				if($tab_head[$ii]==$DEL_TITLE && $PAGE_AUTH["del"]=="Y") {
?>
					<td>&nbsp;</td>
<?
				}
           } else {
?>
				<td>&nbsp;</td>
<?
           }
        } // end for loop
?>
	</tr>
<?
	} // end if ($PAGE_AUTH["edit"]=="Y")
?>
  </table>
	<? if($total_page > 1) : ?>
  	<table width="90%" border="0" align="center" cellpadding="2" cellspacing="2" class="label_normal">
    	<tr>
      		<td><?=$page_link?></td>
    	</tr>
  	</table>
  	<? endif; ?>&nbsp;
<? 
  } // if  count show 
?>
  			<input type="hidden" name="current_list" value="<?=$current_list?>">
        </form>		
		</td>
	</tr>
<?
} // end if error
?>
</table>
<?
	include("jqModalDialog.html");
?>
</body>
<script language="JavaScript" src="java_scripts/menu_layer.js"></script>
<script type="text/javascript">
setActiveStyleSheet(document.getElementById("defaultTheme"), "winter");
</script>
</html>
