<?
if (version_compare(PHP_VERSION, '5.4.0', '>=')) {
  ob_start(null, 0, PHP_OUTPUT_HANDLER_STDFLAGS ^
    PHP_OUTPUT_HANDLER_REMOVABLE);
} else {
  ob_start(null, 0, false);
}
	include("../php_scripts/connect_database.php");
	include("../php_scripts/calendar_data.php");
	include("php_scripts/personal_absentsum.php");
	include("php_scripts/load_per_control.php");

	$cmd =" select 		count(AS_ID) as count_data 
					from 		PER_ABSENTSUM
					where		PER_ID=$PER_ID ";
	$db_dpis->send_cmd($cmd);
//	$db_dpis->show_error();
	$data = $db_dpis->get_array();
	$data = array_change_key_case($data, CASE_LOWER);
	$count_data = $data[count_data];

	$total_page = ceil( $count_data / $data_per_page );
	$page_link = create_link_page($total_page, $current_page);
	$limit_data = "";	
?>
<html>
<head>
<title><?=$webpage_title?> - <?=$MENU_TITLE_LV0?><?if($MENU_ID_LV1){?> - <?=$MENU_TITLE_LV1?><?}?><?if($MENU_ID_LV2){?> - <?=$MENU_TITLE_LV2?><?}?><?if($MENU_ID_LV3){?> - <?=$MENU_TITLE_LV3?><?}?></title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-874">
<link rel="stylesheet" href="<?=$cssfileselected?>" type="text/css">
<link rel="alternate stylesheet" type="text/css" media="all" href="stylesheets/calendar-blue.css" title="winter"/>
</head>
<script type="text/javascript" src="java_scripts/chk_date.js"></script>
<script type="text/javascript" src="java_scripts/calendar.js"></script>
<script type="text/javascript" src="java_scripts/calendar-th.js"></script> 
<script type="text/javascript" src="java_scripts/function_utility.js"></script> 
<script language="JavaScript">
	function change_current_page( page ){
		form1.current_page.value = page;
		form1.submit();
	}
	
	function changedateformat(name,str) {
		var arr = str.split('/');
		if((str) && (str != arr[0]+'/'+arr[1]+'/'+arr[2])){
			name.value = str.substr(0,2) + "/" + str.substr(2,2) + "/"  + str.substr(4,4) ;
		}
		chk_date(name, "BDH");
	}
	
	function confirm_delete(as_id , ex_name){
		if(confirm("ต้องการลบสรุปวันลาสะสมนี้ ใช่หรือไม่ [ " + ex_name + " ]?")){
			form1.command.value = "DELETE";
			form1.AS_ID.value = as_id;
			form1.submit();
		} // end if
	}
	
	function call_menu_desc (cate, id, name, per_id) {	
		var ulink = cfile+'?CATEGORY='+cate+'&PER_ID='+ per_id+'&UPFOR='+name+'&LAST_SUBDIR='+id;		
		parameter = "";
		window.open(ulink+"&MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>&HIDE_HEADER=1<?=($MAIN_VIEW?"&MAIN_VIEW=1":"")?>&getdate=<?=date('YmdHis')?>" + parameter,'moreeditor','toolbar=no,location=no,status=yes,menubar=no,scrollbars=yes,resizable=yes,width=950,height=1200');
	}

	function checkadd(f) {
		if(f.AS_YEAR.value=="") {
			alert("กรุณาระบุ รายการสรุปวันลาสะสม");
			f.AS_YEAR.focus();
			return false;
		} else {
			form1.command.value='ADD';
//			form1.submit();
			return true;
		}
	}
	
	function checkupdate(f) {
		if(f.AS_YEAR.value=="") {
			alert("กรุณาระบุ รายการสรุปวันลาสะสม");
			f.AS_YEAR.focus();
			return false;
		} else {
			form1.command.value='UPDATE';
//			form1.submit();
			return true;
		}
	}
	
	function setLayer(layerID){
		if(document.getElementById(layerID)){
			if(document.getElementById(layerID).style.display=='none'){
				document.getElementById(layerID).style.display='block';	
			}else{
				document.getElementById(layerID).style.display='none';
			}
			if(document.getElementById(layerID).style.visibility=='hidden'){
				document.getElementById(layerID).style.visibility='visible';
			}else{
				document.getElementById(layerID).style.visibility='hidden';
			}
		}
	}

	function call_sort(flag) {
		form1.order_by.value=flag;		form1.sort_by.value=flag;
		if(form1.sort_type.value==flag+":asc"){
			form1.sort_type.value=flag+":desc";
		}else{ //desc
			form1.sort_type.value=flag+":asc";
		}		
		form1.command.value='SEARCH';
		form1.submit();
	} // end function call_sort

	function set_check_all(ischecked,name,count_data){
		for(var i=1; i <= count_data; i++){	
			if(ischecked==true){
				if(eval(document.getElementById(name+i)))	eval(document.getElementById(name+i)).checked=true;
			}else{
				if(eval(document.getElementById(name+i)))	eval(document.getElementById(name+i)).checked=false;
			}
		}
	}
	
	function set_uncheck_all(ischecked,name,id){
		if(ischecked==false && name.checked==true)		name.checked=false;
	}

	function returnFrom(src, returnValue){
//		alert("src="+src+"("+returnValue+")");
		 if  (src.indexOf("search_org") > -1) {
			if(returnValue){
				arrValue = returnValue.split("<::>");
				if (arrValue[7]=="search_ministry") {
					form1.CH_MINISTRY_ID.value = arrValue[0];
					form1.MINISTRY_NAME.value = arrValue[1];
					form1.CH_DEPARTMENT_ID.value = "";
					form1.DEPARTMENT_NAME.value = "";
					form1.CH_ORG_ID.value = "";
					form1.ORG_NAME.value = "";
					form1.CH_ORG_ID_1.value = "";
					form1.ORG_NAME_1.value = "";
				} else if (arrValue[7]=="search_department") {
					form1.CH_DEPARTMENT_ID.value = arrValue[0];
					form1.DEPARTMENT_NAME.value = arrValue[1];
					form1.CH_ORG_ID.value = "";
					form1.ORG_NAME.value = "";
					form1.CH_ORG_ID_1.value = "";
					form1.ORG_NAME_1.value = "";
				} else if (arrValue[7]=="search_org") {
					form1.CH_ORG_ID.value = arrValue[0];
					form1.ORG_NAME.value = arrValue[1];
					form1.CH_ORG_ID_1.value = "";
					form1.ORG_NAME_1.value = "";
				} else if (arrValue[7]=="search_org1") {
					form1.CH_ORG_ID_1.value = arrValue[0];
					form1.ORG_NAME_1.value = arrValue[1];
				}
			} // end if
		} else if  (src.indexOf("search_province") > -1) {
			if(returnValue){
				arrValue = returnValue.split("<::>");
				form1.CH_PROVINCE_CODE.value = arrValue[0];
				form1.PROVINCE_NAME.value = arrValue[1];
			} // end if
		} 		
//		$( "#d_frame" )[0].src="";
//		alert("returnValue="+tt.value);
		tt.value = returnValue;
	} // end if
	
</script>
<?php


function countofyear($db_dpis2,$PER_ID,$AS_YEAR){
    $cmdcnt ="select sum(q1.pakpon_abs) AS CNTOFYEAR from (
                WITH
                    AllWorkDay As
                    (
                      select * from (
                        select x.*,(case when TO_CHAR(TO_DATE(x.LISTDATE,'YYYY-MM-DD'), 'DY', 'NLS_DATE_LANGUAGE=ENGLISH') IN ('SAT', 'SUN') then 1 else
                          case when exists (select null from PER_HOLIDAY where HOL_DATE = x.LISTDATE) then 1 else 0 end end) HOL
                        from (
                          select to_char(LISTDATE,'YYYY-MM-DD') LISTDATE from (
                                SELECT (TO_DATE((LEAST((select trim(min(ABS_STARTDATE)) from PER_ABSENTHIS where ABS_STARTDATE is not null and PER_ID=$PER_ID),
                                      (select trim(min(START_DATE)) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID))
                                ), 'YYYY-MM-DD'))-1+rownum AS LISTDATE FROM all_objects
                                 WHERE (TO_DATE((LEAST((select trim(min(ABS_STARTDATE)) from PER_ABSENTHIS where ABS_STARTDATE is not null and PER_ID=$PER_ID),
                                      (select trim(min(START_DATE)) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID))
                                ), 'YYYY-MM-DD HH24:MI:SS'))-1+ rownum <= TO_DATE(GREATEST (
                                        (select trim(max(ABS_STARTDATE)) from PER_ABSENTHIS where ABS_STARTDATE is not null and PER_ID=$PER_ID),
                                        (select trim(max(START_DATE)) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID)), 'YYYY-MM-DD')
                              )
                        ) x 
                      )
                    )
                    select AS_YEAR,AS_CYCLE,START_DATE,END_DATE,
                      sum(ABS_DAY_MFA) ABS_DAY_MFA,
                      sum(case when AB_TYPE='01' then ABS_DAY else 0 end) as SICK_ABS,
                      sum(case when AB_TYPE='03' then ABS_DAY else 0 end) as KIT_ABS,
                      sum(case when AB_TYPE='04' then ABS_DAY else 0 end) as PAKPON_ABS,
                      sum(case when AB_TYPE='07' then ABS_DAY else 0 end) as LASUKSA_ABS,
                      sum(case when AB_TYPE='10' then ABS_DAY else 0 end) as SAY_ABS,
                      sum(case when AB_TYPE='13' then ABS_DAY else 0 end) as KHAD_ABS

                    from (
                       select AS_YEAR,AS_CYCLE,START_DATE,END_DATE,AB_TYPE,sum(ABS_DAY) ABS_DAY,sum(ABS_DAY_MFA) ABS_DAY_MFA
                       from ( 

                        select s.AS_YEAR,s.AS_CYCLE,s.START_DATE,s.END_DATE,t.AB_TYPE,h.ABS_DAY,ABS_DAY_MFA
                        from PER_ABSENTSUM s
                        left join PER_ABSENTHIS h on (h.PER_ID=s.PER_ID
                          and (trim(h.ABS_STARTDATE) >= s.START_DATE and trim(h.ABS_ENDDATE) <= s.END_DATE))
                        left join PER_ABSENTTYPE t on (t.AB_CODE=h.AB_CODE)
                        where s.PER_ID=$PER_ID

                        union all

                        select  AS_YEAR,AS_CYCLE,START_DATE,END_DATE,AB_TYPE,ABS_DAY ABS_DAY,ABS_DAY_MFA
                        from (
                          select t.AB_TYPE,case when LISTDATE=trim(ABS_STARTDATE) then 
                                              case when ABS_STARTPERIOD=3 then 1 else 0.5 end
                                            else case when LISTDATE=trim(ABS_ENDDATE) then 
                                                    case when ABS_ENDPERIOD=3 then 1 else 0.5 end
                                                  else 
                                                    1
                                                 end
                                           end abs_day,ABS_DAY_MFA,s.START_DATE,s.END_DATE,s.AS_CYCLE,s.AS_YEAR
                          from PER_ABSENTSUM s
                          left join PER_ABSENTHIS h on (h.PER_ID=s.PER_ID
                            and ((trim(h.ABS_STARTDATE) < s.START_DATE and trim(h.ABS_ENDDATE) between s.START_DATE and s.END_DATE) or
                                 (trim(h.ABS_ENDDATE) > s.END_DATE and h.ABS_STARTDATE between s.START_DATE and s.END_DATE)) or 
                                 (trim(h.ABS_STARTDATE) < s.START_DATE and trim(h.ABS_ENDDATE) > s.END_DATE)
                                 )
                          left join PER_ABSENTTYPE t on (t.AB_CODE=h.AB_CODE and h.PER_ID=s.PER_ID)
                          left join AllWorkDay on (h.PER_ID=s.PER_ID and ((t.AB_COUNT=2 and HOL=0) or (t.AB_COUNT=1 and (HOL=0 or HOL=1)) ) 
                                and LISTDATE between trim(h.ABS_STARTDATE) and trim(h.ABS_ENDDATE) and LISTDATE between trim(s.START_DATE) and s.END_DATE)
                          where s.PER_ID= $PER_ID
                        )
                      )
                      group by AS_YEAR,AS_CYCLE,START_DATE,END_DATE,AB_TYPE
                    ) 
                    group by AS_YEAR,AS_CYCLE,START_DATE,END_DATE
            )  q1 WHERE q1.as_year=$AS_YEAR ";
            $db_dpis2->send_cmd($cmdcnt);
            $data2 = $db_dpis2->get_array();
            $TMP_CNTOFYEAR = $data2[CNTOFYEAR]; 
    return $TMP_CNTOFYEAR;
}
?>



<?  //เช็คปุ่มที่ได้ค่าออกมา ว่าเป็นปุ่มเพิ่มหรือแก้ไข 
	if($PAGE_AUTH["edit"]=="Y" && $UPD) 
	$Submit = "Submit_edit";
	else if(!$VIEW && $PAGE_AUTH["add"]=="Y") 
	$Submit = "Submit_add";    
?>
<span id="defaultTheme"></span>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="label_normal">
	<? if (!$HIDE_HEADER) { ?>
	<tr>
    	<td height="10"><?include("header_menu.html")?></td>
  	</tr>
	<? } ?>
    	<tr> 
	  <td align="left" valign="top">
<?	
		$OPTIONAL_TITLE="".(($HIDE_HEADER)?"ข้อมูลสรุปวันลาสะสม":"") ;
		if ($UPD) $OPTIONAL_TITLE.=" &gt; แก้ไขข้อมูล"; elseif ($VIEW) $OPTIONAL_TITLE.=" &gt; ดูข้อมูล";
		$setPerStyle="display:none; visibility:hidden";
		if($UPD||$VIEW||($BKK_FLAG==1&&$ADD_NEXT==1)){ $setPerStyle="display:block; visibility:visible"; }
		include("current_location.html");
?>
	  </td>	</tr>
  	<tr>
    	<td align="left" valign="top"><form name="form1" method="post" action="personal_absentsum.html" enctype="multipart/form-data">
          <input type="hidden" name="current_page" value="<?=$current_page?>">
          <input type="hidden" name="total_page" value="<?=$total_page?>">
		  <input type="hidden" name="MENU_ID_LV0" value="<?=$MENU_ID_LV0?>">
		  <input type="hidden" name="MENU_ID_LV1" value="<?=$MENU_ID_LV1?>">
		  <input type="hidden" name="MENU_ID_LV2" value="<?=$MENU_ID_LV2?>">
		  <input type="hidden" name="MENU_ID_LV3" value="<?=$MENU_ID_LV3?>">
          <input type="hidden" name="command" value="">
          <input type="hidden" name="PER_ID" value="<?=$PER_ID?>">
          <input type="hidden" name="AS_ID" value="<?=$AS_ID?>">
	   <input type="hidden" name="HIDE_HEADER" value="<?=$HIDE_HEADER?>">
&nbsp;<table width="90%"  border="0" align="center" cellpadding="0" cellspacing="0" class="label_normal">
  <tr>
    <td align="center"><table width="100%"  border="0" cellpadding="0" cellspacing="0" class="label_normal">
      <tr>
        <td width="15%" height="22" align="right"><?=$FULLNAME_TITLE?>&nbsp;:&nbsp;</td>
        <td align="center"><input type="text" name="PER_NAME" value="<?=$PER_NAME?>" style="width:98%" class="textbox" readonly></td>
        <td width="20%" height="22" align="right"><?=$CARDNO_TITLE?>&nbsp;:&nbsp;</td>
        <td align="center"><input type="text" name="PER_CARDNO" value="<?=$PER_CARDNO?>" style="width:98%" class="textbox" readonly></td>
        <td width="25%"><? if (!$HIDE_HEADER) { ?>
          &nbsp;<? if ($BUTTON_DISPLAY==1) { ?><input name="BackBtn" type="button" class="button" value="<?=$SELECT_PERSON_TITLE?>" onClick="javascript:window.location='personal_master.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>&SEARCHHIS=personal_absentsum'"><!--history.back(); --><?  } else {  echo "&nbsp; &nbsp;"; ?>
              <img src="images/select_person.png" alt="<?=$SELECT_PERSON_TITLE?>" width="32" height="32" border="0" onClick="javascript:window.location='personal_master.html?MENU_ID_LV0=<?=$MENU_ID_LV0?>&MENU_ID_LV1=<?=$MENU_ID_LV1?>&MENU_ID_LV2=<?=$MENU_ID_LV2?>&MENU_ID_LV3=<?=$MENU_ID_LV3?>&SEARCHHIS=personal_absentsum'">
              <? } echo "&nbsp; &nbsp;"; ?>
		  <? } ?></td>
      </tr>
    </table></td>
  </tr>
</table>
&nbsp;
<table width="95%" align="center" cellpadding="0" cellspacing="0">
  	<tr>
	  <td><table width="15%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
		  <tr>
		  	<td height="22" align="center" class="table_body" onClick="javascript:setLayer('id_rewardhis');"><?=($UPD)?"แก้ไข":$ADDTAB_TITLE?>ข้อมูล</td>
		  </tr>		
	  </table></td>
	</tr>
  </table>
  <table id="id_rewardhis"  width="95%" align="center" cellpadding="0" cellspacing="0" class="input_table" style="<?=$setPerStyle; ?>" 
  onKeyPress="return keyEnter(event,document.form1.<?=$Submit?>);">
    <tr>
      <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="label_normal">
        <tr>
          <td height="5"></td>
          </tr>
        <tr>
          <td height="22" align="center"><table width="100%"  border="0" cellpadding="0" cellspacing="0" class="label_normal">
		  			  <tr>
						  <td width="28%" height="22" align="right"><span class="label_alert">*</span>&nbsp;<?=$YEAR_TITLE?>&nbsp;:&nbsp;</td>
						  <td width="22%"><input type="text" name="AS_YEAR" value="<?=$AS_YEAR?>" size="10" maxlength="4" class="textbox" onKeyPress="return DigitOnly();" onBlur="form1.START_DATE_1.value='01/10/' + (this.value - 1); form1.END_DATE_1.value='31/03/' + this.value; form1.START_DATE_2.value='01/04/' + this.value; form1.END_DATE_2.value='30/09/' + this.value;" <?=(($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y") && !$VIEW)?"":"readonly"?>>
                              <span class="label_alert">&nbsp;&nbsp;
                                <?=$err_text?>
                              </span> </td>
					  </tr>	
                      <tr> 
                        <td width="28%" align="right" height="22"><span class="label_alert">*</span>&nbsp;รอบการลา&nbsp;:&nbsp;</td>
                        <td colspan="3">
						  <input type="radio" name="AS_CYCLE1" value="1" onClick="form1.START_DATE_1.disabled=false; form1.END_DATE_1.disabled=false; form1.START_DATE_2.disabled=true; form1.END_DATE_2.disabled=true; form1.AS_CYCLE.value=1;" <?=($AS_CYCLE==1 || !$AS_CYCLE)?"checked":""?>> ครั้งที่ 1
						  <input type="text" name="START_DATE_1" value="<?=$START_DATE_1?>" class="textbox" readonly <?=($AS_CYCLE==1 || !$AS_CYCLE)?"":"disabled"?>>
						  &nbsp;ถึง&nbsp;
						  <input type="text" name="END_DATE_1" value="<?=$END_DATE_1?>" class="textbox" readonly <?=($AS_CYCLE==1 || !$AS_CYCLE)?"":"disabled"?>>						</td>
                      </tr>
                      <tr>
                        <td align="right" height="22">&nbsp;</td>
                        <td colspan="3">
						  <input type="radio" name="AS_CYCLE1" value="2" onClick="form1.START_DATE_1.disabled=true; form1.END_DATE_1.disabled=true; form1.START_DATE_2.disabled=false; form1.END_DATE_2.disabled=false; form1.AS_CYCLE.value=2;" <?=($AS_CYCLE==2)?"checked":""?>> ครั้งที่ 2
						  <input type="text" name="START_DATE_2" value="<?=$START_DATE_2?>" class="textbox" readonly <?=($AS_CYCLE==2)?"":"disabled"?>>
						  &nbsp;ถึง&nbsp;
						  <input type="text" name="END_DATE_2" value="<?=$END_DATE_2?>" class="textbox" readonly <?=($AS_CYCLE==2)?"":"disabled"?>>					    </td>
                      </tr>
                      <tr>
                        <td height="7" colspan="4" align="right"><input type="hidden" name="AS_CYCLE" value="<?=(!$AS_CYCLE?1:$AS_CYCLE)?>"></td>
                      </tr>
            <tr>
              <td width="28%" height="22" align="right">&nbsp;</td>
              <td width="22%">
				  	<input type="text" name="AB_CODE_1" value="ค่าเริ่มต้น" style="width:22%; text-align:right" "readonly">	                
				  	<input type="text" name="AB_CODE_2" value=" รอบนี้" style="width:22%; text-align:right" "readonly">	                
				  	<input type="text" name="AB_CODE_3" value="   รวม" style="width:22%; text-align:right" "readonly">				</td>
              <td width="28%" align="right">&nbsp;</td>
              <td width="22%">
				  	<input type="text" name="AB_CODE_1" value="ค่าเริ่มต้น" style="width:22%; text-align:right" "readonly">	                
				  	<input type="text" name="AB_CODE_2" value=" รอบนี้" style="width:22%; text-align:right" "readonly">	                
				  	<input type="text" name="AB_CODE_3" value="   รวม" style="width:22%; text-align:right" "readonly">				</td>
            </tr>
            <tr>
              <td height="22" align="right">ลาป่วย (วัน)&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_01" value="<?=$AB_CODE_01?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>
				  	<input type="text" name="AB_CODE_01_1" value="<?=$AB_CODE_01_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_01_2" value="<?=$AB_CODE_01_2?>" style="width:22%; text-align:right" readonly>						</td>
              <td align="right">ลาป่วย (ครั้ง)&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_COUNT_01" value="<?=$AB_COUNT_01?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_COUNT_01_1" value="<?=$AB_COUNT_01_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_COUNT_01_2" value="<?=$AB_COUNT_01_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td height="22" align="right">ลากิจส่วนตัว (วัน)&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_03" value="<?=$AB_CODE_03?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_03_1" value="<?=$AB_CODE_03_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_03_2" value="<?=$AB_CODE_03_2?>" style="width:22%; text-align:right" readonly>					</td>
              <td align="right">ลากิจส่วนตัว (ครั้ง)&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_COUNT_03" value="<?=$AB_COUNT_03?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_COUNT_03_1" value="<?=$AB_COUNT_03_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_COUNT_03_2" value="<?=$AB_COUNT_03_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
			<tr>
              <td align="right">มาสาย&nbsp;:&nbsp;</td>
              <td height="22">
                  <input type="text" name="AB_CODE_10" value="<?=$AB_CODE_10?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
                  <input type="text" name="AB_CODE_10_1" value="<?=$AB_CODE_10_1?>" style="width:22%; text-align:right" readonly>	                
                  <input type="text" name="AB_CODE_10_2" value="<?=$AB_CODE_10_2?>" style="width:22%; text-align:right" readonly>
                  <?php if($IS_OPEN_TIMEATT_ES=="OPEN"){?>
                  <!--<input type="text" name="AB_CODE_10_3" value="<?php echo $CntLate;?>" style="width:22%; text-align:right;color: #0066FF" readonly>-->
                  <?php }?>
              </td>
              <td align="right">ลาคลอดบุตร&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_02" value="<?=$AB_CODE_02?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_02_1" value="<?=$AB_CODE_02_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_02_2" value="<?=$AB_CODE_02_2?>" style="width:22%; text-align:right" readonly>					</td>
			</tr>
            <tr>
              <td align="right">ลาพักผ่อน&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_04" value="<?=$AB_CODE_04?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_04_1" value="<?=$AB_CODE_04_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_04_2" value="<?=$AB_CODE_04_2?>" style="width:22%; text-align:right" readonly>					
				  	<!--<input type="text" name="AB_CODE_04_3" value="<?=$AB_CODE_04_3?>" style="width:22%; text-align:right" readonly>-->
                  </td>
              <td height="22" align="right">ลากิจส่วนตัวเพื่อเลี้ยงดูบุตร&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_11" value="<?=$AB_CODE_11?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_11_1" value="<?=$AB_CODE_11_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_11_2" value="<?=$AB_CODE_11_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td height="22" align="right">ลาอุปสมบทหรือลาไปประกอบพิธีฮัจย์&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_05" value="<?=$AB_CODE_05?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_05_1" value="<?=$AB_CODE_05_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_05_2" value="<?=$AB_CODE_05_2?>" style="width:22%; text-align:right" readonly>					</td>
              <td align="right">ลาไปศึกษา ฝึกอบรม ดูงาน หรือปฏิบัติการวิจัย&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_07" value="<?=$AB_CODE_07?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_07_1" value="<?=$AB_CODE_07_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_07_2" value="<?=$AB_CODE_07_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td height="22" align="right">ลาติดตามคู่สมรส&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_09" value="<?=$AB_CODE_09?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_09_1" value="<?=$AB_CODE_09_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_09_2" value="<?=$AB_CODE_09_2?>" style="width:22%; text-align:right" readonly>					</td>
              <td align="right">ลาเข้ารับการตรวจเลือกหรือเข้ารับการเตรียมพล&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_06" value="<?=$AB_CODE_06?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_06_1" value="<?=$AB_CODE_06_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_06_2" value="<?=$AB_CODE_06_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td height="22" align="right">ลาไปปฏิบัติงานในองค์การระหว่างประเทศ&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_08" value="<?=$AB_CODE_08?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_08_1" value="<?=$AB_CODE_08_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_08_2" value="<?=$AB_CODE_08_2?>" style="width:22%; text-align:right" readonly>					</td>
              <td align="right">ลาป่วยจำเป็น&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_12" value="<?=$AB_CODE_12?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_12_1" value="<?=$AB_CODE_12_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_12_2" value="<?=$AB_CODE_12_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td height="22" align="right">ลาไปช่วยเหลือภริยาที่คลอดบุตร&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_14" value="<?=$AB_CODE_14?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_14_1" value="<?=$AB_CODE_14_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_14_2" value="<?=$AB_CODE_14_2?>" style="width:22%; text-align:right" readonly>					</td>
              <td align="right">ลาไปฟื้นฟูสมรรถภาพด้านอาชีพ&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_15" value="<?=$AB_CODE_15?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_15_1" value="<?=$AB_CODE_15_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_15_2" value="<?=$AB_CODE_15_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td align="right">ขาดราชการ&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="AB_CODE_13" value="<?=$AB_CODE_13?>" style="width:22%; text-align:right" class="textbox" onKeyPress="return NumOnly();" <?=($PER_ID && ($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y"))?"":"readonly"?>>	                
				  	<input type="text" name="AB_CODE_13_1" value="<?=$AB_CODE_13_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="AB_CODE_13_2" value="<?=$AB_CODE_13_2?>" style="width:22%; text-align:right" readonly>
                                        <?php if($IS_OPEN_TIMEATT_ES=="OPEN"){?>
                                        <!--<input type="text" name="AB_CODE_13_3" value="<?php echo $CntNotWork ;?>" style="width:22%; text-align:right;color: #0066FF" readonly> -->
                                        <?php }?>
                  </td>
				<td>&nbsp;</td>	
				<td>&nbsp;</td>	
            </tr>
            <tr>
              <td height="22" align="right">ลาป่วย + ลากิจ (วัน)&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="TOTAL_LEAVE" value="<?=$TOTAL_LEAVE?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="TOTAL_LEAVE_1" value="<?=$TOTAL_LEAVE_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="TOTAL_LEAVE_2" value="<?=$TOTAL_LEAVE_2?>" style="width:22%; text-align:right" readonly>					</td>
              <td align="right">ลาป่วย + ลากิจ (ครั้ง)&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="TOTAL_COUNT" value="<?=$TOTAL_COUNT?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="TOTAL_COUNT_1" value="<?=$TOTAL_COUNT_1?>" style="width:22%; text-align:right" readonly>	                
				  	<input type="text" name="TOTAL_COUNT_2" value="<?=$TOTAL_COUNT_2?>" style="width:22%; text-align:right" readonly>					</td>
            </tr>
            <tr>
              <td height="22" align="right">จำนวนวันที่ลาพักผ่อนได้ใน<?=$YEAR_TITLE?>&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="VC_DAY" value="<?=$VC_DAY?>" style="width:22%; text-align:right" class="textbox" readonly>	                </td>
              <td align="right">จำนวนวันลาพักผ่อนที่เหลือ&nbsp;:&nbsp;</td>
                  <td height="22">
				  	<input type="text" name="REMAIN_VC_DAY" value="<?=$REMAIN_VC_DAY?>" style="width:22%; text-align:right" class="textbox" readonly>	                </td>
            </tr>
			<tr>
              <td align="right"><?=$REMARK_TITLE;?>&nbsp;:&nbsp;</td>
              <td colspan="3"><input type="text" name="AS_REMARK" value="<?=$AS_REMARK?>" style="width:90%" class="textbox" <?=($PAGE_AUTH["add"]=="Y" || $PAGE_AUTH["edit"]=="Y")?"":"readonly"?>></td>
			  </tr>
            <tr>
              <td align="right"><?=$UPDATE_USER_TITLE;?>&nbsp;:&nbsp;</td>
              <td><input name="SHOW_UPDATE_USER" type="text" style="width:100%" class="textbox" value="<?=$SHOW_UPDATE_USER?>" readonly></td>
              <td align="right"><?=$UPDATE_DATE_TITLE;?>&nbsp;:&nbsp;</td>
              <td><input name="SHOW_UPDATE_DATE" type="text" class="textbox" value="<?=$SHOW_UPDATE_DATE?>" readonly></td>
            </tr>
          </table></td>
        </tr>
		<? if($PER_ID) : ?>
        <tr align="center">
          <td height="25">
		  		<? if ($UPD || $VIEW) { ?>
      		  <?if($PAGE_AUTH["edit"]=="Y" && $UPD){?>
			  <? if ($BUTTON_DISPLAY==1) { ?>
			  <input name="Submit_edit" type="submit" class="button" onClick="return checkupdate(form1);" value="<?=$EDIT_TITLE?>">
			  <?  } else { ?>
              <input name="image2" type="image" onClick="return checkupdate(form1);"  src="images/save.png" alt="<?=$EDIT_TITLE?>">
              <? } echo "&nbsp; &nbsp;";?>
			  <?}?> 
				<? if ($BUTTON_DISPLAY==1) { ?>
              <input type="submit" name="Reset2" value="<?=$CANCEL_TITLE?>" onClick="form1.command.value='CANCEL'; form1.AS_ID.value='';" class="button" >
              <?  } else { ?>
              <input name="image2" type="image" onClick="form1.command.value='CANCEL'; form1.AS_ID.value='';" src="images/cancel.gif" alt="<?=$CANCEL_TITLE?>">
              <? } echo "&nbsp; &nbsp;";?>
      		  <? } else { ?>
	  		  <?if($PAGE_AUTH["add"]=="Y"){?>
			  <? if ($BUTTON_DISPLAY==1) { ?>
			  <input name="Submit_add" type="submit" class="button" onClick="return checkadd(form1);" value="<?=$ADD_TITLE?>">
			  <?  } else { ?>
              <input name="image2" type="image" onClick="return checkadd(form1);" src="images/save.png" alt="<?=$ADD_TITLE?>">
              <? } echo "&nbsp; &nbsp;";?>
			  <?}?> 
			  <? if ($BUTTON_DISPLAY==1) { ?>
      		  <input name="Reset" type="reset" class="button" value="<?=$CLEAR_TITLE?>">  
      		  <?  } else { ?>
                  <img src="images/default.jpg" alt="<?=$CLEAR_TITLE?>" width="32" height="32" border="0" onClick="form1.reset();">
                  <? } echo "&nbsp; &nbsp;";?>
              <?}?>
          </td>
        </tr>
		<? endif; ?>
		<tr><td height="5"></td></tr>
      </table></td>
    </tr>
  </table>
<table width="95%" border="0" align="center" cellpadding="0" cellspacing="0">
<tr><td><input type="hidden" name="order_by" value="<?=$order_by?>">
    <input type="hidden" name="sort_by" value="<?=$sort_by;?>">
    <input type="hidden" name="sort_type" value="<?=$sort_type?>">
<?=$SORT_TITLE?></td>
</tr>
</table>
<table width="95%" border="0" align="center" cellpadding="0" cellspacing="0">
	<tr>
	  <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="table_body_3">
     <tr height="22">
	<td align="center">พบข้อมูลสรุปวันลาสะสมทั้งสิ้น <?=($count_data + 0)?> รายการ</td>
     </tr>
   </table></td>
	</tr>
</table>     
<?
	if(!$sort_by) $sort_by=1;
	if(!$sort_type){	if ($PER_ORDER_BY==1) { $sort_type = "1:asc"; } else {  $sort_type = "1:desc"; }	}
	$arrSort=explode(":",$sort_type);
	$SortType[$arrSort[0]]	=$arrSort[1];
	if(!$order_by) $order_by=1;
	
	if($order_by==1){	//(ค่าเริ่มต้น) ปี
		$order_str = "ORDER BY AS_YEAR $SortType[$order_by], AS_CYCLE $SortType[$order_by]";
  	} 
	
	if($current_page > 1){
		if($DPISDB=="odbc"){
			$cmd = " select top $start_record trim(AS_ID) as concat_pk from PER_ABSENTSUM 
							where PER_ID=$PER_ID  $search_condition order by $order_by ";
			$db_dpis->send_cmd($cmd);
			while($data = $db_dpis->get_array()) $arr_exclude[] = "'".$data[concat_pk]."'";
			$limit_data = (trim($search_condition)?" and ":" where ")." trim(AS_ID) not in (". implode(", ", $arr_exclude) .")";
		}elseif($DPISDB=="mysql"){
  			$limit_data = " limit " . (($current_page - 1) * $data_per_page) . ", " . $data_per_page;
		}
	}

	if($DPISDB=="odbc"){
		$cmd = " SELECT		AS_ID, AS_YEAR, AS_CYCLE, START_DATE, END_DATE, TOTAL_LEAVE, TOTAL_COUNT, 
										AB_CODE_01, AB_CODE_03, AB_CODE_04, AB_CODE_10, AB_CODE_13, AB_CODE_07, AUDIT_FLAG
						 FROM			PER_ABSENTSUM
						 WHERE		prh.PER_ID=$PER_ID 
												$limit_data
							$order_str ";	
	}elseif($DPISDB=="oci8"){
		$rec_start = (($current_page-1) * $data_per_page) + 1;
		$rec_end = ($current_page > 1)? ($current_page * $data_per_page) : $data_per_page;
		/*$cmd = "select * from (
						   select rownum rnum, q1.* from ( 
								  select 		AS_ID, AS_YEAR, AS_CYCLE, START_DATE, END_DATE, TOTAL_LEAVE, TOTAL_COUNT, 
								  					AB_CODE_01, AB_CODE_03, AB_CODE_04, AB_CODE_10, AB_CODE_13, AB_CODE_07, AUDIT_FLAG 
								  from 		PER_ABSENTSUM 
								  where 		PER_ID=$PER_ID 
								   	$order_str
						   )  q1
					) where rnum between $rec_start and $rec_end  ";*/
                    
                   
                   /*ของเดิมที่บวกผิด By kittiphat 07062561
                      			select AS_YEAR,AS_CYCLE,START_DATE,END_DATE,
                                      sum(ABS_DAY_MFA) ABS_DAY_MFA,
                                      sum(case when AB_TYPE='01' then abs_day+ab_code_01 else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_01 else 0 end
                                          end) as SICK_ABS,
                                      sum(case when AB_TYPE='03' then abs_day+ab_code_03 else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_03 else 0 end
                                          end) as KIT_ABS,
                                      sum(case when AB_TYPE='04' then abs_day+ab_code_04 else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                          end) as PAKPON_ABS,
                                      sum(case when AB_TYPE='07' then abs_day+ab_code_07 else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_07 else 0 end
                                          end) as LASUKSA_ABS,
                                      sum(case when AB_TYPE='10' then ABS_DAY+ab_code_10 else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_10 else 0 end
                                          end) as SAY_ABS,
                                      sum(case when AB_TYPE='13' then abs_day+ab_code_13 else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_13 else 0 end
                                         end) as KHAD_ABS,
                                      XSUM1,
                                      XSUM1-sum(case when AB_TYPE='04' then ABS_DAY+AB_CODE_04 else 
                                                    CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                                end) AS XSUM_DIFF1,
                                      LAG(XSUM1-sum(case when AB_TYPE='04' then ABS_DAY+AB_CODE_04 else 
                                                    CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                                end), 1, 0) 
                                      OVER (ORDER BY AS_YEAR desc, AS_CYCLE asc) AS XSUM_DIFF2
                   
                   */ 
                    
                    /*  */
                $cmd = "select * from (
                            select rownum rnum, q1.* from (
                                /*WITH
                                    AllWorkDay As
                                    (
                                      select * from (
                                        select x.*,(case when TO_CHAR(TO_DATE(x.LISTDATE,'YYYY-MM-DD'), 'DY', 'NLS_DATE_LANGUAGE=ENGLISH') IN ('SAT', 'SUN') then 1 else
                                          case when exists (select null from PER_HOLIDAY where HOL_DATE = x.LISTDATE) then 1 else 0 end end) HOL
                                        from (
                                          select to_char(LISTDATE,'YYYY-MM-DD') LISTDATE from (
                                            SELECT (TO_DATE((LEAST((select trim(min(ABS_STARTDATE)) from PER_ABSENTHIS where ABS_STARTDATE is not null and PER_ID=$PER_ID),
                                                  (select min(START_DATE) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID))
                                            ), 'YYYY-MM-DD'))-1+rownum AS LISTDATE FROM all_objects
                                             WHERE OWNER='SYS' and (TO_DATE((LEAST((select trim(min(ABS_STARTDATE)) from PER_ABSENTHIS where ABS_STARTDATE is not null and PER_ID=$PER_ID),
                                                  (select min(START_DATE) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID))
                                            ), 'YYYY-MM-DD HH24:MI:SS'))-1+ rownum <= TO_DATE(GREATEST (
                                                    (select trim(max(ABS_STARTDATE)) from PER_ABSENTHIS where ABS_STARTDATE is not null and PER_ID=$PER_ID),
                                                    (select max(START_DATE) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID)), 'YYYY-MM-DD')
                                          )
                                        ) x 
                                      )
                                    )*/
                                    WITH AllWorkDay AS(
                                    select * from (
                                      select x.*,(case when TO_CHAR(TO_DATE(x.LISTDATE,'YYYY-MM-DD'), 'DY', 'NLS_DATE_LANGUAGE=ENGLISH') IN ('SAT', 'SUN') then 1 else
                                        case when exists (select null from PER_HOLIDAY where HOL_DATE = x.LISTDATE) then 1 else 0 end end) HOL
                                      from (
                                        SELECT  to_char( 
                                                  TRUNC (
                                                    to_date(
                                                      LEAST((SELECT min(abs_startdate) FROM PER_ABSENTHIS WHERE abs_startdate is not null AND per_id=$PER_ID),
                                                      (select min(START_DATE) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID)),
                                                    'YYYY-MM-DD'),
                                                  'MON') +rownum-1,
                                                'YYYY-MM-DD') AS LISTDATE
                                        FROM DUAL 
                                        CONNECT BY LEVEL <= (SELECT TO_DATE(
                                                                      GREATEST((SELECT max(abs_enddate) FROM PER_ABSENTHIS WHERE abs_startdate is not null AND per_id=$PER_ID),
                                                                      (select max(START_DATE) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID)), 
                                                                    'YYYY-MM-DD') -  TO_DATE(
                                                                                        LEAST((SELECT min(abs_startdate) FROM PER_ABSENTHIS WHERE abs_startdate is not null AND per_id=$PER_ID),
                                                                                        (select min(START_DATE) from PER_ABSENTSUM where START_DATE is not null and PER_ID=$PER_ID)), 
                                                                                     'YYYY-MM-DD')+1 AS DateDiff FROM dual)
                                      ) x
                                    )
                                  )
                                    select AS_YEAR,AS_CYCLE,START_DATE,END_DATE,
                                      sum(ABS_DAY_MFA) ABS_DAY_MFA,
                                      sum(case when AB_TYPE='01' then abs_day else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_01 else 0 end
                                          end) as SICK_ABS,
                                      sum(case when AB_TYPE='03' then abs_day else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_03 else 0 end
                                          end) as KIT_ABS,
                                      sum(case when AB_TYPE='04' then abs_day else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                          end) as PAKPON_ABS,
                                      sum(case when AB_TYPE='07' then abs_day else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_07 else 0 end
                                          end) as LASUKSA_ABS,
                                      sum(case when AB_TYPE='10' then ABS_DAY else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_10 else 0 end
                                          end) as SAY_ABS,
                                      sum(case when AB_TYPE='13' then abs_day else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_13 else 0 end
                                         end) as KHAD_ABS,
                                      XSUM1,
                                      (select nvl(sum(h.ABS_DAY),0)
                                      from PER_ABSENTSUM s
                                      left join PER_ABSENTHIS h on (h.PER_ID=$PER_ID and (trim(h.ABS_STARTDATE) >= s.START_DATE and trim(h.ABS_ENDDATE) <= s.END_DATE))
                                      left join PER_ABSENTTYPE t on (t.AB_CODE=h.AB_CODE)
                                      where s.PER_ID=$PER_ID AND t.AB_TYPE='04' AND s.AS_YEAR=xmain.AS_YEAR) as total04,

                                      (case 
                                        WHEN as_cycle=1 THEN
                                            XSUM1-sum(case when AB_TYPE='04' then abs_day else 
                                            CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                            end)
                                        ELSE
                                            XSUM1-((select nvl(sum(h.ABS_DAY),0)
                                      from PER_ABSENTSUM s
                                      left join PER_ABSENTHIS h on (h.PER_ID=$PER_ID and (trim(h.ABS_STARTDATE) >= s.START_DATE and trim(h.ABS_ENDDATE) <= s.END_DATE))
                                      left join PER_ABSENTTYPE t on (t.AB_CODE=h.AB_CODE)
                                      where s.PER_ID=$PER_ID AND t.AB_TYPE='04' AND s.AS_YEAR=xmain.AS_YEAR)+(select nvl(sum(s.ab_code_04),0) from PER_ABSENTSUM s  where s.PER_ID=$PER_ID AND s.AS_YEAR=xmain.AS_YEAR))
                                        END)  AS NUMDIFF
                                        
                                      /*XSUM1-sum(case when AB_TYPE='04' then ABS_DAY else 
                                                    CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                                end) AS XSUM_DIFF1
                                                ,
                                      LAG(XSUM1-sum(case when AB_TYPE='04' then ABS_DAY else 
                                                    CASE WHEN  AB_TYPE IS NULL THEN ab_code_04 else 0 end
                                                end), 1, 0) 
                                      OVER (ORDER BY AS_YEAR desc, AS_CYCLE asc) AS XSUM_DIFF2*/

                                    from (
                                       select tb1.AS_YEAR,tb1.AS_CYCLE,tb1.START_DATE,tb1.END_DATE,tb1.AB_TYPE,sum(tb1.ABS_DAY) ABS_DAY,sum(tb1.ABS_DAY_MFA) ABS_DAY_MFA,
                                       NVL(asum.ab_code_01,0) AS ab_code_01,
                                        NVL(asum.ab_code_03,0) AS ab_code_03,
                                        NVL(asum.ab_code_04,0) AS ab_code_04,
                                        NVL(asum.ab_code_07,0) AS ab_code_07,
                                        NVL(asum.ab_code_10,0) as ab_code_10,
                                        NVL(asum.ab_code_13,0) AS ab_code_13,
                                        (select v.VC_DAY from PER_VACATION v where v.VC_YEAR=tb1.AS_YEAR and v.PER_ID=$PER_ID) AS XSUM1
                                       from ( 

                                        select s.AS_YEAR,s.AS_CYCLE,s.START_DATE,s.END_DATE,t.AB_TYPE,h.ABS_DAY,ABS_DAY_MFA
                                        from PER_ABSENTSUM s
                                        left join PER_ABSENTHIS h on (h.PER_ID=s.PER_ID
                                          and (trim(h.ABS_STARTDATE) >= s.START_DATE and trim(h.ABS_ENDDATE) <= s.END_DATE))
                                        left join PER_ABSENTTYPE t on (t.AB_CODE=h.AB_CODE)
                                        where s.PER_ID=$PER_ID

                                        union all

                                        select  AS_YEAR,AS_CYCLE,START_DATE,END_DATE,AB_TYPE,ABS_DAY ABS_DAY,ABS_DAY_MFA
                                        from (
                                          select t.AB_TYPE,case when LISTDATE=trim(ABS_STARTDATE) then 
                                                              case when ABS_STARTPERIOD=3 then 1 else 0.5 end
                                                            else case when LISTDATE=trim(ABS_ENDDATE) then 
                                                                    case when ABS_ENDPERIOD=3 then 1 else 0.5 end
                                                                  else 
                                                                    1
                                                                 end
                                                           end abs_day,ABS_DAY_MFA,s.START_DATE,s.END_DATE,s.AS_CYCLE,s.AS_YEAR
                                          from PER_ABSENTSUM s
                                          left join PER_ABSENTHIS h on (h.PER_ID=s.PER_ID
                                            and ((trim(h.ABS_STARTDATE) < s.START_DATE and trim(h.ABS_ENDDATE) between s.START_DATE and s.END_DATE) or
                                                 (trim(h.ABS_ENDDATE) > s.END_DATE and trim(h.ABS_STARTDATE) between s.START_DATE and s.END_DATE)) or 
                                                 (trim(h.ABS_STARTDATE) < s.START_DATE and trim(h.ABS_ENDDATE) > s.END_DATE)
                                                 )
                                          left join PER_ABSENTTYPE t on (t.AB_CODE=h.AB_CODE and h.PER_ID=s.PER_ID)
                                          left join AllWorkDay on (h.PER_ID=s.PER_ID and ((t.AB_COUNT=2 and HOL=0) or (t.AB_COUNT=1 and (HOL=0 or HOL=1)) ) 
                                                and LISTDATE between trim(h.ABS_STARTDATE) and h.ABS_ENDDATE and LISTDATE between trim(s.START_DATE) and s.END_DATE)
                                          where s.PER_ID= $PER_ID
                                        )
                                      ) tb1
                                      LEFT JOIN PER_ABSENTSUM asum 
                                        ON(asum.as_year=tb1.as_year and asum.as_cycle=tb1.as_cycle and asum.per_id=$PER_ID)
                                      group by tb1.AS_YEAR,tb1.AS_CYCLE,tb1.START_DATE,tb1.END_DATE,tb1.AB_TYPE,
                                        asum.ab_code_01,asum.ab_code_03,asum.ab_code_04,asum.ab_code_07,asum.ab_code_10,asum.ab_code_13
                                    ) xmain
                                    group by AS_YEAR,AS_CYCLE,START_DATE,END_DATE,XSUM1
                                    $order_str 
                            )  q1
                        ) where rnum between $rec_start and $rec_end  ";
                                        
                                        
                                        
	}elseif($DPISDB=="mysql"){
		$cmd = " SELECT		AS_ID, AS_YEAR, AS_CYCLE, START_DATE, END_DATE, TOTAL_LEAVE, TOTAL_COUNT, 
										AB_CODE_01, AB_CODE_03, AB_CODE_04, AB_CODE_10, AB_CODE_13, AB_CODE_07, AUDIT_FLAG 
						 FROM		PER_ABSENTSUM 
						 WHERE		PER_ID=$PER_ID 
							$order_str
								$limit_data ";	
	} // end if
	//echo '<pre>'.$cmd;
	$count_page_data = $db_dpis->send_cmd($cmd);
//	$db_dpis->show_error();
	if ($count_page_data) {
?>
  <table width="95%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
    <tr align="center" class="table_head">
	  <td width="4%" height="21"><strong><?=$SEQ_NO_TITLE;?></strong></td>
      <td height="25" width="5%" onClick="call_sort(1);"><strong><? if($order_by==1&&$sort_by==1){  if($SortType[$order_by]=="asc"){  echo $SORT_ASC;  }else{ echo $SORT_DESC; } }else{  echo $SORT_CUR;  } ?></strong>ประจำปี</td>
      <td width="4%">รอบ</td>
      <td>วันที่</td>
      <td width="6%">ลาป่วย</td>
      <td width="6%">ลากิจส่วนตัว</td>
      <td width="6%">มาสาย</td>
      <td width="6%">ขาดราชการ</td>
      <td width="6%">ลาศึกษาต่อ</td>
      <td width="6%">ลาพักผ่อน</td>
      <td width="6%" title="จำนวนวันที่ลาพักผ่อนได้ในปีงบประมาณ">ลาพักผ่อนสะสม</td>
      <td width="6%">คงเหลือ</td>
	  <td width="4%"><?=$INQ_TITLE?></td>
      <?if($PAGE_AUTH["edit"]=="Y"){?><td width="4%"><?=$EDIT_TITLE?></td><?}?>
      <?if($PAGE_AUTH["del"]=="Y"){?><td width="4%"><?=$DEL_TITLE?></td><?}?>
	  <td width="4%">จำนวนไฟล์</td>
	  <?if($PAGE_AUTH["attach"]=="Y"){ ?><td width="4%"><?=$LOAD_TITLE?></td><? } ?>
      <?if(($PAGE_AUTH["edit"]=="Y" || $PAGE_AUTH["del"]=="Y") && $PAGE_AUTH["audit"]=="Y"){?><td width="4%"><?=$AUDIT_TITLE?><br><input type="checkbox" name="list_audit_all" value="1" onClick="set_check_all(this.checked,'list_audit_id',<?=$count_data; ?>);" <?=(($list_audit_all==1)?"checked":"")?>></td><?}?>
    </tr>
    <?
        
        
	$current_list = "";
	$data_count = $num_order = 0;
	if ($PER_ORDER_BY==1) $num_order = ($current_page - 1) * $data_per_page;
	else $num_order = $count_data - (($current_page - 1) * $data_per_page) + 1;
        $chkYear = 0;
	while ($data = $db_dpis->get_array()) {
		$data_count++;
		if ($PER_ORDER_BY==1) $num_order++;
		else $num_order--;
		if($data_count > $data_per_page) break;
		
                /*ปรับวิธีการเรียกใหม่นะจ๊ะ...*/
                $TMP_AS_YEAR = trim($data[AS_YEAR]);
                $TMP_AS_CYCLE = trim($data[AS_CYCLE]);
                $TMP_START_DATE = show_date_format(trim($data[START_DATE]), $DATE_DISPLAY);
                $TMP_END_DATE = show_date_format(trim($data[END_DATE]), $DATE_DISPLAY);                //$TMP_START_DATE - $TMP_END_DATE
                $TMP_AB_CODE_01_2 = trim(round($data[SICK_ABS],2)); /*ลาป่วย*/
                $TMP_AB_CODE_03_2 = trim(round($data[KIT_ABS],2)); /*ลากิจส่วนตัว*/
                $TMP_AB_CODE_10_2 = trim(round($data[SAY_ABS],2)); /*มาสาย*/
                $TMP_AB_CODE_13_2 = trim(round($data[KHAD_ABS],2)); /*ขาดราชการ*/
                $TMP_AB_CODE_07_2 = trim(round($data[LASUKSA_ABS],2)); /*ลาศึกษาต่อ*/
                $TMP_AB_CODE_04_2 = trim(round($data[PAKPON_ABS],2)); /*ลาพักผ่อน*/
                
               $cmd = " select VC_DAY from PER_VACATION 
                    where VC_YEAR='$TMP_AS_YEAR'and PER_ID=$PER_ID ";
                $db_dpis2->send_cmd($cmd);
                $data2 = $db_dpis2->get_array();
                $TMP_VC_DAY = $data2[VC_DAY]; 
                
                //$XSUM_DIFF1 = $data[XSUM_DIFF1]; 
                //$XSUM_DIFF2 = $data[XSUM_DIFF2]; 
                //echo $XSUM_DIFF2.'<br>';
                /*if($TMP_AS_CYCLE==1){ //1
                	//ตอน select มันคนละแบบ มันเลยต้องเช็คต่างกัน
                	if($XSUM_DIFF1){
                    	$REST_DAY = $XSUM_DIFF1;
                    }else{
                    	$REST_DAY = $XSUM_DIFF1-$TMP_AB_CODE_04_2;
                    }
                    
                }elseif($TMP_AS_CYCLE==2){ //2
                	//ตอน select มันคนละแบบ มันเลยต้องเช็คต่างกัน
                	if($TMP_AB_CODE_04_2==0 && $XSUM_DIFF2 <=0){
                    	$REST_DAY = 0;
                    }else{
                    	$REST_DAY = $XSUM_DIFF2-$TMP_AB_CODE_04_2;
                    }
                    
                }*/
                $REST_DAY=$data[NUMDIFF]; 
                
                
                
                $cmd = "SELECT AS_ID FROM PER_ABSENTSUM WHERE per_id=$PER_ID AND as_year =$TMP_AS_YEAR AND as_cycle=$TMP_AS_CYCLE ";
		$db_dpis2->send_cmd($cmd);
		$data2 = $db_dpis2->get_array();
		$TMP_AS_ID = trim($data2[AS_ID]);
                /**/
                
                
		$class = "table_body";
		$onmouse_event = " onMouseOver=\"this.className='table_body_over';\" onMouseOut=\"this.className='table_body';\" ";
		if($AS_ID==$TMP_AS_ID){ 
			$class = "table_body_over";
			$onmouse_event = "";
		} // end if	
                
                
                
?>
    <tr class="<?=$class?>" <?=$onmouse_event?>>
      <td height="25" align="center"><?=$num_order?></td>
      <td align="center"><?=$TMP_AS_YEAR?></td>
      <td align="center"><?=$TMP_AS_CYCLE?></td>
      <td align="center"><?=$TMP_START_DATE?> - <?=$TMP_END_DATE?></td>
      <td align="center"><?=$TMP_AB_CODE_01_2?></td>
      <td align="center"><?=$TMP_AB_CODE_03_2?></td>
      <td align="center"><?=$TMP_AB_CODE_10_2?></td>
      <td align="center"><?=$TMP_AB_CODE_13_2?></td>
      <td align="center"><?=$TMP_AB_CODE_07_2?></td>
      <td align="center"><?=$TMP_AB_CODE_04_2?></td>
      <td align="center" title="จำนวนวันที่ลาพักผ่อนได้ในปีงบประมาณ"><?php if($TMP_VC_DAY==0){echo  '';}else{echo $TMP_VC_DAY;}?></td>
      
      <td align="center"><?php if($REST_DAY==0){echo  '';}else{echo $REST_DAY;}?></td>
      <td align="center">&nbsp;<a href="<?="javascript:form1.action+='?VIEW=1';form1.AS_ID.value=$TMP_AS_ID; form1.submit();"?>""><img src="images/icon_eye.gif" alt="ดูสรุปวันลาสะสม" width="16" height="16" border="0"></a></td>
	  <?if($PAGE_AUTH["edit"]=="Y"){?>
	  	<?if($TMP_AUDIT_FLAG=="Y"){?>
			  <td><?=$AUDITED_TITLE?></td>
	  	<? } else { ?>
		      <td align="center">&nbsp;<a href="<?="javascript:form1.action+='?UPD=1';form1.AS_ID.value=$TMP_AS_ID; form1.submit();"?>""><img src="images/b_edit.png" border="0" alt="แก้ไขสรุปวันลาสะสม"></a></td>
	  	<?}?>
	  <?}?>
	  <?if($PAGE_AUTH["del"]=="Y"){?>
	  	<?if($TMP_AUDIT_FLAG=="Y"){?>
			  <td>&nbsp;</td>
	  	<? } else { ?>
		      <td align="center">&nbsp;<a href="<?="javascript:confirm_delete($TMP_AS_ID,'$TMP_AS_YEAR')"?>"><img src="images/b_drop.png" border="0" alt="ลบสรุปวันลาสะสม"></a></td>
	  	<?}?>
	  <?}?>
	  <? $parameter1=$parameter2=$parameter3=$parameter4="";	?>
	 <? if($ATTACH_FILE==1){
				$parameter1="PER_ATTACHMENT";	$parameter2="43";	$parameter3="สรุปวันลาสะสม";	$parameter4=$PER_ID;
			}else{
				$parameter1="PER_ABSENTSUM";	$parameter2=$TMP_AS_ID;	$parameter3=$TMP_AS_YEAR;	$parameter4=$PER_ID;
			}
	  ?>
	  <td align="center">&nbsp;<? 
	  $FILE_PATH = '../attachments/'.str_replace("'" ,"",$PER_CARDNO).'/'.$parameter1.'/'.$parameter2;
	  $numfiles=0;
	  if(is_dir($FILE_PATH)){	
		if ($dh = opendir($FILE_PATH)) {		//นับจำนวนไฟล์ทั้งหมดใน folder
			while (($file = readdir($dh)) !== false) {	//---อ่านไฟล์ทั้งหมดมาจาก folder ($FILE_PATH) นั้น
				if ($file != "." && $file != "..") {
					$numfiles++;
				} // end if
			} // while loop readdir
		closedir($dh);
		} // end if
?>		
<a href="<?="javascript:call_menu_desc('$parameter1','$parameter2','$parameter3','$parameter4')"?>"><?=$numfiles; ?></a> 
<?	 
	  }else{	 echo "-";	} 
	  ?></td>
	   <?if($PAGE_AUTH["attach"]=="Y"){ ?><td align="center">&nbsp; <a href="<?="javascript:call_menu_desc('$parameter1','$parameter2','$parameter3','$parameter4')"?>"><img src="images/file.jpg" border="0" alt="<?=$ALT_LOAD_TITLE?>"></a></td><? } ?>
      <?if(($PAGE_AUTH["edit"]=="Y" || $PAGE_AUTH["del"]=="Y") && $PAGE_AUTH["audit"]=="Y"){?><td align="center"><input type="checkbox" id="list_audit_id<?=$data_count; ?>" name="list_audit_id[]" onClick="set_uncheck_all(this.checked,form1.list_audit_all,this.id)" value="<?=$TMP_AS_ID?>" <?=(($TMP_AUDIT_FLAG=="Y")?"checked":"")?>></td><? } ?>
    </tr>
    <? 
    $chkYear = $TMP_AS_YEAR;
    } ?>
	<?if($PAGE_AUTH["edit"]=="Y"){?>
    <tr class="table_footer" height="24">
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <?if($PAGE_AUTH["edit"]=="Y"){?><td>&nbsp;</td><?}?>
      <?if($PAGE_AUTH["del"]=="Y"){?><td>&nbsp;</td><?}?>
      <td>&nbsp;</td>
	  <?if($PAGE_AUTH["attach"]=="Y"){ ?><td>&nbsp;</td><? } ?>
      <?if(($PAGE_AUTH["edit"]=="Y" || $PAGE_AUTH["del"]=="Y") && $PAGE_AUTH["audit"]=="Y"){?>
      <td align="center"><? if ($BUTTON_DISPLAY==1) { ?>
        <input type="submit" name="Submit4" value="<?=$SETFLAG_TITLE?>" onClick="form1.command.value='SETFLAG'" class="button" style="width:98%">
        <?  } else { ?>
        <input name="image3" type="image" onClick="form1.command.value='SETFLAG'" src="images/save.png" alt="<?=$SETFLAG_TITLE?>" border="0">
        <? } ?></td>
	  <?}?>
	</tr>
	<?}?>
  </table>
  <? if($total_page > 1) : ?>
  <table width="95%" border="0" align="center" cellpadding="2" cellspacing="2" class="label_normal">
    <tr>
      <td align="center"><?=$page_link?></td>
    </tr>
  </table>
  <? endif; ?>&nbsp;
  	<table width="95%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
		<tr><td colspan="9">&nbsp;</td></tr>
		<tr><td colspan="9"><iframe style="visibility:hidden" width="100%" height="100%" frameborder="0" scrolling="yes" id="PER_FILE_IFRAME" name="">รายละเอียดไฟล์ข้อมูลข้าราชการ/ลูกจ้างประจำ</iframe></td></tr>
	 </table>
  <? } // if  count show ?>
<input type="hidden" name="current_list" value="<?=$current_list?>">
        </form>	
		</td>
	</tr>
</table>
<?
	include("jqModalDialog.html");
?>
</body>
<? if (!$HIDE_HEADER) { ?>
<script language="JavaScript" src="java_scripts/menu_layer.js"></script>
<? } ?>
<script type="text/javascript">
setActiveStyleSheet(document.getElementById("defaultTheme"), "winter");
</script>
</html>
<?php
ob_end_flush();
?>