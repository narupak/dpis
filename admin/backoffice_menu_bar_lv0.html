<? 
	include("../php_scripts/connect_database.php");
	include("php_scripts/backoffice_menu_bar_lv0.php"); 
?>
<html>
<head>
<title><?=$webpage_title?> - <?=$MENU_TITLE_LV0?><?if($MENU_ID_LV1){?> - <?=$MENU_TITLE_LV1?><?}?><?if($MENU_ID_LV2){?> - <?=$MENU_TITLE_LV2?><?}?><?if($MENU_ID_LV3){?> - <?=$MENU_TITLE_LV3?><?}?></title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-874">
<link rel="stylesheet" href="<?=$cssfileselected?>" type="text/css">
</head>
<script type="text/javascript" src="java_scripts/function_utility.js"></script> 
<script language="JavaScript">
	function call_submenu (lv0_menu_id , lv0_menu_label_th) {
		form1.current_page.value = 0;
		form1.action =  "backoffice_menu_bar_lv1.html";
		form1.lv0_menu_id.value = lv0_menu_id;
		form1.lv0_menu_label_th.value = lv0_menu_label_th;
		form1.submit();
	}
	
	function change_current_page( page ){
		form1.current_page.value = page;
		form1.submit();
	}
	
	function confirm_delete(lv0_menu_id , lv0_menu_label_th){
		if(confirm("ต้องการลบข้อมูลนี้ใช่หรือไม่ [ " + lv0_menu_label_th + " ] ?")){
			form1.command.value = "DELETE";
			form1.lv0_menu_id.value = lv0_menu_id;
			form1.submit();
		} // end if
	}
</script>
<script language="JavaScript" src="java_scripts/menu_layer.js"></script>
<script type="text/javascript" language="JavaScript">
function check(f) {
	if(f.lv0_menu_order.value=="") {
		alert("กรุณาใส่ข้อมูลลำดับ");
		f.lv0_menu_order.focus();
		return false;
		} 
		else if(f.lv0_menu_label_th.value=="") {
		alert("กรุณาใส่ข้อมูลชื่อเมนู");
		f.lv0_menu_label_th.focus();
		return false;
		}
		else  
				return true;
		}

	function call_sort(flag) {
		form1.order_by.value=flag;		form1.sort_by.value=flag;
		if(form1.sort_type.value==flag+":asc"){
			form1.sort_type.value=flag+":desc";
		}else{ //desc
			form1.sort_type.value=flag+":asc";
		}		
		form1.command.value='SEARCH';
		form1.submit();
	} // end function call_sort
</script>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="label_normal">
	<tr>
    	<td height="10"><?include("header_menu.html")?></td>
  	</tr>
    <tr> 
	  <td align="left" valign="top">
<?	
		if ($UPD) $OPTIONAL_TITLE=" &gt; แก้ไขข้อมูล"; elseif ($VIEW) $OPTIONAL_TITLE=" &gt; ดูข้อมูล";
		include("current_location.html");
?>	  </td>
	</tr>
  	<tr>
	<? if ($UPD)  
	$Submit = "Submit_edit";
	else 
	$Submit = "Submit_add";
	?>
	
    	<td align="left" valign="top"><form name="form1" method="post" action="backoffice_menu_bar_lv0.html" enctype="multipart/form-data"  >
          <input type="hidden" name="current_page" value="<?=$current_page?>">
          <input type="hidden" name="total_page" value="<?=$total_page?>">
		  <input type="hidden" name="MENU_ID_LV0" value="<?=$MENU_ID_LV0?>">
		  <input type="hidden" name="MENU_ID_LV1" value="<?=$MENU_ID_LV1?>">
		  <input type="hidden" name="MENU_ID_LV2" value="<?=$MENU_ID_LV2?>">
		  <input type="hidden" name="MENU_ID_LV3" value="<?=$MENU_ID_LV3?>">
          <input type="hidden" name="command" value="">
          <input type="hidden" name="lv0_menu_id" value="<?=$lv0_menu_id?>">
          <br>
		  <table width="95%" align="center" cellpadding="0" cellspacing="0">
  	<tr>
	  <td><table width="15%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
		  <tr>
		  	<td height="22" align="center" class="table_body"><?=($UPD)?"แก้ไข":"เพิ่ม"?>ข้อมูล</td>
		  </tr>		
	  </table></td>
	</tr>
  </table>
          <table width="95%" align="center" cellpadding="0" cellspacing="0" class="input_table" >
    <tr>
      <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="label_normal">
        <tr>
          <td colspan="2" height="5"></td>
          </tr>
        <tr>
          <td width="28%" align="right"><?=$SEQ_NO_TITLE?>&nbsp;:&nbsp;</td>
          <td width="72%"><input type="text" name="lv0_menu_order" value="<?=$lv0_menu_order?>" style="width:5%" size="5" maxlength="5" class="textbox" onKeyPress="return DigitOnly();return keyEnter(event,document.form1.Submit2);" >          </td>
        </tr>
		<? if(in_array("TH", $ARR_LANGUAGE)){ ?>
        <tr>
          <td width="28%" align="right">ชื่อเมนู&nbsp;:&nbsp;</td>
          <td width="72%"><input type="text" name="lv0_menu_label_th" value="<?=$lv0_menu_label_th?>" style="width:70%" class="textbox" >          </td>
        </tr>
		<? } ?>
		<? if(in_array("EN", $ARR_LANGUAGE)){ ?>
        <tr>
          <td width="28%" align="right">ชื่อเมนู (EN)&nbsp;:&nbsp;</td>
          <td width="72%"><input type="text" name="lv0_menu_label_en" value="<?=$lv0_menu_label_en?>" style="width:70%" class="textbox" >          </td>
        </tr>
		<? } ?>
        <tr>
          <td width="28%" align="right">เชื่อมโยง&nbsp;:&nbsp;</td>
          <td width="72%"><input type="radio" name="type_linkto" value="N" <?=$type_linktoN?>>ไม่ระบุ</td>
        </tr>
        <tr>
          <td width="28%">&nbsp;</td>
          <td width="72%"><input type="radio" name="type_linkto" value="W" <?=$type_linktoW?>>
              <input type="text" name="linkto_web" value="<?=$linkto_web?>" size="35" style="width:67%" class="textbox" onClick="form1.type_linkto[1].checked = true">          </td>
        </tr>
            <tr>
              <td align="right"><?=$UPDATE_USER_TITLE?>&nbsp;:&nbsp;</td>
              <td><input name="SHOW_UPDATE_USER" type="text" style="width:70%" class="textbox" value="<?=$SHOW_UPDATE_USER?>" readonly></td>
        </tr>
            <tr>
              <td align="right"><?=$UPDATE_DATE_TITLE?>&nbsp;:&nbsp;</td>
              <td><input name="SHOW_UPDATE_DATE" type="text" class="textbox" value="<?=$SHOW_UPDATE_DATE?>" readonly></td>
            </tr>
        <tr align="center">
          <td height="30" colspan="2"><? if ($UPD) { ?>
      		  <?if($PAGE_AUTH["edit"]=="Y"){?> 
			  <? if ($BUTTON_DISPLAY==1) { ?>
      		  <input name="Submit_edit" type="submit" class="button" onClick="form1.command.value='UPDATE'; return check(form1); " value="<?=$EDIT_TITLE?>">  
			  <?  } else { ?>
              <input name="image2" type="image" onClick="form1.command.value='UPDATE'; return check(form1); " src="images/save.png" alt="<?=$EDIT_TITLE?>">
              <? } echo "&nbsp; &nbsp;";?>
      		  <?}?> 
		  <? if ($BUTTON_DISPLAY==1) { ?>
              <input type="submit" name="Reset2" value="<?=$CANCEL_TITLE?>" onClick="form1.command.value='CANCEL'" class="button" > <?  } else { ?>
              <input name="image22" type="image" onClick="form1.command.value='CANCEL'" src="images/cancel.gif" alt="<?=$CANCEL_TITLE?>">
              <? } echo "&nbsp; &nbsp;";?>
      		  <? } else { ?>
	  		  <?if($PAGE_AUTH["add"]=="Y"){?><? if ($BUTTON_DISPLAY==1) { ?>
	  		  <input name="Submit_add" type="submit" class="button" onClick="form1.command.value='ADD'; return check(form1);  " value="<?=$ADD_TITLE?>">
			    <?  } else { ?>
			  <input name="image2" type="image" onClick="form1.command.value='ADD'; return check(form1);  " src="images/save.png" alt="<?=$ADD_TITLE?>">
			  <? } echo "&nbsp; &nbsp;";?>
	  		  <?}?> 
			  <? if ($BUTTON_DISPLAY==1) { ?>
      		  <input name="Reset2" type="reset" class="button" value="<?=$CLEAR_TITLE?>"> 
			  <?  } else { ?>
			  <img src="images/default.jpg" alt="<?=$CLEAR_TITLE?>" width="30" height="30" border="0" onClick="form1.reset();">
			  <? } echo "&nbsp; &nbsp;";?>
              <?}?>          </td>
        </tr>
      </table></td>
    </tr>
  </table>
  <?
	if(!$sort_by) $sort_by=1;
	$sort_type = (isset($sort_type))?  $sort_type : "1:asc";
	$arrSort=explode(":",$sort_type);
	$SortType[$arrSort[0]]	=$arrSort[1];
	if(!$order_by) $order_by=1;
  	if(trim($search_menu_label)) $arr_search_condition[] = "(a.MENU_LABEL like '$search_menu_label%')";
  	if(trim($search_linkto_web)) $arr_search_condition[] = "(a.LINKTO_WEB like '%$search_linkto_web%')";
	$search_condition = "";
	if(count($arr_search_condition)) $search_condition = " and " . implode(" and ", $arr_search_condition);
	
	if($order_by==1){	//(ค่าเริ่มต้น) ลำดับที่
		$order_str = "a.menu_order ".$SortType[$order_by];
  	}elseif($order_by==2) {	//ชื่อ
		$order_str = "a.menu_label ".$SortType[$order_by];
  	} elseif($order_by==3) {	//html
		$order_str = "a.linkto_web ".$SortType[$order_by];
	}

	$cmd =" select count(menu_id) as count_data from backoffice_menu_bar_lv0 a where  fid=$CATE_FID and langcode='TH' $search_condition ";
	$db->send_cmd($cmd);
//	$db->show_error();
	$data = $db->get_array();
	$data = array_change_key_case($data, CASE_LOWER);
	$count_data = $data[count_data];	
  ?>
  <table width="95%" align="center" cellpadding="0" cellspacing="0">
  	<tr>
	  <td><table width="15%" cellpadding="0" cellspacing="0" class="input_table" style="border-bottom:none;">
		  <tr>
		  	<td height="22" align="center" class="table_body"><?=$SEARCH_TITLE?></td>
		  </tr>		
	  </table></td>
	</tr>
  </table>
  <table width="95%" align="center"  border="0" cellspacing="0" cellpadding="0" >
        <tr>
          <td align="center" class="input_table"><table width="100%"  border="0" cellpadding="0" cellspacing="0" class="label_normal" onKeyPress="return keyEnter(event,document.form1.Submit3);">
        <tr>
          <td colspan="4" height="5"></td>
          </tr>
            <tr>
              <td width="5%" align="right">ชื่อเมนู&nbsp;:&nbsp;</td>
              <td width="45%"><input type="text" name="search_menu_label" value="<?=$search_menu_label?>" style="width:98%" class="textbox" ></td>
              <td width="10%" align="right">เชื่อมโยง&nbsp;:&nbsp;</td>
              <td><input type="text" name="search_linkto_web" value="<?=$search_linkto_web?>" style="width:98%" class="textbox" ></td>
			  </tr>
			  <tr>
              <td width="100%" colspan="4" align="center">
		  	  <? if ($BUTTON_DISPLAY==1) { ?>
			  <input name="Submit3" type="submit" class="button" value="<?=$SEARCH_TITLE?>" onClick="form1.current_page.value=0;">
			  <input name="btn3" type="submit" class="button" value="<?=$SHOW_ALL_TITLE?>" onClick="form1.search_menu_label.value=''; form1.search_linkto_web.value=''; form1.current_page.value=0;">
    	  	  <? } else { ?>
			  <input type="image" src="images/search.png" alt="<?=$SEARCH_TITLE?>" onClick="javascript:form1.current_page.value=0;">
			  <input type="image" src="images/showall.png" alt="<?=$SHOW_ALL_TITLE?>" onClick="javascript:form1.search_code.value=''; form1.search_name.value=''; form1.current_page.value=0;">
      		  <?}?> 
			  </td>
            </tr>
        <tr>
          <td colspan="4" height="5"></td>
          </tr>
          </table></td>
        </tr>
	 <tr><td> <table width="95%" border="0" align="center" cellpadding="0" cellspacing="0">
<tr><td><input type="hidden" name="order_by" value="<?=$order_by?>">
    <input type="hidden" name="sort_by" value="<?=$sort_by;?>">
    <input type="hidden" name="sort_type" value="<?=$sort_type?>">
<?=$SORT_TITLE?></td>
</tr>
</table></td></tr>
		<tr>
		  <td>
</table>
  <table width="95%" align="center"  border="0" cellspacing="0" cellpadding="0">
		<tr>
		  <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="table_body_3">
            <tr>
              <td width="15%" height="22"><? if($PAGE_AUTH["print"]=="Y"){ ?><!--input name="btn_report" type="button" class="button" value="ดูรายงาน" onClick="call_pdf_report();"--><? }else{ echo "&nbsp;"; } ?></td>
              <td align="center">พบข้อมูล<?=($MENU_ID_LV3)?$MENU_TITLE_LV3:(($MENU_ID_LV2)?$MENU_TITLE_LV2:(($MENU_ID_LV1)?$MENU_TITLE_LV1:(($MENU_ID_LV0)?$MENU_TITLE_LV0:"")))?> ทั้งสิ้น <?=($count_data + 0)?> รายการ</td>
              <td width="15%" align="right"><? if($PAGE_AUTH["print"]=="Y"){ ?><!--input name="btn_export" type="button" class="button" value="ส่งออกไฟล์" onClick="call_export_file();"--><? }else{ echo "&nbsp;"; } ?></td>
            </tr>
          </table></td>
		</tr>
  </table>  
  <?
	$total_page = ceil( $count_data / $data_per_page );
	$page_link = create_link_page($total_page, $current_page);
	$limit_data = "";

	if($db_type=="mysql"){
		$limit_data = " limit " . (($current_page - 1) * $data_per_page) . ", " . $data_per_page;
	}
	if($current_page > 1){
		if($db_type=="odbc" || $db_type=="mssql"){
			$limit_data = " and a.menu_id not in (select top $start_record menu_id from backoffice_menu_bar_lv0 where fid = $CATE_FID and langcode = 'TH' $search_condition order by menu_order) ";
		}elseif($db_type=="oci8"){
			$limit_data = " and a.menu_id not in (select menu_id from (select menu_id from backoffice_menu_bar_lv0 where fid = $CATE_FID and langcode = 'TH' $search_condition order by menu_order) where rownum <= ". (($current_page - 1) * $data_per_page) .")";
		}
	} // end if 

	if($db_type=="odbc" || $db_type=="mssql"){
		$cmd = "	select		top $data_per_page 
											a.menu_id, a.menu_order, a.menu_icon, a.flag_show, a.type_linkto, a.linkto_web, a.menu_label as label_th , b.menu_label as label_en
							from		backoffice_menu_bar_lv0 a, backoffice_menu_bar_lv0 b
							where		a.fid = $CATE_FID and a.fid = b.fid and
											a.menu_id = b.menu_id and
											a.langcode = 'TH' and b.langcode = 'EN' $search_condition
											$limit_data
							order by $order_str ";	
	}elseif($db_type=="mysql"){
		$cmd = "	select		a.menu_id, a.menu_order, a.menu_icon, a.flag_show, a.type_linkto, a.linkto_web, a.menu_label as label_th , b.menu_label as label_en
							from		backoffice_menu_bar_lv0 a, backoffice_menu_bar_lv0 b
							where		a.fid = $CATE_FID and a.fid = b.fid and
											a.menu_id = b.menu_id and
											a.langcode = 'TH' and b.langcode = 'EN' $search_condition
							order by $order_str 
							$limit_data ";	
	}elseif($db_type=="oci8"){
		$cmd = "	select		*
							from (
								select		a.menu_id, a.menu_order, a.menu_icon, a.flag_show, a.type_linkto, a.linkto_web, a.menu_label as label_th , b.menu_label as label_en
								from		backoffice_menu_bar_lv0 a, backoffice_menu_bar_lv0 b
								where		a.fid = $CATE_FID and a.fid = b.fid and
												a.menu_id = b.menu_id and
												a.langcode = 'TH' and b.langcode = 'EN' $search_condition
												$limit_data
								order by $order_str 
							) where rownum <= $data_per_page ";	
	}
	if ($db->send_cmd($cmd)) {
//		$db->show_error();
		$db2 = new connect_db($db_host, $db_name, $db_user, $db_pwd);
		$current_list = "";
?>
  <table width="95%" border="0" align="center" cellpadding="1" cellspacing="1" class="label_normal">
    <tr align="center" class="table_head">
      <td width="7%" height="21" onClick="call_sort(1);"><strong><? if($order_by==1&&$sort_by==1){  if($SortType[$order_by]=="asc"){  echo $SORT_ASC;  }else{ echo $SORT_DESC; } }else{  echo $SORT_CUR;  } ?><?=$SEQ_NO_TITLE?></strong></td>
      <? if(in_array("TH", $ARR_LANGUAGE)){ ?>
      <td onClick="call_sort(2);"><? if($order_by==2&&$sort_by==2){  if($SortType[$order_by]=="asc"){  echo $SORT_ASC;  }else{ echo $SORT_DESC; } }else{  echo $SORT_CUR;  } ?>ชื่อเมนู</td>
      <? } ?>
      <? if(in_array("EN", $ARR_LANGUAGE)){ ?><td width="19%" nowrap="nowrap" onClick="call_sort(2);"><strong><? if($order_by==2&&$sort_by==2){  if($SortType[$order_by]=="asc"){  echo $SORT_ASC;  }else{ echo $SORT_DESC; } }else{  echo $SORT_CUR;  } ?>ชื่อเมนู (EN)</strong></td><? } ?>
      <td width="30%" nowrap="nowrap" onClick="call_sort(3);"><strong><? if($order_by==3&&$sort_by==3){  if($SortType[$order_by]=="asc"){  echo $SORT_ASC;  }else{ echo $SORT_DESC; } }else{  echo $SORT_CUR;  } ?>เชื่อมโยง</strong></td>
      <?if($BACKOFFICE_MENU_DEPTH>=2){?><td width="10%" nowrap="nowrap"><strong>เมนูย่อย</strong></td><?}?>
      <?if($PAGE_AUTH["edit"]=="Y"){?>
      <td width="5%"><?=$EDIT_TITLE?></td>
      <?}?>
      <?if($PAGE_AUTH["del"]=="Y"){?>
      <td width="5%"><?=$DEL_TITLE?></td>
      <?}?>
      <td width="5%"><strong>แสดง</strong></td>
    </tr>
    <?
	while ($data = $db->get_array()) {
		$data = array_change_key_case($data, CASE_LOWER);
		$menu_id = $data[menu_id];
		$current_list .= ((trim($current_list))?", ":"") . $menu_id;
		$lv0_menu_order = $data[menu_order];
		$lv0_menu_icon = trim($data[menu_icon]);
		$flag_show = trim($data[flag_show]);
		$type_linkto = trim($data[type_linkto]);
		$linkto_web = trim($data[linkto_web]);
		$lv0_menu_label_th = trim($data[label_th]);
		$lv0_menu_label_en = trim($data[label_en]);
		
		$class = "table_body";
		$onmouse_event = " onMouseOver=\"this.className='table_body_over';\" onMouseOut=\"this.className='table_body';\" ";
		if($lv0_menu_id==$menu_id){ 
			$class = "table_body_over";
			$onmouse_event = "";
		} // end if

		$count_submenu = 0;
		$cmd = " select count(menu_id) as count_submenu from backoffice_menu_bar_lv1 where  fid=$CATE_FID and langcode='TH' and parent_id_lv0=$menu_id ";
		$db2->send_cmd($cmd);
		$data2 = $db2->get_array();
		$data2 = array_change_key_case($data2, CASE_LOWER);
		$count_submenu += $data2[count_submenu];
?>
    <tr class="<?=$class?>" <?=$onmouse_event?>>
      <td align="center"><input name="arr_menu_order[<?=$menu_id?>]" type="text" size="5" maxlength="3" value="<?=$lv0_menu_order?>" style="text-align:right" onKeyPress="return NumOnly();"></td>
      <? if(in_array("TH", $ARR_LANGUAGE)){ ?><td>&nbsp;<?=$lv0_menu_label_th?></td><? } ?>
      <? if(in_array("EN", $ARR_LANGUAGE)){ ?><td>&nbsp;<?=$lv0_menu_label_en?></td><? } ?>
      <td>&nbsp;<?=($type_linkto=="W")?$linkto_web:""?></td>
      <?if($BACKOFFICE_MENU_DEPTH>=2){?>
	  <td align="center"><?if($type_linkto=="N"){?><a href="javascript:call_submenu (<?="$menu_id,'$lv0_menu_label_th'"?>)"><?=$count_submenu?></a><?}else{ echo "&nbsp;"; }?></td>
	  <?}?>
	  <?if($PAGE_AUTH["edit"]=="Y"){?>
      <td align="center">&nbsp;<a href="<?="javascript:form1.action+='?UPD=1';form1.lv0_menu_id.value=$menu_id;form1.submit()"?>""><img src="images/b_edit.png" border="0" alt="แก้ไขข้อมูล"></a></td>
	  <?}?>
	  <?if($PAGE_AUTH["del"]=="Y"){?>
      <td align="center">&nbsp;<?if($menu_id != 1) : ?>
          <a href="<?="javascript:confirm_delete($menu_id,'$lv0_menu_label_th')"?>"><img src="images/b_drop.png" border="0" alt="ลบข้อมูล"></a>
          <? endif; ?></td>
	  <?}?>
      <td align="center">
      	<?if($menu_id != 1) : ?>
      	<input type="checkbox" name="list_show_id[]" value="<?=$menu_id?>" <?=($flag_show=="S"?"checked":"")?>>
	<? elseif ($menu_id == 1) : ?>
	<input type="hidden" name="list_show_id[]" value="<?=$menu_id?>">
	<? endif; ?>      </td>
    </tr>
    <? } ?>
	<?if($PAGE_AUTH["edit"]=="Y"){?>
    <tr class="table_footer">
      <td align="center"><? if ($BUTTON_DISPLAY==1) { ?>
	  <input type="submit" name="btn2" value="<?=$REORDER_TITLE?>" onClick="form1.command.value='REORDER'" class="button" style="width:80%"><?  } else { ?>
	  <input name="image232" type="image" onClick="form1.command.value='REORDER'" src="images/reorder.gif" alt="<?=$REORDER_TITLE?>">
	  <? } ?>
	  </td>
      <? if(in_array("TH", $ARR_LANGUAGE)){ ?><td>&nbsp;</td><? } ?>
      <? if(in_array("EN", $ARR_LANGUAGE)){ ?><td>&nbsp;</td><? } ?>
      <td>&nbsp;</td>
      <?if($BACKOFFICE_MENU_DEPTH>=2){?><td>&nbsp;</td><?}?>
      <?if($PAGE_AUTH["edit"]=="Y"){?><td>&nbsp;</td><?}?>
      <?if($PAGE_AUTH["del"]=="Y"){?><td>&nbsp;</td><?}?>
      <td align="center"> <? if ($BUTTON_DISPLAY==1) { ?>
	  <input type="submit" name="btn3" value="<?=$SETFLAG_TITLE?>" onClick="form1.command.value='SETFLAG'" class="button" style="width:80%">  <?  } else { ?>
	  <input name="image23" type="image" onClick="form1.command.value='SETFLAG'" src="images/save.png" alt="<?=$SETFLAG_TITLE?>">
	  <? } echo "&nbsp; &nbsp;";?>    </td>
    </tr>
	<?}?>
  </table>
  <? if($total_page > 1) : ?>
  <table width="95%" border="0" align="center" cellpadding="2" cellspacing="2" class="label_normal">
    <tr>
      <td><?=$page_link?></td>
    </tr>
  </table>
  <? endif; ?>&nbsp;
  <? } // if  count show ?>
  			<input type="hidden" name="current_list" value="<?=$current_list?>">
        </form>		</td>
	</tr>
  	<tr>
  	  <td align="left" valign="top">&nbsp;</td>
  </tr>
</table>
</body>
</html>
